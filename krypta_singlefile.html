<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KRYPTA</title>

<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/png" href="bear.png">
<link rel="apple-touch-icon" href="bear.png">
<meta name="theme-color" content="#060710">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="KRYPTA">

<!-- Leaflet (GPS Route) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
:root{
  --bg:#060710; --card:rgba(15,18,30,.72); --stroke:rgba(255,255,255,.12);
  --text:#f5f7ff; --muted:rgba(245,247,255,.70);
  --a1:120,255,190; --a2:120,170,255; --a3:255,120,210;
  --shadow:0 20px 70px rgba(0,0,0,.55); --r:20px;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0; color:var(--text);
  font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(1200px 700px at 10% -10%, rgba(var(--a2), .22), transparent 55%),
    radial-gradient(900px 600px at 100% 0%, rgba(var(--a1), .18), transparent 55%),
    radial-gradient(900px 700px at 55% 120%, rgba(var(--a3), .10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.02), transparent 35%),
    var(--bg);
  overflow:hidden;
}
body::before{
  content:""; position:fixed; inset:0; pointer-events:none;
  background:url("krypta_logo.png") center/ min(720px, 90vw) no-repeat;
  opacity:.18; filter: drop-shadow(0 24px 80px rgba(0,0,0,.85));
}
.app{height:100vh; display:flex; flex-direction:column;}
.topbar{
  position:sticky; top:0; z-index:10;
  backdrop-filter: blur(14px);
  background: linear-gradient(to bottom, rgba(6,7,16,.92), rgba(6,7,16,.35));
  padding:14px 16px 10px; border-bottom:1px solid rgba(255,255,255,.06);
}
.brand{display:flex; align-items:center; justify-content:space-between; gap:12px;}
.brandLeft{display:flex; align-items:center; gap:12px; min-width:0}
h1{margin:0; letter-spacing:.14em; font-weight:1000; font-size:26px; text-transform:uppercase}
.chip{
  border:1px solid var(--stroke); background:rgba(255,255,255,.06);
  padding:8px 12px; border-radius:999px; font-size:13px; color:var(--muted);
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
  min-width:0;
}
.chip strong{color:rgba(245,247,255,.92)}
.cornerBtn{
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
  color:var(--text); padding:10px 12px; border-radius:999px; font-weight:950; cursor:pointer;
}
.cornerBtn:hover{filter:brightness(1.12)}
.topRight{display:flex; gap:10px; align-items:center}

.tabs{display:flex; gap:10px; padding-top:10px; flex-wrap:wrap}
.tab{
  border:1px solid var(--stroke); background:rgba(255,255,255,.06); color:var(--text);
  padding:10px 12px; border-radius:999px; cursor:pointer; user-select:none; font-weight:950; font-size:14px;
}
.tab.active{
  background: linear-gradient(135deg, rgba(var(--a1), .22), rgba(var(--a2), .18));
  border-color: rgba(var(--a1), .35); box-shadow: 0 12px 30px rgba(0,0,0,.35);
}

.pages{flex:1; min-height:0; padding:16px; padding-bottom: 108px;}
.page{display:none; height:100%; overflow:auto; padding-bottom:14px}
.page.active{display:block}

.card{
  background:var(--card); border:1px solid var(--stroke); border-radius:var(--r);
  box-shadow:var(--shadow); overflow:hidden; margin-bottom:14px; backdrop-filter: blur(14px);
}
.cardHeader{
  padding:14px 14px 10px; display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.cardHeader h2{margin:0; font-size:18px}
.cardBody{padding:14px}
.muted{color:var(--muted); font-size:13px; line-height:1.4}
.tag{
  font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06); color:var(--muted); white-space:nowrap;
}
.row{display:flex; gap:12px; flex-wrap:wrap}
.col{flex:1; min-width:180px}
label{display:block; margin:10px 0 6px; color:var(--muted); font-size:13px}
input,select,textarea{
  width:100%; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.10);
  background:rgba(10,11,16,.75); color:var(--text); outline:none;
}
textarea{min-height:90px; resize:vertical}
.btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
button{
  border:none; cursor:pointer; padding:12px 14px; border-radius:14px; font-weight:1000;
  letter-spacing:.02em; flex:1; min-width:180px;
}
.btn{background:linear-gradient(135deg, rgba(var(--a1),1), rgba(var(--a2),1)); color:#041017}
.btn2{background:rgba(255,255,255,.08); color:var(--text); border:1px solid rgba(255,255,255,.12)}
.btnDanger{background:rgba(255,92,92,.12); color:#ffd6d6; border:1px solid rgba(255,92,92,.25)}
.btn2:hover,.smallBtn:hover,.pill:hover{filter:brightness(1.12)}
.smallBtn{
  background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
  color:#fff; border-radius:999px; padding:8px 10px; cursor:pointer; font-weight:900;
}

.post{
  padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.10);
  background:rgba(10,11,16,.55); margin:12px 0; backdrop-filter: blur(10px);
}
.postTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
.userRow{display:flex; align-items:center; gap:10px}
.avatar{
  width:44px; height:44px; border-radius:14px; border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06); display:grid; place-items:center; font-weight:1000;
}

.listItem{
  display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
  padding:12px; border:1px solid rgba(255,255,255,.10); background:rgba(10,11,16,.55);
  border-radius:14px; margin:10px 0; cursor:pointer; backdrop-filter: blur(10px);
}
.listItem:hover{filter:brightness(1.06)}
.split{display:grid; grid-template-columns:1fr; gap:12px}
@media (min-width:920px){.split{grid-template-columns:1.10fr .90fr}}

.svgWrap{
  position:relative; overflow:hidden; border:1px solid rgba(255,255,255,.10); border-radius:var(--r);
  padding:12px; background:rgba(10,11,16,.86);
}
.svgGlow{
  position:absolute; inset:-40px;
  background:
    radial-gradient(560px 280px at 50% 18%, rgba(var(--a2), .18), transparent 60%),
    radial-gradient(560px 280px at 50% 86%, rgba(var(--a1), .14), transparent 60%);
  pointer-events:none;
}
svg{width:100%; height:auto; display:block; position:relative; z-index:1}
.bodyOutline{fill:rgba(255,255,255,.06); stroke:rgba(255,255,255,.14); stroke-width:2}
.part{fill:rgba(255,255,255,.03); stroke:rgba(255,255,255,.14); stroke-width:2; cursor:pointer; transition:.12s ease}
.part:hover{filter:brightness(1.18)}
.part.active{fill:rgba(255,70,70,.22); stroke:rgba(255,95,95,.55); filter: drop-shadow(0 10px 18px rgba(255,95,95,.16))}
.partLabel{font-size:12px; fill:rgba(244,246,255,.75); user-select:none; pointer-events:none}

.pillbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
.pill{
  border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
  padding:8px 10px; font-size:13px; font-weight:1000; cursor:pointer; display:flex; align-items:center; gap:8px;
}
.pill.active{background:rgba(var(--a1), .22); border-color:rgba(var(--a1), .35)}

.badgeGrid{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px}
@media (min-width:720px){.badgeGrid{grid-template-columns: repeat(3, minmax(0,1fr));}}
.badge{
  border:1px solid rgba(255,255,255,.12); background:rgba(10,11,16,.55); border-radius:16px;
  padding:12px; display:flex; gap:10px; align-items:center;
}
.badgeIcon{
  width:40px; height:40px; border-radius:14px; background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12); display:grid; place-items:center; font-size:18px;
}
.badgeTitle{font-weight:1000}
.badgeSub{font-size:12px; color:var(--muted); margin-top:2px}

.modalBack{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; z-index:60}
.modal{
  max-width:900px; margin:6vh auto; background:rgba(20,22,30,.96);
  border:1px solid rgba(255,255,255,.12); border-radius:18px; box-shadow:0 18px 60px rgba(0,0,0,.7);
  padding:14px;
}
.modalHeader{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px;}
.xbtn{
  background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
  color:#fff; border-radius:12px; padding:8px 10px; cursor:pointer; font-weight:900;
}
.likeBtn.active{background:rgba(255,70,70,.18); border-color:rgba(255,95,95,.35)}
.commentBox{display:flex; gap:10px; margin-top:10px}
.commentBox input{flex:1}
.commentItem{padding:10px; border:1px solid rgba(255,255,255,.10); background:rgba(10,11,16,.55); border-radius:14px; margin:10px 0}

.leaflet-container{background:#0b0b12}
.leaflet-control-attribution{display:none}
.leaflet-control-zoom{display:none}

/* Notifications */
.notifWrap{position:relative}
.notifBtn{
  width:42px;height:42px;border-radius:999px;
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
  color:var(--text); font-weight:1000; cursor:pointer;
  display:grid;place-items:center;
}
.notifBtn:hover{filter:brightness(1.12)}
.notifCount{
  position:absolute; top:-6px; right:-6px;
  min-width:18px;height:18px;border-radius:999px;
  background:#ff3b30; color:#fff; font-size:12px; line-height:18px;
  padding:0 6px; text-align:center;
  border:2px solid rgba(0,0,0,.55);
  display:none;
}
.notifPanel{
  position:absolute; right:0; top:50px;
  width:min(380px, calc(100vw - 24px));
  border-radius:16px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(20,22,30,.96);
  box-shadow:0 18px 60px rgba(0,0,0,.7);
  overflow:hidden;
  display:none;
  z-index:9999;
}
.notifHead{
  padding:12px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  border-bottom:1px solid rgba(255,255,255,.08);
}
.notifHead b{font-size:14px}
.notifActions{display:flex; gap:8px; flex-wrap:wrap}
.nChip{
  font-size:12px; padding:6px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
  color:rgba(245,247,255,.85); cursor:pointer;
}
.nChip:hover{filter:brightness(1.12)}
.notifTabs{
  display:flex; gap:8px; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.08);
}
.nTab{
  font-size:12px; padding:7px 10px; border-radius:999px;
  border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
  color:rgba(245,247,255,.72); cursor:pointer;
}
.nTab.active{
  background:rgba(255,255,255,.10);
  color:rgba(245,247,255,.94);
  border-color:rgba(var(--a1), .28);
}
.notifList{max-height:380px; overflow:auto}
.notifItem{
  display:flex; gap:10px; padding:12px;
  border-bottom:1px solid rgba(255,255,255,.06);
  cursor:pointer;
}
.notifItem:hover{background:rgba(255,255,255,.04)}
.notifItem.unread{border-left:3px solid rgba(var(--a2), .85)}
.notifIcon{
  width:34px; height:34px; border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  display:grid; place-items:center;
  flex:0 0 auto;
}
.notifBody{flex:1; min-width:0}
.notifT{font-weight:1000; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.notifS{font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
.notifMeta{font-size:11px; color:rgba(245,247,255,.45); margin-left:auto; flex:0 0 auto}
.notifEmpty{padding:18px; text-align:center; color:var(--muted); font-size:13px}

/* Bottom Nav (6 items) */
.bottomNav{
  position:fixed;
  left:10px; right:10px;
  bottom: max(10px, env(safe-area-inset-bottom));
  height:74px;
  display:flex;
  gap:8px;
  padding:10px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(12,12,18,.82);
  backdrop-filter: blur(14px);
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
  z-index:50;
}
.bNavItem{
  flex:1;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.04);
  color:rgba(245,247,255,.82);
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  padding:8px 6px;
  min-width:0;
}
.bNavItem:hover{filter:brightness(1.12)}
.bIcon{font-size:16px; line-height:1}
.bLbl{font-size:10.5px; font-weight:950; letter-spacing:.02em; opacity:.85}
.bNavItem.active{
  background: linear-gradient(135deg, rgba(var(--a1), .22), rgba(var(--a2), .18));
  border-color: rgba(var(--a1), .35);
  color: rgba(245,247,255,.96);
}
.bPrimary{
  transform: translateY(-8px);
  background: linear-gradient(135deg, rgba(var(--a1), 1), rgba(var(--a2), 1));
  color:#041017;
  border-color: rgba(255,255,255,.18);
}
.bPrimary .bLbl{color:#041017; opacity:1}
.bPrimary .bIcon{font-weight:1000}

@media (max-width: 560px){ .tabs{ display:none; } }
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-thumb{background:#222;border-radius:6px}

/* ===== Exercise animation drawing ===== */
.exStage{
  border:1px solid rgba(255,255,255,.10);
  background:rgba(10,11,16,.55);
  border-radius:16px;
  padding:12px;
  overflow:hidden;
}
.exToolbar{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px;
}
.exPill{
  border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.06);
  padding:7px 10px; font-size:12px; font-weight:950; cursor:pointer;
}
.exPill.active{background:rgba(var(--a1), .22); border-color:rgba(var(--a1), .35)}
.exSmall{font-size:12px; color:var(--muted)}
.exSvg{width:100%; max-width:860px; display:block; margin:0 auto;}

/* smooth, realistic-ish motion */
:root{ --repDur: 1800ms; --repEase: cubic-bezier(.55,.0,.25,1); }

@keyframes squatTorso { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(10deg)} }
@keyframes squatHip   { 0%,100%{transform:translate(0,0)} 50%{transform:translate(0,34px)} }
@keyframes squatKneeL { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(42deg)} }
@keyframes squatKneeR { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(-42deg)} }
@keyframes squatAnkL  { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(-16deg)} }
@keyframes squatAnkR  { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(16deg)} }
@keyframes squatBar   { 0%,100%{transform:translate(0,0)} 50%{transform:translate(0,34px)} }

@keyframes benchBar   { 0%,100%{transform:translate(0,0)} 50%{transform:translate(0,44px)} }
@keyframes benchForeL { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(38deg)} }
@keyframes benchForeR { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(-38deg)} }
@keyframes benchUpperL{ 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(-16deg)} }
@keyframes benchUpperR{ 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(16deg)} }

@keyframes curlForeL  { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(-78deg)} }
@keyframes curlForeR  { 0%,100%{transform:rotate(0deg)} 50%{transform:rotate(78deg)} }
@keyframes curlDbL    { 0%,100%{transform:translate(0,0)} 50%{transform:translate(0,-36px)} }
@keyframes curlDbR    { 0%,100%{transform:translate(0,0)} 50%{transform:translate(0,-36px)} }

@keyframes kbSwingTorso { 0%,100%{transform:rotate(6deg)} 50%{transform:rotate(-16deg)} }
@keyframes kbSwingKB    { 0%,100%{transform:translate(0,0)} 50%{transform:translate(0,-120px)} }
@keyframes kbSwingArms  { 0%,100%{transform:rotate(8deg)} 50%{transform:rotate(-58deg)} }

.exPlay .rep { animation-duration: var(--repDur); animation-timing-function: var(--repEase); animation-iteration-count: infinite; }
.exPlay .squatTorso{ animation-name:squatTorso }
.exPlay .squatHip{ animation-name:squatHip }
.exPlay .squatKneeL{ animation-name:squatKneeL }
.exPlay .squatKneeR{ animation-name:squatKneeR }
.exPlay .squatAnkL{ animation-name:squatAnkL }
.exPlay .squatAnkR{ animation-name:squatAnkR }
.exPlay .squatBar{ animation-name:squatBar }

.exPlay .benchBar{ animation-name:benchBar }
.exPlay .benchForeL{ animation-name:benchForeL }
.exPlay .benchForeR{ animation-name:benchForeR }
.exPlay .benchUpperL{ animation-name:benchUpperL }
.exPlay .benchUpperR{ animation-name:benchUpperR }

.exPlay .curlForeL{ animation-name:curlForeL }
.exPlay .curlForeR{ animation-name:curlForeR }
.exPlay .curlDbL{ animation-name:curlDbL }
.exPlay .curlDbR{ animation-name:curlDbR }

.exPlay .kbSwingTorso{ animation-name:kbSwingTorso }
.exPlay .kbSwingKB{ animation-name:kbSwingKB }
.exPlay .kbSwingArms{ animation-name:kbSwingArms }
</style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="brandLeft">
        <div style="display:flex; align-items:center; gap:10px">
          <img src="bear.png" alt="Krypta" style="width:32px;height:32px">
          <h1>KRYPTA</h1>
        </div>
        <div class="chip" id="chipStatus">
          <span>Local demo</span>
          <span style="opacity:.5">‚Ä¢</span>
          <span>Streak</span>
          <strong id="streakChip">0</strong>
          <span style="opacity:.5">‚Ä¢</span>
          <span>Style</span>
          <strong id="dnaChip">‚Äî</strong>
        </div>
      </div>

      <div class="topRight" id="topRightActions">
        <button class="cornerBtn" onclick="go('profile')">Profile</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabHome" onclick="go('home')">Home</div>
      <div class="tab" id="tabPlan" onclick="go('plan')">Plan</div>
      <div class="tab" id="tabCreate" onclick="go('create')">Create</div>
      <div class="tab" id="tabRecipes" onclick="go('recipes')">Recipes</div>
      <div class="tab" id="tabHistory" onclick="go('history')">History</div>
      <div class="tab" id="tabProfile" onclick="go('profile')">Profile</div>
    </div>
  </div>

  <div class="pages">
    <!-- HOME -->
    <div class="page active" id="pageHome">
      <div class="card">
        <div class="cardHeader">
          <div>
            <h2>Feed</h2>
            <div class="muted" id="homeSummary"></div>
            <div class="muted" id="coachNoteHome" style="margin-top:6px"></div>
          </div>
          <div class="tag">Local</div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="col">
              <div class="card" style="margin:0">
                <div class="cardBody">
                  <b>Weekly Recap</b>
                  <div class="muted" id="weeklyRecap" style="margin-top:8px"></div>
                </div>
              </div>
            </div>
            <div class="col">
              <div class="card" style="margin:0">
                <div class="cardBody">
                  <b>Recovery</b>
                  <div class="muted" id="recoveryScore" style="margin-top:8px"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="btnRow" style="margin-top:12px">
            <button class="btn" onclick="go('create')">Post Today</button>
            <button class="btn2" onclick="go('plan')">Weekly Plan</button>
            <button class="btn2" onclick="go('recipes')">Healthy Recipes</button>
          </div>

          <div class="muted" style="margin-top:10px">
            Calm culture. Completed workouts only. No leaderboards.
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div><h2>Recent Posts</h2><div class="muted">Your local feed (likes + comments).</div></div>
          <div class="tag">Social</div>
        </div>
        <div class="cardBody" id="feedList"></div>
      </div>
    </div>

    <!-- PLAN -->
    <div class="page" id="pagePlan">
      <div class="card" id="planWeekCard">
        <div class="cardHeader">
          <div><h2>Weekly Plan</h2><div class="muted">Tap a day to open. Warm-up is shown first.</div></div>
          <div class="tag">Private</div>
        </div>
        <div class="cardBody" id="planList"></div>
      </div>

      <div class="card" id="planDayCard" style="display:none">
        <div class="cardHeader">
          <div><h2 id="planDayTitle">Monday</h2><div class="muted" id="planDaySub"></div></div>
          <div class="tag" id="planDayTag">Day</div>
        </div>
        <div class="cardBody" id="planDayBody"></div>
        <div class="cardBody" style="padding-top:0">
          <div class="btnRow"><button class="btn2" onclick="closePlanDay()">Back</button></div>
        </div>
      </div>
    </div>

    <!-- CREATE -->
    <div class="page" id="pageCreate">
      <div class="card">
        <div class="cardHeader">
          <div><h2>Create</h2><div class="muted">Gym + Cardio + CrossFit WOD. Post only completed workouts.</div></div>
          <div class="tag" id="createModeTag">Gym</div>
        </div>
        <div class="cardBody">
          <div class="btnRow">
            <button class="btn2" id="btnModeGym" onclick="setCreateMode('gym')">Gym</button>
            <button class="btn2" id="btnModeCardio" onclick="setCreateMode('cardio')">Run / Walk / Hike</button>
            <button class="btn2" id="btnModeCF" onclick="setCreateMode('crossfit')">CrossFit (WOD)</button>
          </div>
        </div>
      </div>

      <!-- GYM -->
      <div class="card" id="gymCard">
        <div class="cardHeader">
          <div><h2>Pick Muscles</h2><div class="muted">Front and back are separated.</div></div>
          <div class="tag" id="viewTag">Front</div>
        </div>
        <div class="cardBody">
          <div class="btnRow">
            <button class="btn2" onclick="setView('front')">Front</button>
            <button class="btn2" onclick="setView('back')">Back</button>
            <button class="btn2" onclick="clearSelection()">Clear (this view)</button>
          </div>

          <div class="split">
            <div class="svgWrap">
              <div class="svgGlow"></div>

              <!-- FRONT -->
              <svg id="svgFront" viewBox="0 0 320 560" aria-label="front">
                <path class="bodyOutline" d="M160 28 C140 28 126 44 126 64 C126 88 142 106 160 106 C178 106 194 88 194 64 C194 44 180 28 160 28 Z"/>
                <path class="bodyOutline" d="M142 108 C148 118 172 118 178 108 C186 118 198 126 214 132 C226 136 236 150 238 166 C240 190 230 206 220 214 C212 220 206 226 204 240 C198 284 200 314 206 344 C214 382 214 406 206 430 C196 468 186 508 176 540 C168 560 152 560 144 540 C134 508 124 468 114 430 C106 406 106 382 114 344 C120 314 122 284 116 240 C114 226 108 220 100 214 C90 206 80 190 82 166 C84 150 94 136 106 132 C122 126 134 118 142 108 Z"/>
                <path class="bodyOutline" d="M96 170 C82 200 82 240 92 288 C98 316 110 340 124 342 C132 343 136 334 134 320 C128 284 128 230 140 194 C130 182 114 172 96 170 Z"/>
                <path class="bodyOutline" d="M224 170 C238 200 238 240 228 288 C222 316 210 340 196 342 C188 343 184 334 186 320 C192 284 192 230 180 194 C190 182 206 172 224 170 Z"/>

                <path id="f_shoulders" class="part"
                  d="M112 134 C124 122 142 120 152 130 C142 146 138 160 136 176
                     C124 182 108 172 106 158 C105 148 108 140 112 134 Z
                     M208 134 C196 122 178 120 168 130 C178 146 182 160 184 176
                     C196 182 212 172 214 158 C215 148 212 140 208 134 Z"/>
                <text x="160" y="150" text-anchor="middle" class="partLabel">Shoulders</text>

                <path id="f_chest" class="part"
                  d="M128 176 C142 156 178 156 192 176
                     C202 192 196 220 176 230
                     C168 234 152 234 144 230
                     C124 220 118 192 128 176 Z"/>
                <text x="160" y="205" text-anchor="middle" class="partLabel">Chest</text>

                <path id="f_core" class="part"
                  d="M140 232 C150 226 170 226 180 232
                     C194 264 194 316 180 350
                     C172 366 148 366 140 350
                     C126 316 126 264 140 232 Z"/>
                <text x="160" y="300" text-anchor="middle" class="partLabel">Core</text>

                <path id="f_biceps" class="part"
                  d="M98 214 C90 236 92 274 104 300
                     C114 322 128 320 130 300
                     C132 274 130 240 138 214
                     C124 204 110 204 98 214 Z
                     M222 214 C230 236 228 274 216 300
                     C206 322 192 320 190 300
                     C188 274 190 240 182 214
                     C196 204 210 204 222 214 Z"/>
                <text x="160" y="258" text-anchor="middle" class="partLabel">Biceps</text>

                <path id="f_triceps" class="part"
                  d="M92 292 C88 314 96 344 112 360
                     C128 374 138 364 134 344
                     C128 316 116 304 112 288
                     C104 286 98 286 92 292 Z
                     M228 292 C232 314 224 344 208 360
                     C192 374 182 364 186 344
                     C192 316 204 304 208 288
                     C216 286 222 286 228 292 Z"/>
                <text x="160" y="350" text-anchor="middle" class="partLabel">Triceps</text>

                <path id="f_quads" class="part"
                  d="M126 372 C146 354 174 354 194 372
                     C210 408 210 454 196 488
                     C176 510 144 510 124 488
                     C110 454 110 408 126 372 Z"/>
                <text x="160" y="435" text-anchor="middle" class="partLabel">Quads</text>

                <path id="f_calves" class="part"
                  d="M136 498 C144 492 154 492 158 500
                     C162 516 162 536 156 546
                     C148 556 140 552 138 540
                     C136 526 134 512 136 498 Z
                     M184 498 C176 492 166 492 162 500
                     C158 516 158 536 164 546
                     C172 556 180 552 182 540
                     C184 526 186 512 184 498 Z"/>
                <text x="160" y="540" text-anchor="middle" class="partLabel">Calves</text>
              </svg>

              <!-- BACK -->
              <svg id="svgBack" style="display:none" viewBox="0 0 320 560" aria-label="back">
                <path class="bodyOutline" d="M160 28 C140 28 126 44 126 64 C126 88 142 106 160 106 C178 106 194 88 194 64 C194 44 180 28 160 28 Z"/>
                <path class="bodyOutline" d="M142 108 C148 118 172 118 178 108 C186 118 198 126 214 132 C226 136 236 150 238 166 C240 190 230 206 220 214 C212 220 206 226 204 240 C198 284 200 314 206 344 C214 382 214 406 206 430 C196 468 186 508 176 540 C168 560 152 560 144 540 C134 508 124 468 114 430 C106 406 106 382 114 344 C120 314 122 284 116 240 C114 226 108 220 100 214 C90 206 80 190 82 166 C84 150 94 136 106 132 C122 126 134 118 142 108 Z"/>
                <path class="bodyOutline" d="M96 170 C82 200 82 240 92 288 C98 316 110 340 124 342 C132 343 136 334 134 320 C128 284 128 230 140 194 C130 182 114 172 96 170 Z"/>
                <path class="bodyOutline" d="M224 170 C238 200 238 240 228 288 C222 316 210 340 196 342 C188 343 184 334 186 320 C192 284 192 230 180 194 C190 182 206 172 224 170 Z"/>

                <path id="b_traps" class="part"
                  d="M132 132 C146 120 174 120 188 132
                     C196 144 190 164 176 170
                     C168 174 152 174 144 170
                     C130 164 124 144 132 132 Z"/>
                <text x="160" y="154" text-anchor="middle" class="partLabel">Traps</text>

                <path id="b_back" class="part"
                  d="M132 176 C146 158 174 158 188 176
                     C206 214 206 290 188 330
                     C178 352 142 352 132 330
                     C114 290 114 214 132 176 Z"/>
                <text x="160" y="265" text-anchor="middle" class="partLabel">Back</text>

                <path id="b_triceps" class="part"
                  d="M92 280 C88 304 98 334 114 350
                     C130 364 138 354 134 334
                     C128 306 114 298 112 280
                     C104 276 98 276 92 280 Z
                     M228 280 C232 304 222 334 206 350
                     C190 364 182 354 186 334
                     C192 306 206 298 208 280
                     C216 276 222 276 228 280 Z"/>
                <text x="160" y="340" text-anchor="middle" class="partLabel">Triceps</text>

                <path id="b_glutes" class="part"
                  d="M128 344 C146 330 174 330 192 344
                     C210 364 210 402 192 420
                     C174 438 146 438 128 420
                     C110 402 110 364 128 344 Z"/>
                <text x="160" y="392" text-anchor="middle" class="partLabel">Glutes</text>

                <path id="b_hams" class="part"
                  d="M128 420 C146 404 174 404 192 420
                     C210 446 210 476 196 494
                     C176 510 144 510 124 494
                     C110 476 110 446 128 420 Z"/>
                <text x="160" y="468" text-anchor="middle" class="partLabel">Hamstrings</text>

                <path id="b_calves" class="part"
                  d="M136 498 C144 492 154 492 158 500
                     C162 516 162 536 156 546
                     C148 556 140 552 138 540
                     C136 526 134 512 136 498 Z
                     M184 498 C176 492 166 492 162 500
                     C158 516 158 536 164 546
                     C172 556 180 552 182 540
                     C184 526 186 512 184 498 Z"/>
                <text x="160" y="540" text-anchor="middle" class="partLabel">Calves</text>
              </svg>
            </div>

            <div class="card" style="margin:0">
              <div class="cardHeader">
                <div><h2>Selected (this view)</h2><div class="muted" id="viewHint">Front muscles only.</div></div>
                <div class="tag" id="selCount">0</div>
              </div>
              <div class="cardBody">
                <div class="pillbar" id="selectedPills"></div>

                <label>Today goal</label>
                <select id="todayGoal">
                  <option value="">Use profile goal</option>
                  <option value="cut">Get cut</option>
                  <option value="sixpack">Six-pack</option>
                  <option value="muscle">Build muscle</option>
                  <option value="strong">Get stronger</option>
                </select>

                <label>Custom goal (optional)</label>
                <input id="customGoal" placeholder="e.g. bigger arms, better conditioning..." />

                <label>Pain today (optional)</label>
                <input id="todayPain" placeholder="e.g. knee pain, sore shoulder..." />

                <div class="btnRow">
                  <button class="btn" onclick="generateGymAndShowPost()">Generate Gym Workout</button>
                  <button class="btn2" onclick="clearSelection()">Clear (this view)</button>
                </div>

                <div class="muted" style="margin-top:8px">
                  Warm-up always shows first. Tap exercises for a clear demo with moving bar/dumbbells.
                </div>
              </div>
            </div>
          </div>

          <div class="card" id="postCard" style="display:none; margin-top:14px;">
            <div class="cardHeader">
              <div><h2 id="postTitle">Workout</h2><div class="muted" id="postMeta"></div></div>
              <div class="tag">Ready</div>
            </div>
            <div class="cardBody">
              <div id="postBody"></div>

              <label>After-workout (private)</label>
              <div class="row">
                <div class="col">
                  <label style="margin-top:0">Effort (1‚Äì10)</label>
                  <select id="reflectEffort">
                    <option value="">‚Äî</option>
                    <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
                    <option>6</option><option>7</option><option>8</option><option>9</option><option>10</option>
                  </select>
                </div>
                <div class="col">
                  <label style="margin-top:0">Energy now</label>
                  <select id="reflectEnergy">
                    <option value="">‚Äî</option>
                    <option value="low">Low</option>
                    <option value="ok">OK</option>
                    <option value="high">High</option>
                  </select>
                </div>
                <div class="col">
                  <label style="margin-top:0">Enjoyment</label>
                  <select id="reflectEnjoy">
                    <option value="">‚Äî</option>
                    <option value="meh">Meh</option>
                    <option value="good">Good</option>
                    <option value="great">Great</option>
                  </select>
                </div>
              </div>

              <label>Caption (public optional)</label>
              <textarea id="postCaption" placeholder="How was it?"></textarea>

              <div class="btnRow">
                <button class="btn" onclick="postLastToFeed()">Post to Feed</button>
                <button class="btn2" onclick="hidePostCard()">Close</button>
              </div>

              <div class="muted" style="margin-top:8px">
                Coach notes are private. Achievements are private.
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- CARDIO -->
      <div class="card" id="cardioCard" style="display:none">
        <div class="cardHeader">
          <div><h2>Track Cardio</h2><div class="muted">GPS route + distance, time, pace. Keep the app open.</div></div>
          <div class="tag">GPS</div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="col"><label>Type</label>
              <select id="cardioType"><option>Run</option><option selected>Walk</option><option>Hike</option></select>
            </div>
            <div class="col"><label>Caption (public optional)</label><input id="cardioCaption" placeholder="e.g., windy but good"/></div>
          </div>

          <div class="card" style="margin:12px 0 0 0">
            <div class="cardBody">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:10px">
                <b>GPS Route</b>
                <span class="tag" id="gpsStatus">Off</span>
              </div>

              <div class="btnRow" style="margin-top:10px">
                <button class="btn2" id="gpsStartBtn" onclick="gpsStart()">Start</button>
                <button class="btnDanger" id="gpsStopBtn" onclick="gpsStop(true)" disabled>Finish</button>
                <button class="btn2" id="gpsPauseBtn" onclick="gpsTogglePause()" disabled>Pause</button>
              </div>

              <div class="muted" style="margin-top:8px" id="gpsStats">Distance: 0.00 km ‚Ä¢ Time: 0:00 ‚Ä¢ Pace: ‚Äî</div>

              <div id="gpsMap" style="margin-top:12px; height:250px; border-radius:16px; border:1px solid rgba(255,255,255,.10); overflow:hidden"></div>

              <div class="muted" style="margin-top:8px">
                iPhone Safari needs HTTPS (or localhost) for GPS.
              </div>
            </div>
          </div>

          <div class="btnRow" style="margin-top:12px">
            <button class="btn2" onclick="gpsStop(false); clearCardio()">Reset</button>
          </div>
        </div>
      </div>

      <!-- CROSSFIT -->
      <div class="card" id="crossfitCard" style="display:none">
        <div class="cardHeader">
          <div>
            <h2>CrossFit WOD Generator</h2>
            <div class="muted">Warm-up ‚Üí Strength/Skill ‚Üí Metcon ‚Üí RX/Scaled ‚Üí Cool-down</div>
          </div>
          <div class="tag">WOD</div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="col"><label>Focus</label>
              <select id="cfFocus">
                <option value="engine">Conditioning / engine</option>
                <option value="strength">Strength focus</option>
                <option value="mixed" selected>Mixed</option>
                <option value="fatloss">Fat loss</option>
              </select>
            </div>
            <div class="col"><label>Time available</label>
              <select id="cfTime">
                <option value="20">~20 min</option>
                <option value="30" selected>~30 min</option>
                <option value="45">~45 min</option>
                <option value="60">~60 min</option>
              </select>
            </div>
            <div class="col"><label>Equipment</label>
              <select id="cfEquip">
                <option value="full" selected>Box / Full gym</option>
                <option value="basic">Basic (DB + pullup bar)</option>
                <option value="none">No equipment</option>
              </select>
            </div>
          </div>
          <label>Pain today (optional)</label>
          <input id="cfPain" placeholder="e.g. shoulder pain, knee pain, lower back..." />

          <div class="btnRow">
            <button class="btn" onclick="generateCrossFitAndShowPost()">Generate WOD</button>
            <button class="btn2" onclick="clearCrossFit()">Clear</button>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="cardHeader">
              <div><h2>Preview</h2><div class="muted">Generates here + also appears in the Post card.</div></div>
              <div class="tag" id="cfPreviewTag">‚Äî</div>
            </div>
            <div class="cardBody" id="cfPreview">
              <div class="muted">Generate a WOD to preview it.</div>
            </div>
          </div>

          <div class="muted" style="margin-top:8px">
            You can post the WOD after completion (local demo assumes completion when posted).
          </div>
        </div>
      </div>
    </div>

    <!-- RECIPES -->
    <div class="page" id="pageRecipes">
      <div class="card">
        <div class="cardHeader">
          <div><h2>Healthy Recipes</h2><div class="muted">Share simple meals. Like + comment. Saved locally.</div></div>
          <div class="tag">Community</div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="col">
              <label>Recipe name</label>
              <input id="rName" placeholder="e.g., High-protein chicken bowl"/>
            </div>
            <div class="col">
              <label>Type</label>
              <select id="rType">
                <option>Breakfast</option><option>Lunch</option><option selected>Dinner</option><option>Snack</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>Calories (optional)</label>
              <input id="rCals" type="number" inputmode="numeric" placeholder="e.g., 650"/>
            </div>
            <div class="col">
              <label>Protein g (optional)</label>
              <input id="rProtein" type="number" inputmode="numeric" placeholder="e.g., 45"/>
            </div>
          </div>
          <label>Ingredients (one per line)</label>
          <textarea id="rIngr" placeholder="Chicken breast&#10;Rice&#10;Greek yogurt sauce..."></textarea>
          <label>Steps</label>
          <textarea id="rSteps" placeholder="1) Cook rice...&#10;2) Season chicken..."></textarea>
          <label>Notes (optional)</label>
          <input id="rNotes" placeholder="Tips, swaps, allergies..."/>
          <div class="btnRow">
            <button class="btn" onclick="postRecipe()">Post Recipe</button>
            <button class="btn2" onclick="clearRecipeForm()">Clear</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="cardHeader">
          <div><h2>Recent Recipes</h2><div class="muted">Tap comments to expand.</div></div>
          <div class="tag">Local</div>
        </div>
        <div class="cardBody" id="recipeList"></div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="page" id="pageHistory">
      <div class="card">
        <div class="cardHeader">
          <div><h2>History</h2><div class="muted">Saved locally on this device.</div></div>
          <div class="tag">Offline</div>
        </div>
        <div class="cardBody">
          <div id="historyList"></div>
          <div class="btnRow"><button class="btnDanger" onclick="clearHistory()">Clear All</button></div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="page" id="pageProfile">
      <div class="card">
        <div class="cardHeader">
          <div><h2>Profile</h2><div class="muted">Badges & coach notes are private.</div></div>
          <div class="tag">Local</div>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="col"><label>Display name</label><input id="displayName"/></div>
            <div class="col"><label>Gender</label>
              <select id="gender">
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col"><label>Height (cm)</label><input id="heightCm" type="number" inputmode="decimal"/></div>
            <div class="col"><label>Weight (kg)</label><input id="weightKg" type="number" inputmode="decimal"/></div>
            <div class="col"><label>Age</label><input id="age" type="number" inputmode="numeric"/></div>
          </div>

          <div class="row">
            <div class="col"><label>Activity</label>
              <select id="activity">
                <option value="sedentary">Sedentary</option>
                <option value="light">Light</option>
                <option value="moderate">Moderate</option>
                <option value="very">Very active</option>
              </select>
            </div>
            <div class="col"><label>Goal</label>
              <select id="goal">
                <option value="cut">Get cut</option>
                <option value="sixpack">Six-pack</option>
                <option value="muscle">Build muscle</option>
                <option value="strong">Get stronger</option>
              </select>
            </div>
            <div class="col"><label>Days/week</label>
              <select id="days"><option>3</option><option>4</option><option>5</option><option>6</option></select>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="cardHeader">
              <div><h2>Streak</h2><div class="muted">Counts days you posted a completed workout.</div></div>
              <div class="tag">üî•</div>
            </div>
            <div class="cardBody">
              <div class="row">
                <div class="col"><div class="muted">Current</div><div style="font-weight:1000; font-size:22px" id="streakCurrent">0</div></div>
                <div class="col"><div class="muted">Best</div><div style="font-weight:1000; font-size:22px" id="streakBest">0</div></div>
                <div class="col"><div class="muted">Last workout</div><div style="font-weight:1000; font-size:16px" id="streakLast">‚Äî</div></div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="cardHeader">
              <div><h2>Workout DNA</h2><div class="muted">Your style evolves from what you do.</div></div>
              <div class="tag">üß¨</div>
            </div>
            <div class="cardBody">
              <div style="font-weight:1000; font-size:18px" id="dnaStyle">‚Äî</div>
              <div class="muted" id="dnaExplain" style="margin-top:6px"></div>
            </div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="cardHeader"><div><h2>Badges</h2><div class="muted">Unlocked automatically. Private.</div></div></div>
            <div class="cardBody"><div class="badgeGrid" id="badgeGrid"></div></div>
          </div>

          <div class="card" style="margin-top:14px">
            <div class="cardHeader"><div><h2>Injuries</h2><div class="muted">Add/remove anytime. Workouts adapt.</div></div></div>
            <div class="cardBody">
              <label>Add new injury (text)</label>
              <input id="newInjuryInput" placeholder="e.g. knee pain, shoulder impingement..."/>
              <div class="btnRow">
                <button class="btn2" onclick="addInjury()">Add injury</button>
                <button class="btnDanger" onclick="clearInjuries()">Clear injuries</button>
              </div>
              <div class="muted" style="margin-top:8px">Current injuries:</div>
              <div id="injuryList" class="pillbar"></div>
            </div>
          </div>

          <div class="btnRow">
            <button class="btn" onclick="saveProfile()">Save</button>
            <button class="btnDanger" onclick="resetAll()">Reset Local</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottomNav" id="bottomNav">
    <button class="bNavItem active" id="bHome" onclick="go('home')" aria-label="Home">
      <span class="bIcon">üè†</span><span class="bLbl">Home</span>
    </button>
    <button class="bNavItem" id="bPlan" onclick="go('plan')" aria-label="Plan">
      <span class="bIcon">üìÖ</span><span class="bLbl">Plan</span>
    </button>
    <button class="bNavItem bPrimary" id="bCreate" onclick="go('create')" aria-label="Create">
      <span class="bIcon">Ôºã</span><span class="bLbl">Create</span>
    </button>
    <button class="bNavItem" id="bRecipes" onclick="go('recipes')" aria-label="Recipes">
      <span class="bIcon">ü•ó</span><span class="bLbl">Recipes</span>
    </button>
    <button class="bNavItem" id="bHistory" onclick="go('history')" aria-label="History">
      <span class="bIcon">üïò</span><span class="bLbl">History</span>
    </button>
    <button class="bNavItem" id="bProfile" onclick="go('profile')" aria-label="Profile">
      <span class="bIcon">üë§</span><span class="bLbl">Profile</span>
    </button>
  </nav>
</div>

<!-- EXERCISE MODAL -->
<div class="modalBack" id="exerciseModal">
  <div class="modal">
    <div class="modalHeader">
      <div>
        <b id="exTitle">Exercise</b>
        <div class="muted" id="exMuscles">Muscles</div>
      </div>
      <button class="xbtn" onclick="closeExercise()">X</button>
    </div>

    <div class="exStage">
      <div id="exPic"></div>

      <div class="exToolbar">
        <button class="exPill active" id="exPlayBtn" onclick="toggleExPlay()">‚ñ∂ Play</button>
        <button class="exPill" onclick="setExSpeed(1400)">Fast</button>
        <button class="exPill active" id="exSpeedMid" onclick="setExSpeed(1800)">Normal</button>
        <button class="exPill" onclick="setExSpeed(2400)">Slow</button>
        <span class="exSmall" id="exCue">Cue: ‚Äî</span>
      </div>
    </div>

    <div style="margin-top:12px">
      <b>How to do it</b>
      <div class="muted" id="exHow" style="margin-top:6px"></div>
    </div>

    <div style="margin-top:12px">
      <b>Tips</b>
      <ul class="muted" id="exTips" style="margin-top:6px; padding-left:18px"></ul>
    </div>
  </div>
</div>

<script>
/* =========================
STORAGE KEYS
========================= */
const LS_PROFILE="krypta_profile_v9";
const LS_HISTORY="krypta_history_v9";
const LS_PLAN="krypta_plan_v9";
const LS_FEED="krypta_feed_v9";
const LS_STREAK="krypta_streak_v1";
const LS_NOTIFS="krypta_notifs_v1";
const LS_DNA="krypta_dna_v1";
const LS_RECIPES="krypta_recipes_v1";

/* =========================
UTILS
========================= */
const weekDays=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
function escapeHtml(str){
  return String(str ?? "")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
function niceGoal(g){return ({cut:"Get cut",sixpack:"Six-pack",muscle:"Build muscle",strong:"Get stronger"})[g]||g;}
function niceActivity(a){return ({sedentary:"Sedentary",light:"Light",moderate:"Moderate",very:"Very active"})[a]||a;}
function isoDateLocal(d=new Date()){
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const day=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function parseISODate(s){
  const [y,m,d]=String(s||"").split("-").map(Number);
  if(!y||!m||!d) return null;
  return new Date(y, m-1, d, 12, 0, 0, 0);
}
function daysBetween(aISO,bISO){
  const a=parseISODate(aISO), b=parseISODate(bISO);
  if(!a||!b) return 9999;
  const ms = b.getTime() - a.getTime();
  return Math.round(ms / 86400000);
}
function timeAgo(ts){
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<10) return "now";
  if(s<60) return s+"s";
  const m=Math.floor(s/60);
  if(m<60) return m+"m";
  const h=Math.floor(m/60);
  if(h<24) return h+"h";
  return Math.floor(h/24)+"d";
}
function rand(a){return a[Math.floor(Math.random()*a.length)];}
function clamp(n,a,b){return Math.max(a,Math.min(b,n));}

/* =========================
STATE
========================= */
let profile = loadProfile() || defaultProfile();
let selectedFront=[], selectedBack=[], view="front", createMode="gym";
let lastPostDraft=null;

/* =========================
NAV
========================= */
function go(name){
  ["home","plan","create","recipes","history","profile"].forEach(p=>{
    const page=document.getElementById("page"+cap(p));
    if(page) page.classList.toggle("active", p===name);
    const tab=document.getElementById("tab"+cap(p));
    if(tab) tab.classList.toggle("active", p===name);
    const b=document.getElementById("b"+cap(p));
    if(b) b.classList.toggle("active", p===name);
  });

  if(name==="create"){ syncSvg(); renderPills(); if(createMode==="cardio") gpsEnsureMap(); }
  if(name==="plan"){ renderPlan(); }
  if(name==="history"){ renderHistory(); }
  if(name==="recipes"){ renderRecipes(); }
  if(name==="profile"){ fillProfileUI(); renderInjuriesUI(); renderBadges(); renderStreakUI(); renderDNAUI(); }
  if(name==="home"){ renderFeed(); renderHomeHeader(); renderWeeklyRecap(); renderHomeCoachNote(); }

  closeNotifPanel();
}

/* =========================
PROFILE
========================= */
function defaultProfile(){
  return {displayName:"KryptaUser", heightCm:180, weightKg:80, age:20, activity:"moderate", goal:"muscle", days:4, gender:"male", injuries:[]};
}
function loadProfile(){ try{return JSON.parse(localStorage.getItem(LS_PROFILE)||"null");}catch{return null;} }
function saveProfileLS(){ localStorage.setItem(LS_PROFILE, JSON.stringify(profile)); }

/* =========================
FEED (workouts)
========================= */
function loadFeed(){ try{return JSON.parse(localStorage.getItem(LS_FEED)||"[]");}catch{return [];} }
function saveFeed(items){ localStorage.setItem(LS_FEED, JSON.stringify(items)); }

function addFeedPost(p){
  const items=loadFeed();
  items.unshift({
    id:"p_"+Date.now(),
    createdAt:new Date().toISOString(),
    name: profile.displayName||"KryptaUser",
    likes:0, liked:false,
    comments:[],
    coachNote: p.coachNote || "",
    privateReflection: p.privateReflection || null,
    gps: p.gps || null,
    ...p
  });
  saveFeed(items);
  renderFeed();
  renderBadges();
  renderWeeklyRecap();
  updateDNAFromData();
}

function toggleLike(postId){
  const items=loadFeed(); const p=items.find(x=>x.id===postId);
  if(!p) return;
  p.liked=!p.liked;
  p.likes=Math.max(0,(p.likes||0)+(p.liked?1:-1));
  saveFeed(items);
  renderFeed();
  renderBadges();
  notify("like", {fromUser:"You", postId});
}

function addComment(postId, text){
  const t=(text||"").trim(); if(!t) return;
  const items=loadFeed(); const p=items.find(x=>x.id===postId);
  if(!p) return;
  p.comments=p.comments||[];
  p.comments.push({at:new Date().toISOString(), by: profile.displayName||"You", text:t});
  saveFeed(items);
  renderFeed();
  renderBadges();
  notify("comment", {fromUser: profile.displayName||"You", postId, text:t});
}

function renderFeed(){
  const feedEl=document.getElementById("feedList");
  const items=loadFeed();
  if(items.length===0){
    feedEl.innerHTML=`<div class="muted">No posts yet. Create a workout and post it.</div>`;
    return;
  }
  feedEl.innerHTML = items.map(p=>{
    const created=new Date(p.createdAt).toLocaleString();
    const likeClass = p.liked ? "smallBtn likeBtn active" : "smallBtn likeBtn";
    const comments=(p.comments||[]).slice(-3).map(c=>`
      <div class="commentItem"><b>${escapeHtml(c.by)}</b><div class="muted">${escapeHtml(c.text)}</div></div>
    `).join("") || `<div class="muted">No comments yet.</div>`;

    const coachNote = p.coachNote ? `<div class="muted" style="margin-top:8px"><b style="color:rgba(245,247,255,.9)">Private coach note:</b> ${escapeHtml(p.coachNote)}</div>` : "";
    const gpsMini = p.gps && p.gps.points && p.gps.points.length>2
      ? `<div class="muted" style="margin-top:8px">Route saved ‚Ä¢ ${escapeHtml(p.gps.distKm.toFixed(2))} km ‚Ä¢ ${escapeHtml(p.gps.paceStr || "‚Äî")}</div>`
      : "";

    return `
      <div class="post">
        <div class="postTop">
          <div class="userRow">
            <div class="avatar">${escapeHtml((p.name||"K")[0])}</div>
            <div>
              <div style="font-weight:1000">${escapeHtml(p.name||"KryptaUser")}</div>
              <div class="muted">${created}</div>
            </div>
          </div>
          <div class="tag">${escapeHtml(p.type||"Workout")}</div>
        </div>

        <div style="margin-top:10px; font-weight:1000">${escapeHtml(p.title||"Workout")}</div>
        ${p.text?`<div class="muted" style="margin-top:6px; white-space:pre-wrap">${escapeHtml(p.text)}</div>`:""}
        ${gpsMini}
        ${coachNote}

        <div class="btnRow" style="margin-top:10px">
          <button class="${likeClass}" onclick="toggleLike('${p.id}')">‚ù§Ô∏è Like (${p.likes||0})</button>
          <button class="smallBtn" onclick="toggleComments('${p.id}')">üí¨ Comment (${(p.comments||[]).length})</button>
          ${p.gps ? `<button class="smallBtn" onclick="openRouteModal('${p.id}')">üó∫Ô∏è Route</button>` : ""}
        </div>

        <div id="c_${p.id}" style="display:none; margin-top:10px">
          ${comments}
          <div class="commentBox">
            <input id="ci_${p.id}" placeholder="Write a comment..."/>
            <button class="smallBtn" onclick="addComment('${p.id}', document.getElementById('ci_${p.id}').value); document.getElementById('ci_${p.id}').value=''">Post</button>
          </div>
        </div>
      </div>
    `;
  }).join("");
}
function toggleComments(postId){
  const el=document.getElementById("c_"+postId);
  if(!el) return;
  el.style.display = (el.style.display==="block") ? "none" : "block";
}

/* =========================
RECIPES (separate social)
========================= */
function loadRecipes(){ try{return JSON.parse(localStorage.getItem(LS_RECIPES)||"[]");}catch{return [];} }
function saveRecipes(items){ localStorage.setItem(LS_RECIPES, JSON.stringify(items)); }

function clearRecipeForm(){
  ["rName","rCals","rProtein","rIngr","rSteps","rNotes"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
  document.getElementById("rType").value="Dinner";
}

function postRecipe(){
  const name=(document.getElementById("rName").value||"").trim();
  const type=document.getElementById("rType").value;
  const cals=Number(document.getElementById("rCals").value||0)||0;
  const protein=Number(document.getElementById("rProtein").value||0)||0;
  const ingr=(document.getElementById("rIngr").value||"").trim();
  const steps=(document.getElementById("rSteps").value||"").trim();
  const notes=(document.getElementById("rNotes").value||"").trim();

  if(!name || !ingr || !steps){
    alert("Add at least: name, ingredients, steps.");
    return;
  }

  const items=loadRecipes();
  items.unshift({
    id:"r_"+Date.now(),
    createdAt:new Date().toISOString(),
    author: profile.displayName||"KryptaUser",
    name, type, cals, protein, ingr, steps, notes,
    likes:0, liked:false,
    comments:[]
  });
  saveRecipes(items);
  clearRecipeForm();
  renderRecipes();
  notify("recipe", {fromUser: profile.displayName||"You"});
}

function toggleRecipeLike(id){
  const items=loadRecipes();
  const r=items.find(x=>x.id===id);
  if(!r) return;
  r.liked=!r.liked;
  r.likes=Math.max(0,(r.likes||0)+(r.liked?1:-1));
  saveRecipes(items);
  renderRecipes();
  notify("like", {fromUser:"You", recipeId:id});
}

function addRecipeComment(id, text){
  const t=(text||"").trim(); if(!t) return;
  const items=loadRecipes();
  const r=items.find(x=>x.id===id);
  if(!r) return;
  r.comments=r.comments||[];
  r.comments.push({at:new Date().toISOString(), by: profile.displayName||"You", text:t});
  saveRecipes(items);
  renderRecipes();
  notify("comment", {fromUser: profile.displayName||"You", recipeId:id, text:t});
}

function toggleRecipeComments(id){
  const el=document.getElementById("rc_"+id);
  if(!el) return;
  el.style.display = (el.style.display==="block") ? "none" : "block";
}

function renderRecipes(){
  const host=document.getElementById("recipeList");
  const items=loadRecipes();
  if(items.length===0){
    host.innerHTML=`<div class="muted">No recipes yet. Post one above.</div>`;
    return;
  }
  host.innerHTML = items.map(r=>{
    const created=new Date(r.createdAt).toLocaleString();
    const likeClass = r.liked ? "smallBtn likeBtn active" : "smallBtn likeBtn";
    const macroBits=[
      r.cals?`<span class="tag">${r.cals} kcal</span>`:"",
      r.protein?`<span class="tag">${r.protein}g protein</span>`:"",
      `<span class="tag">${escapeHtml(r.type)}</span>`
    ].join(" ");

    const ingrLines = escapeHtml(r.ingr).split("\n").filter(Boolean).slice(0,8).map(x=>`‚Ä¢ ${x}`).join("<br>");
    const stepLines = escapeHtml(r.steps).split("\n").filter(Boolean).slice(0,6).map(x=>`${x}`).join("<br>");

    const comments=(r.comments||[]).slice(-3).map(c=>`
      <div class="commentItem"><b>${escapeHtml(c.by)}</b><div class="muted">${escapeHtml(c.text)}</div></div>
    `).join("") || `<div class="muted">No comments yet.</div>`;

    const notes = r.notes ? `<div class="muted" style="margin-top:8px"><b style="color:rgba(245,247,255,.9)">Notes:</b> ${escapeHtml(r.notes)}</div>` : "";

    return `
      <div class="post">
        <div class="postTop">
          <div class="userRow">
            <div class="avatar">${escapeHtml((r.author||"K")[0])}</div>
            <div>
              <div style="font-weight:1000">${escapeHtml(r.author||"KryptaUser")}</div>
              <div class="muted">${created}</div>
            </div>
          </div>
          <div class="tag">Recipe</div>
        </div>

        <div style="margin-top:10px; font-weight:1000">${escapeHtml(r.name)}</div>

        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">${macroBits}</div>

        <div class="muted" style="margin-top:10px">
          <b style="color:rgba(245,247,255,.92)">Ingredients</b><br>${ingrLines || "‚Äî"}
        </div>
        <div class="muted" style="margin-top:10px">
          <b style="color:rgba(245,247,255,.92)">Steps</b><br>${stepLines || "‚Äî"}
        </div>
        ${notes}

        <div class="btnRow" style="margin-top:10px">
          <button class="${likeClass}" onclick="toggleRecipeLike('${r.id}')">‚ù§Ô∏è Like (${r.likes||0})</button>
          <button class="smallBtn" onclick="toggleRecipeComments('${r.id}')">üí¨ Comment (${(r.comments||[]).length})</button>
        </div>

        <div id="rc_${r.id}" style="display:none; margin-top:10px">
          ${comments}
          <div class="commentBox">             <input id="rci_${r.id}" placeholder="Write a comment..."/>
            <button class="smallBtn" onclick="addRecipeComment('${r.id}', document.getElementById('rci_${r.id}').value); document.getElementById('rci_${r.id}').value=''">Post</button>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

/* =========================
HISTORY
========================= */
function loadHistory(){ try{return JSON.parse(localStorage.getItem(LS_HISTORY)||"[]");}catch{return [];} }
function addHistory(item){
  const items=loadHistory();
  items.unshift({id:"h_"+Date.now(), createdAt:new Date().toISOString(), ...item});
  localStorage.setItem(LS_HISTORY, JSON.stringify(items));
}
function renderHistory(){
  const list=document.getElementById("historyList");
  const items=loadHistory();
  if(items.length===0){
    list.innerHTML=`<div class="muted">No history yet. Post workouts to save locally.</div>`;
    return;
  }
  list.innerHTML = items.map(it=>{
    const dt=new Date(it.createdAt).toLocaleString();
    return `<div class="listItem">
      <div>
        <div style="font-weight:1000">${escapeHtml(it.title||"Workout")}</div>
        <div class="muted">${escapeHtml(it.sub||"")}</div>
        <div class="muted">${dt}</div>
      </div>
      <div class="tag">${escapeHtml(it.type||"")}</div>
    </div>`;
  }).join("");
}
function clearHistory(){
  if(!confirm("Clear local history?")) return;
  localStorage.removeItem(LS_HISTORY);
  renderHistory();
  renderBadges();
  renderWeeklyRecap();
  updateDNAFromData();
}

/* =========================
STREAKS
========================= */
function loadStreak(){
  try{
    const raw=localStorage.getItem(LS_STREAK);
    const s=raw?JSON.parse(raw):null;
    return s && typeof s==="object" ? s : {current:0,best:0,lastDate:null};
  }catch{
    return {current:0,best:0,lastDate:null};
  }
}
function saveStreak(st){ localStorage.setItem(LS_STREAK, JSON.stringify(st)); }
function updateStreakOnWorkoutPost(){
  const st=loadStreak();
  const today=isoDateLocal(new Date());
  if(st.lastDate===today) return st;

  if(!st.lastDate) st.current=1;
  else{
    const diff=daysBetween(st.lastDate, today);
    st.current = (diff===1) ? (st.current+1) : 1;
  }
  st.best = Math.max(st.best||0, st.current||0);
  st.lastDate=today;
  saveStreak(st);

  if(st.current===3 || st.current===7 || st.current===14 || st.current===30){
    notify("streak", {streak:st.current});
  }
  renderStreakUI();
  renderHomeHeader();
  renderBadges();
  return st;
}
function renderStreakUI(){
  const st=loadStreak();
  const chip=document.getElementById("streakChip");
  if(chip) chip.textContent = String(st.current||0);
  const cur=document.getElementById("streakCurrent");
  const best=document.getElementById("streakBest");
  const last=document.getElementById("streakLast");
  if(cur) cur.textContent=String(st.current||0);
  if(best) best.textContent=String(st.best||0);
  if(last) last.textContent=st.lastDate?st.lastDate:"‚Äî";
}

/* =========================
WORKOUT DNA
========================= */
function loadDNA(){
  try{
    const raw=localStorage.getItem(LS_DNA);
    const d=raw?JSON.parse(raw):null;
    return d && typeof d==="object" ? d : {style:"‚Äî", explain:""};
  }catch{
    return {style:"‚Äî", explain:""};
  }
}
function saveDNA(d){ localStorage.setItem(LS_DNA, JSON.stringify(d)); }
function computeDNAFromFeed(){
  const feed=loadFeed();
  const last30 = feed.filter(p=>{
    const dt=new Date(p.createdAt);
    return (Date.now()-dt.getTime()) <= 30*86400000;
  });
  const gym=last30.filter(p=>p.type==="Gym").length;
  const cardio=last30.filter(p=>p.type==="Cardio").length;
  const wod=last30.filter(p=>p.type==="WOD").length;
  const total=Math.max(1, gym+cardio+wod);

  let style="Hybrid Athlete";
  let explain=`You mix training modes: Gym ${gym}, Cardio ${cardio}, WOD ${wod} (last 30 days).`;

  const gymShare=gym/total, cardioShare=cardio/total, wodShare=wod/total;

  if(gymShare>=0.70 && cardioShare<0.20 && wodShare<0.20){
    style="Strength Builder";
    explain="Mostly gym sessions lately. Consistent strength work.";
  }else if(cardioShare>=0.60 && gymShare<0.30){
    style="Engine Focused";
    explain="Mostly cardio lately. Building endurance and consistency.";
  }else if(wodShare>=0.50){
    style="CrossFit Hybrid";
    explain="A lot of WODs lately. Strong mix of strength + conditioning.";
  }
  return {style, explain, counts:{gym,cardio,wod}};
}
function updateDNAFromData(){
  const d=computeDNAFromFeed();
  saveDNA({style:d.style, explain:d.explain, ts:Date.now()});
  renderDNAUI();
  const chip=document.getElementById("dnaChip");
  if(chip) chip.textContent = d.style.includes(" ") ? d.style.split(" ")[0] : d.style;
}
function renderDNAUI(){
  const d=loadDNA();
  const el=document.getElementById("dnaStyle");
  const ex=document.getElementById("dnaExplain");
  if(el) el.textContent = d.style || "‚Äî";
  if(ex) ex.textContent = d.explain || "";
  const chip=document.getElementById("dnaChip");
  if(chip) chip.textContent = d.style && d.style!=="‚Äî" ? (d.style.split(" ")[0] || d.style) : "‚Äî";
}

/* =========================
WEEKLY RECAP + RECOVERY
========================= */
function startOfWeekISO(date=new Date()){
  const d=new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0, 0);
  const day=(d.getDay()+6)%7; // Mon=0
  d.setDate(d.getDate()-day);
  return isoDateLocal(d);
}
function weeklyStats(){
  const hist=loadHistory();
  const todayISO=isoDateLocal(new Date());
  const weekStart=startOfWeekISO(new Date());
  const thisWeek=hist.filter(h=>{
    const d=isoDateLocal(new Date(h.createdAt));
    return d>=weekStart && d<=todayISO;
  });
  const gym=thisWeek.filter(x=>x.type==="Gym").length;
  const cardio=thisWeek.filter(x=>x.type==="Cardio").length;
  const wod=thisWeek.filter(x=>x.type==="WOD").length;
  const total=thisWeek.length;

  let minutes=0;
  thisWeek.forEach(x=>{
    if(x.type==="Cardio"){
      const m = Number((x.meta && x.meta.minutes) || 0);
      minutes += (m>0?m:30);
    }else if(x.type==="WOD"){
      minutes += 35;
    }else{
      minutes += 45;
    }
  });

  return {weekStart, total, gym, cardio, wod, minutes};
}
function recoveryScoreFromWeek(){
  const st=weeklyStats();
  const injuries=(profile.injuries||[]).length;
  let score="Good";
  let note="Balanced week. Keep it calm and consistent.";
  if(st.total>=6){
    score="Moderate";
    note="High frequency week. A lighter day may help recovery.";
  }
  if(injuries>=2 && st.total>=4){
    score="Needs rest";
    note="You have active injury notes. Prioritize recovery work and smart substitutions.";
  }
  if(st.total<=1){
    score="Good";
    note="Low volume week so far. Even a short session counts.";
  }
  return {score, note};
}
function renderWeeklyRecap(){
  const el=document.getElementById("weeklyRecap");
  const rc=document.getElementById("recoveryScore");
  const s=weeklyStats();
  const r=recoveryScoreFromWeek();
  if(el){
    el.innerHTML = `${escapeHtml(s.weekStart)} ‚Üí now<br>
      Sessions: <b>${s.total}</b> (Gym ${s.gym} ‚Ä¢ Cardio ${s.cardio} ‚Ä¢ WOD ${s.wod})<br>
      Estimated minutes: <b>${s.minutes}</b>`;
  }
  if(rc){
    rc.innerHTML = `<b>${escapeHtml(r.score)}</b><br>${escapeHtml(r.note)}`;
  }
}
function renderHomeHeader(){
  const el=document.getElementById("homeSummary");
  if(!el) return;
  const st=loadStreak();
  const dna=loadDNA();
  const injCount=(profile.injuries||[]).length;
  el.innerHTML = `<b>${escapeHtml(niceGoal(profile.goal))}</b> ‚Ä¢ ${profile.days} days/week
    <span class="muted"> ‚Ä¢ ${profile.heightCm}cm ‚Ä¢ ${profile.weightKg}kg ‚Ä¢ age ${profile.age} ‚Ä¢ ${escapeHtml(niceActivity(profile.activity))} ‚Ä¢ injuries: ${injCount}</span>
    <br><span class="muted">Streak: ${st.current||0} ‚Ä¢ Best: ${st.best||0} ‚Ä¢ DNA: ${escapeHtml(dna.style||"‚Äî")}</span>`;
}
function renderHomeCoachNote(){
  const el=document.getElementById("coachNoteHome");
  if(!el) return;
  const st=loadStreak();
  const today=isoDateLocal(new Date());
  const diff = st.lastDate ? daysBetween(st.lastDate, today) : null;
  let note="";
  if(!st.lastDate){
    note="Private coach note: Start small. One session is a new baseline.";
  }else if(diff===0){
    note="Private coach note: Streak protected today. Keep tomorrow simple.";
  }else if(diff===1){
    note="Private coach note: One session today keeps the streak alive.";
  }else if(diff>1){
    note="Private coach note: No pressure. A short session restarts momentum.";
  }
  el.textContent = note;
}

/* =========================
NOTIFICATIONS
========================= */
const Notifs = { tab:"all", items:[] };
function loadNotifs(){
  try{
    const raw = localStorage.getItem(LS_NOTIFS);
    Notifs.items = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(Notifs.items)) Notifs.items = [];
  }catch{ Notifs.items = []; }
}
function saveNotifs(){ localStorage.setItem(LS_NOTIFS, JSON.stringify(Notifs.items)); }
function unreadCount(){ return Notifs.items.reduce((a,n)=>a + (n.read?0:1), 0); }
function notify(type, payload={}){
  const id = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+"_"+Math.random().toString(16).slice(2));
  Notifs.items.unshift({ id, type, payload, ts: Date.now(), read:false });
  if(Notifs.items.length > 200) Notifs.items = Notifs.items.slice(0,200);
  saveNotifs();
  renderNotifUI();
  return id;
}
function iconForType(type){
  if(type==="like") return "‚ù§Ô∏è";
  if(type==="comment") return "üí¨";
  if(type==="plan") return "üóìÔ∏è";
  if(type==="streak") return "üî•";
  if(type==="recipe") return "ü•ó";
  return "üîî";
}
function titleForNotif(n){
  const p=n.payload||{};
  switch(n.type){
    case "like": return `${p.fromUser||"Someone"} liked something`;
    case "comment": return `${p.fromUser||"Someone"} commented`;
    case "plan": return `Plan reminder`;
    case "streak": return `Streak milestone`;
    case "recipe": return `New recipe posted`;
    default: return "Notification";
  }
}
function subForNotif(n){
  const p=n.payload||{};
  switch(n.type){
    case "comment": return (p.text||"Tap to view").slice(0,80);
    case "plan": return p.workoutName ? `${p.dayLabel||"Today"} ‚Ä¢ ${p.workoutName}` : "Open your plan";
    case "streak": return p.streak ? `Current streak: ${p.streak} days` : "Keep it going";
    case "recipe": return "Tap Recipes";
    default: return "Tap to view";
  }
}
function mountNotifUI(){
  const host = document.getElementById("topRightActions");
  if(!host) return;
  if(document.getElementById("notifWrap")) return;

  const wrap=document.createElement("div");
  wrap.className="notifWrap";
  wrap.id="notifWrap";
  wrap.innerHTML = `
    <button class="notifBtn" id="notifBtn" aria-label="Notifications">üîî</button>
    <span class="notifCount" id="notifCount"></span>
    <div class="notifPanel" id="notifPanel">
      <div class="notifHead">
        <b>Notifications</b>
        <div class="notifActions">
          <button class="nChip" id="notifMarkAll">Mark all</button>
          <button class="nChip" id="notifClear">Clear</button>
        </div>
      </div>
      <div class="notifTabs">
        <button class="nTab active" id="notifTabAll" onclick="setNotifTab('all')">All</button>
        <button class="nTab" id="notifTabMentions" onclick="setNotifTab('mentions')">Mentions</button>
      </div>
      <div class="notifList" id="notifList"></div>
    </div>
  `;
  host.insertBefore(wrap, host.firstElementChild);

  document.getElementById("notifBtn").addEventListener("click",(e)=>{
    e.stopPropagation();
    const panel=document.getElementById("notifPanel");
    const open = panel.style.display==="block";
    panel.style.display = open ? "none" : "block";
    if(!open) renderNotifUI();
  });
  document.getElementById("notifPanel").addEventListener("click",(e)=>e.stopPropagation());
  document.addEventListener("click", ()=> closeNotifPanel());

  document.getElementById("notifMarkAll").addEventListener("click",(e)=>{
    e.stopPropagation();
    Notifs.items = Notifs.items.map(n=>({...n, read:true}));
    saveNotifs();
    renderNotifUI();
  });
  document.getElementById("notifClear").addEventListener("click",(e)=>{
    e.stopPropagation();
    Notifs.items = [];
    saveNotifs();
    renderNotifUI();
  });
}
function closeNotifPanel(){
  const panel=document.getElementById("notifPanel");
  if(panel) panel.style.display="none";
}
function setNotifTab(tab){
  Notifs.tab=tab;
  document.getElementById("notifTabAll").classList.toggle("active", tab==="all");
  document.getElementById("notifTabMentions").classList.toggle("active", tab==="mentions");
  renderNotifList();
}
function renderNotifList(){
  const list=document.getElementById("notifList");
  if(!list) return;

  let items=Notifs.items.slice();
  if(Notifs.tab==="mentions"){
    items = items.filter(n => n.type==="mention" || (n.payload && typeof n.payload.text==="string" && n.payload.text.includes("@")));
  }
  if(items.length===0){
    list.innerHTML = `<div class="notifEmpty">No notifications yet</div>`;
    return;
  }
  list.innerHTML = items.map(n=>`
    <div class="notifItem ${n.read?"":"unread"}" data-id="${n.id}">
      <div class="notifIcon">${iconForType(n.type)}</div>
      <div class="notifBody">
        <div class="notifT">${escapeHtml(titleForNotif(n))}</div>
        <div class="notifS">${escapeHtml(subForNotif(n))}</div>
      </div>
      <div class="notifMeta">${timeAgo(n.ts)}</div>
    </div>
  `).join("");

  list.querySelectorAll(".notifItem").forEach(el=>{
    el.addEventListener("click",()=>{
      const id=el.getAttribute("data-id");
      const n=Notifs.items.find(x=>x.id===id);
      if(!n) return;
      n.read=true;
      saveNotifs();
      renderNotifUI();

      if(n.type==="recipe"){ go("recipes"); }
      if(n.payload && n.payload.postId){
        go("home");
        setTimeout(()=>{ const c=document.getElementById("c_"+n.payload.postId); if(c) c.style.display="block"; }, 200);
      }
      closeNotifPanel();
    });
  });
}
function renderNotifUI(){
  const count=unreadCount();
  const c=document.getElementById("notifCount");
  if(c){
    c.style.display = count>0 ? "block" : "none";
    c.textContent = count>99 ? "99+" : String(count);
  }
  renderNotifList();
}

/* Plan reminder: at ~09:00 show reminder if today is Gym and no post yet */
function schedulePlanReminder(){
  setInterval(()=>{
    const now=new Date();
    const h=now.getHours(), m=now.getMinutes();
    if(h===9 && m<10){
      const st=loadStreak();
      const today=isoDateLocal(now);
      if(st.lastDate===today) return;
      let plan=loadPlan(); if(!plan) plan=generatePlan(true);
      const dayName = weekDays[(now.getDay()+6)%7];
      const item=plan.days[dayName];
      if(item && item.kind==="Gym"){
        const key="krypta_plan_remind_"+today;
        if(localStorage.getItem(key)) return;
        localStorage.setItem(key,"1");
        notify("plan",{dayLabel:dayName, workoutName:item.label});
      }
    }
  }, 5*60*1000);
}

/* =========================
INJURIES
========================= */
function normalizeInjury(s){ return (s||"").trim().toLowerCase(); }
function renderInjuriesUI(){
  const list=document.getElementById("injuryList"); if(!list) return;
  list.innerHTML="";
  const inj=profile.injuries||[];
  if(inj.length===0){ list.innerHTML=`<span class="muted">none</span>`; return; }
  inj.forEach((txt, idx)=>{
    const pill=document.createElement("div");
    pill.className="pill active";
    pill.textContent="ü©π "+txt+"  ‚úï";
    pill.onclick=()=>{ profile.injuries.splice(idx,1); saveProfileLS(); renderInjuriesUI(); generatePlan(true); renderPlan(); renderBadges(); };
    list.appendChild(pill);
  });
}
function addInjury(){
  const raw=document.getElementById("newInjuryInput").value||"";
  const val=raw.trim(); if(!val) return;
  profile.injuries=profile.injuries||[];
  const key=normalizeInjury(val);
  if(!profile.injuries.some(x=>normalizeInjury(x)===key)) profile.injuries.push(val);
  document.getElementById("newInjuryInput").value="";
  saveProfileLS();
  renderInjuriesUI(); generatePlan(true); renderPlan(); renderBadges();
  alert("Injury added. Plan updated.");
}
function clearInjuries(){
  if(!confirm("Clear all injuries?")) return;
  profile.injuries=[]; saveProfileLS();
  renderInjuriesUI(); generatePlan(true); renderPlan(); renderBadges();
}

/* =========================
PROFILE UI
========================= */
function fillProfileUI(){
  document.getElementById("displayName").value=profile.displayName||"";
  document.getElementById("gender").value=profile.gender||"male";
  document.getElementById("heightCm").value=profile.heightCm||"";
  document.getElementById("weightKg").value=profile.weightKg||"";
  document.getElementById("age").value=profile.age||"";
  document.getElementById("activity").value=profile.activity||"moderate";
  document.getElementById("goal").value=profile.goal||"muscle";
  document.getElementById("days").value=String(profile.days||4);
}
function saveProfile(){
  profile={
    displayName: document.getElementById("displayName").value || "KryptaUser",
    gender: document.getElementById("gender").value,
    heightCm: Number(document.getElementById("heightCm").value)||180,
    weightKg: Number(document.getElementById("weightKg").value)||80,
    age: Number(document.getElementById("age").value)||20,
    activity: document.getElementById("activity").value,
    goal: document.getElementById("goal").value,
    days: Number(document.getElementById("days").value)||4,
    injuries: profile.injuries || []
  };
  saveProfileLS();
  renderHomeHeader();
  renderInjuriesUI();
  generatePlan(true); renderPlan();
  renderBadges();
  renderStreakUI();
  updateDNAFromData();
  alert("Saved!");
  go("home");
}
function resetAll(){
  if(!confirm("Reset local profile/plan/history/feed/streak/notifs/recipes?")) return;
  localStorage.removeItem(LS_PROFILE);
  localStorage.removeItem(LS_HISTORY);
  localStorage.removeItem(LS_PLAN);
  localStorage.removeItem(LS_FEED);
  localStorage.removeItem(LS_STREAK);
  localStorage.removeItem(LS_NOTIFS);
  localStorage.removeItem(LS_DNA);
  localStorage.removeItem(LS_RECIPES);
  profile=defaultProfile();
  selectedFront=[]; selectedBack=[]; lastPostDraft=null;
  gpsStop(false);
  initLocal();
  go("home");
}

/* =========================
CREATE MODE
========================= */
function setCreateMode(m){
  createMode=m;

  document.getElementById("createModeTag").textContent = m==="gym"?"Gym":(m==="cardio"?"Cardio":"WOD");
  document.getElementById("gymCard").style.display = (m==="gym")?"block":"none";
  document.getElementById("cardioCard").style.display = (m==="cardio")?"block":"none";
  document.getElementById("crossfitCard").style.display = (m==="crossfit")?"block":"none";

  document.getElementById("btnModeGym").style.opacity = (m==="gym")?"1":"0.7";
  document.getElementById("btnModeCardio").style.opacity = (m==="cardio")?"1":"0.7";
  document.getElementById("btnModeCF").style.opacity = (m==="crossfit")?"1":"0.7";

  hidePostCard();
  if(m==="cardio") setTimeout(()=>gpsEnsureMap(), 50);
}

/* =========================
MUSCLE PICKER
========================= */
function currentSelection(){ return view==="front" ? selectedFront : selectedBack; }
function setCurrentSelection(arr){ if(view==="front") selectedFront=arr; else selectedBack=arr; }
function setView(v){
  view=v;
  document.getElementById("viewTag").textContent = v==="front"?"Front":"Back";
  document.getElementById("viewHint").textContent = v==="front"?"Front muscles only.":"Back muscles only.";
  document.getElementById("svgFront").style.display = v==="front"?"block":"none";
  document.getElementById("svgBack").style.display = v==="back"?"block":"none";
  syncSvg(); renderPills();
}
function clearSelection(){ setCurrentSelection([]); syncSvg(); renderPills(); }
function setActive(id,on){ const el=document.getElementById(id); if(el) el.classList.toggle("active", !!on); }
function syncSvg(){
  const f=selectedFront, b=selectedBack;
  setActive("f_shoulders", f.includes("Shoulders"));
  setActive("f_chest", f.includes("Chest"));
  setActive("f_core", f.includes("Core"));
  setActive("f_biceps", f.includes("Biceps"));
  setActive("f_triceps", f.includes("Triceps"));
  setActive("f_quads", f.includes("Quads"));
  setActive("f_calves", f.includes("Calves"));

  setActive("b_traps", b.includes("Traps"));
  setActive("b_back", b.includes("Back"));
  setActive("b_triceps", b.includes("Triceps"));
  setActive("b_glutes", b.includes("Glutes"));
  setActive("b_hams", b.includes("Hamstrings"));
  setActive("b_calves", b.includes("Calves"));

  document.getElementById("selCount").textContent = String(currentSelection().length);
}
function renderPills(){
  const wrap=document.getElementById("selectedPills"); wrap.innerHTML="";
  const uniq=[...new Set(currentSelection())].sort();
  if(uniq.length===0){ wrap.innerHTML=`<span class="muted">Nothing selected for this view.</span>`; return; }
  uniq.forEach(m=>{
    const d=document.createElement("div");
    d.className="pill active";
    d.textContent="üí™ "+m;
    d.onclick=()=>{
      setCurrentSelection(currentSelection().filter(x=>x!==m));
      syncSvg(); renderPills();
    };
    wrap.appendChild(d);
  });
}
document.addEventListener("click",(e)=>{
  const id=e.target && e.target.id; if(!id) return;
  const map={
    f_shoulders:"Shoulders", f_chest:"Chest", f_core:"Core", f_biceps:"Biceps", f_triceps:"Triceps", f_quads:"Quads", f_calves:"Calves",
    b_traps:"Traps", b_back:"Back", b_triceps:"Triceps", b_glutes:"Glutes", b_hams:"Hamstrings", b_calves:"Calves"
  };
  if(map[id]){
    const sel=currentSelection();
    const m=map[id];
    setCurrentSelection(sel.includes(m) ? sel.filter(x=>x!==m) : [...sel,m]);
    syncSvg(); renderPills();
  }
});

/* =========================
WARM-UP
========================= */
function warmupForMuscles(muscles){
  const set = new Set(muscles || []);
  const drills = [];
  drills.push("3‚Äì5 min easy warm-up: bike/row/jog + nasal breathing");
  if(set.has("Chest")||set.has("Shoulders")||set.has("Triceps")||set.has("Biceps")||set.has("Back")||set.has("Traps")){
    drills.push("2 rounds: 10 band pull-aparts + 10 scap push-ups + 8 PVC pass-throughs");
  }
  if(set.has("Quads")||set.has("Glutes")||set.has("Hamstrings")||set.has("Calves")){
    drills.push("2 rounds: 10 air squats + 10 hip hinges + 20 calf bounces");
  }
  if(set.has("Core")){
    drills.push("2 rounds: 20s dead-bug + 20s side plank each side");
  }
  drills.push("1‚Äì2 ramp-up sets per lift before working sets");
  return drills;
}

/* =========================
EXERCISE LIBRARY + DEMOS (moving bar/dumbbells)
========================= */
const EX = {
  "Barbell Back Squat": {
    muscles:["Quads","Glutes","Core"],
    cue:"Brace + sit between hips.",
    how:"Set bar on upper traps. Big breath, brace, sit down/back. Knees track over toes. Stand up by pushing floor away.",
    tips:["Keep mid-foot pressure.","Depth: hip crease below knee if pain-free.","Drive up with chest and hips together."],
    demo: demoSquat
  },
  "Bench Press": {
    muscles:["Chest","Triceps","Shoulders"],
    cue:"Touch lower chest, press up/back.",
    how:"Eyes under bar. Feet planted. Lower to lower chest with control. Press up and slightly back, keeping wrists stacked.",
    tips:["Shoulder blades back + down.","Forearms vertical at bottom.","Don‚Äôt bounce."],
    demo: demoBench
  },
  "Dumbbell Curl": {
    muscles:["Biceps"],
    cue:"Elbows still. Squeeze at top.",
    how:"Stand tall. Curl DBs without swinging. Control down fully.",
    tips:["Keep elbows slightly forward.","Slow eccentric.","Don‚Äôt shrug."],
    demo: demoCurl
  },
  "Kettlebell Swing": {
    muscles:["Glutes","Hamstrings","Core"],
    cue:"Hinge snap. Arms are ropes.",
    how:"Hinge back, hike KB, then snap hips forward. KB floats to chest height. Repeat with rhythm.",
    tips:["Neutral spine.","KB stays close.","Power comes from hips."],
    demo: demoKBSwing
  },
  "Lat Pulldown": {
    muscles:["Back","Biceps"],
    cue:"Pull elbows to ribs.",
    how:"Grip bar, slight lean back. Pull to upper chest. Control up.",
    tips:["Don‚Äôt yank.","Keep ribs down.","Squeeze lats at bottom."],
    demo: demoPulldown
  },
  "Romanian Deadlift": {
    muscles:["Hamstrings","Glutes","Back"],
    cue:"Hips back. Shins vertical.",
    how:"Soft knees, hinge back, bar slides down thighs. Stop when hamstrings stretch. Stand by driving hips forward.",
    tips:["Neutral spine.","Keep bar close.","Slow down."],
    demo: demoRDL
  }
};

/* Minimal extra demos */
function demoPulldown(){ return demoStatic("Pulldown (preview)", "Bar moves down to chest."); }
function demoRDL(){ return demoStatic("RDL (preview)", "Hips hinge back, bar slides down legs."); }
function demoStatic(title, note){
  return `
  <svg class="exSvg" viewBox="0 0 860 360">
    <text x="30" y="40" fill="rgba(245,247,255,.9)" font-size="20" font-weight="900">${escapeHtml(title)}</text>
    <text x="30" y="70" fill="rgba(245,247,255,.7)" font-size="14">${escapeHtml(note)}</text>
    <rect x="80" y="110" width="700" height="200" rx="18" fill="rgba(255,255,255,.04)" stroke="rgba(255,255,255,.10)"/>
    <path d="M220 260 L260 190 L300 260" stroke="rgba(245,247,255,.8)" stroke-width="6" fill="none" stroke-linecap="round"/>
    <circle cx="260" cy="160" r="26" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.18)" stroke-width="3"/>
    <path d="M260 186 L260 256" stroke="rgba(245,247,255,.8)" stroke-width="6" stroke-linecap="round"/>
    <path d="M260 210 L220 235" stroke="rgba(245,247,255,.8)" stroke-width="6" stroke-linecap="round"/>
    <path d="M260 210 L300 235" stroke="rgba(245,247,255,.8)" stroke-width="6" stroke-linecap="round"/>
  </svg>`;
}

/* Squat with moving bar + knee/ankle joints */
function demoSquat(){
  return `
  <svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
    <!-- rack -->
    <path d="M150 90 V320 M710 90 V320" stroke="rgba(245,247,255,.18)" stroke-width="8" stroke-linecap="round"/>
    <path d="M140 90 H720" stroke="rgba(245,247,255,.12)" stroke-width="10" stroke-linecap="round"/>

    <!-- barbell -->
    <g class="rep squatBar" style="transform-origin: 430px 120px;">
      <rect x="250" y="110" width="360" height="14" rx="7" fill="rgba(245,247,255,.85)"/>
      <circle cx="240" cy="117" r="26" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
      <circle cx="620" cy="117" r="26" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
      <circle cx="208" cy="117" r="18" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.35)" stroke-width="3"/>
      <circle cx="652" cy="117" r="18" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.35)" stroke-width="3"/>
    </g>

    <!-- human -->
    <g class="rep squatHip" style="transform-origin: 430px 185px;">
      <!-- torso -->
      <g class="rep squatTorso" style="transform-origin: 430px 175px;">
        <circle cx="430" cy="140" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
        <path d="M430 160 L430 220" stroke="rgba(245,247,255,.85)" stroke-width="8" stroke-linecap="round"/>
        <!-- arms to bar -->
        <path d="M430 185 L360 120" stroke="rgba(245,247,255,.75)" stroke-width="7" stroke-linecap="round"/>
        <path d="M430 185 L500 120" stroke="rgba(245,247,255,.75)" stroke-width="7" stroke-linecap="round"/>
      </g>

      <!-- pelvis -->
      <circle cx="430" cy="230" r="10" fill="rgba(245,247,255,.55)"/>

      <!-- left leg -->
      <g class="rep squatKneeL" style="transform-origin: 408px 250px;">
        <path d="M430 230 L408 270" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
        <circle cx="408" cy="270" r="7" fill="rgba(245,247,255,.55)"/>
        <g class="rep squatAnkL" style="transform-origin: 390px 310px;">
          <path d="M408 270 L390 312" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
          <path d="M370 318 H405" stroke="rgba(245,247,255,.75)" stroke-width="10" stroke-linecap="round"/>
        </g>
      </g>

      <!-- right leg -->
      <g class="rep squatKneeR" style="transform-origin: 452px 250px;">
        <path d="M430 230 L452 270" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
        <circle cx="452" cy="270" r="7" fill="rgba(245,247,255,.55)"/>
        <g class="rep squatAnkR" style="transform-origin: 470px 310px;">
          <path d="M452 270 L470 312" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
          <path d="M455 318 H490" stroke="rgba(245,247,255,.75)" stroke-width="10" stroke-linecap="round"/>
        </g>
      </g>
    </g>
  </svg>`;
}

/* Bench with moving bar + forearms */
function demoBench(){
  return `
  <svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
    <!-- bench -->
    <rect x="220" y="240" width="420" height="26" rx="13" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.14)"/>
    <rect x="280" y="266" width="26" height="60" rx="13" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.12)"/>
    <rect x="560" y="266" width="26" height="60" rx="13" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.12)"/>

    <!-- bar -->
    <g class="rep benchBar" style="transform-origin: 430px 150px;">
      <rect x="260" y="144" width="340" height="12" rx="6" fill="rgba(245,247,255,.85)"/>
      <circle cx="250" cy="150" r="22" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
      <circle cx="610" cy="150" r="22" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
    </g>

    <!-- body on bench -->
    <circle cx="355" cy="235" r="18" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
    <path d="M375 235 L520 235" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
    <path d="M520 235 L610 275" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>

    <!-- arms (upper + forearms) -->
    <g class="rep benchUpperL" style="transform-origin: 380px 210px;">
      <path d="M420 235 L380 210" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
      <g class="rep benchForeL" style="transform-origin: 365px 190px;">
        <path d="M380 210 L350 170" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
      </g>
    </g>

    <g class="rep benchUpperR" style="transform-origin: 480px 210px;">
      <path d="M420 235 L480 210" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
      <g class="rep benchForeR" style="transform-origin: 495px 190px;">
        <path d="M480 210 L510 170" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
      </g>
    </g>
  </svg>`;
}

/* Dumbbell curl with moving dumbbells */
function demoCurl(){
  return `
  <svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
    <!-- head + torso -->
    <circle cx="430" cy="95" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
    <path d="M430 115 L430 200" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
    <circle cx="430" cy="205" r="10" fill="rgba(245,247,255,.55)"/>
    <path d="M430 210 L405 290" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
    <path d="M430 210 L455 290" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>

    <!-- left arm -->
    <path d="M430 150 L375 190" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
    <g class="rep curlForeL" style="transform-origin: 375px 190px;">
      <path d="M375 190 L345 240" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
      <g class="rep curlDbL" style="transform-origin: 345px 240px;">
        <rect x="325" y="240" width="40" height="10" rx="5" fill="rgba(245,247,255,.85)"/>
        <circle cx="325" cy="245" r="10" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="3"/>
        <circle cx="365" cy="245" r="10" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="3"/>
      </g>
    </g>

    <!-- right arm -->
    <path d="M430 150 L485 190" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
    <g class="rep curlForeR" style="transform-origin: 485px 190px;">
      <path d="M485 190 L515 240" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
      <g class="rep curlDbR" style="transform-origin: 515px 240px;">
        <rect x="495" y="240" width="40" height="10" rx="5" fill="rgba(245,247,255,.85)"/>
        <circle cx="495" cy="245" r="10" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="3"/>
        <circle cx="535" cy="245" r="10" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="3"/>
      </g>
    </g>
  </svg>`;
}

/* KB swing: torso + arms + kettlebell arc */
function demoKBSwing(){
  return `
  <svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
    <g class="rep kbSwingTorso" style="transform-origin: 430px 170px;">
      <circle cx="430" cy="95" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
      <path d="M430 115 L430 200" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
    </g>
    <circle cx="430" cy="205" r="10" fill="rgba(245,247,255,.55)"/>
    <path d="M430 210 L405 300" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
    <path d="M430 210 L455 300" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>

    <g class="rep kbSwingArms" style="transform-origin: 430px 185px;">
      <path d="M430 160 L390 220" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
      <path d="M430 160 L470 220" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
    </g>

    <g class="rep kbSwingKB" style="transform-origin: 430px 245px;">
      <path d="M415 245 Q430 225 445 245" stroke="rgba(245,247,255,.7)" stroke-width="6" fill="none" stroke-linecap="round"/>
      <path d="M410 245 C410 270 450 270 450 245" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
      <circle cx="430" cy="260" r="12" fill="rgba(245,247,255,.20)" stroke="rgba(245,247,255,.35)" stroke-width="2"/>
    </g>
  </svg>`;
}

/* =========================
EXERCISE MODAL CONTROL
========================= */
let exPlaying=true;
let exSpeed=1800;

function openExercise(name){
  const ex=EX[name];
  if(!ex){
    alert("Exercise not found.");
    return;
  }
  document.getElementById("exTitle").textContent=name;
  document.getElementById("exMuscles").textContent="Muscles: "+(ex.muscles||[]).join(", ");
  document.getElementById("exHow").textContent=ex.how||"";
  document.getElementById("exCue").textContent="Cue: "+(ex.cue||"‚Äî");

  const tips=document.getElementById("exTips");
  tips.innerHTML="";
  (ex.tips||[]).forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t;
    tips.appendChild(li);
  });

  const pic=document.getElementById("exPic");
  pic.innerHTML = ex.demo ? ex.demo() : demoStatic(name, "Preview");
  setExSpeed(exSpeed);
  exPlaying=true;
  syncExPlayUI();
  document.getElementById("exerciseModal").style.display="block";
}
function closeExercise(){
  document.getElementById("exerciseModal").style.display="none";
}
function toggleExPlay(){
  exPlaying=!exPlaying;
  syncExPlayUI();
}
function syncExPlayUI(){
  const svg=document.getElementById("exSvg");
  const btn=document.getElementById("exPlayBtn");
  if(svg){
    svg.classList.toggle("exPlay", exPlaying);
    // also pause animations via class
    svg.querySelectorAll(".rep").forEach(n=>{
      n.style.animationPlayState = exPlaying ? "running" : "paused";
    });
  }
  if(btn){
    btn.textContent = exPlaying ? "‚è∏ Pause" : "‚ñ∂ Play";
    btn.classList.toggle("active", exPlaying);
  }
}
function setExSpeed(ms){
  exSpeed=ms;
  document.documentElement.style.setProperty("--repDur", ms+"ms");
  const mid=document.getElementById("exSpeedMid");
  if(mid){
    // quick visual: highlight normal when 1800
    mid.classList.toggle("active", ms===1800);
  }
}

/* =========================
PLAN
========================= */
function loadPlan(){ try{return JSON.parse(localStorage.getItem(LS_PLAN)||"null");}catch{return null;} }
function savePlan(p){ localStorage.setItem(LS_PLAN, JSON.stringify(p)); }

function generatePlan(save=true){
  const days=clamp(Number(profile.days||4),3,6);
  const splitByDays={
    3:["Gym","Cardio","Gym"],
    4:["Gym","Cardio","Gym","WOD"],
    5:["Gym","Cardio","Gym","WOD","Gym"],
    6:["Gym","Cardio","Gym","WOD","Gym","Cardio"]
  }[days];

  const plan={ createdAt:new Date().toISOString(), days:{} };
  const labels={
    Gym:["Upper Strength","Lower Strength","Full Body","Pull Focus","Push Focus"],
    Cardio:["Easy Zone 2","Intervals","Hill Walk","Tempo Run","Long Walk"],
    WOD:["Mixed Metcon","Strength + Metcon","Engine Builder","Chipper","EMOM"]
  };

  // assign across week Mon..Sun in order, rest as Rest
  let idx=0;
  weekDays.forEach((d,i)=>{
    if(idx<splitByDays.length){
      const kind=splitByDays[idx++];
      plan.days[d]={ kind, label: rand(labels[kind]) };
    }else{
      plan.days[d]={ kind:"Rest", label:"Recovery + mobility" };
    }
  });

  if(save) savePlan(plan);
  return plan;
}

function renderPlan(){
  const host=document.getElementById("planList");
  let plan=loadPlan();
  if(!plan) plan=generatePlan(true);

  host.innerHTML = weekDays.map(d=>{
    const item=plan.days[d];
    const tag=item.kind==="Rest"?"Rest":item.kind;
    return `
      <div class="listItem" onclick="openPlanDay('${d}')">
        <div>
          <div style="font-weight:1000">${escapeHtml(d)}</div>
          <div class="muted">${escapeHtml(item.label||"")}</div>
        </div>
        <div class="tag">${escapeHtml(tag)}</div>
      </div>
    `;
  }).join("");
}

function openPlanDay(day){
  let plan=loadPlan(); if(!plan) plan=generatePlan(true);
  const item=plan.days[day];
  document.getElementById("planWeekCard").style.display="none";
  document.getElementById("planDayCard").style.display="block";
  document.getElementById("planDayTitle").textContent=day;
  document.getElementById("planDaySub").textContent=item.kind==="Rest" ? "Recovery focus" : "Warm-up is always first.";
  document.getElementById("planDayTag").textContent=item.kind;

  const body=document.getElementById("planDayBody");
  if(item.kind==="Rest"){
    body.innerHTML = `
      <div class="muted"><b>Recovery</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ 20‚Äì40 min easy walk
‚Ä¢ 8‚Äì12 min mobility (hips + shoulders)
‚Ä¢ 5 min breathing (slow nasal)
      </div>`;
    return;
  }

  if(item.kind==="Cardio"){
    body.innerHTML = `
      <div class="muted"><b>Warm-up</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ 5 min easy pace
‚Ä¢ 3 x 20s faster + 40s easy
      </div>
      <div class="muted" style="margin-top:12px"><b>Main</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ ${escapeHtml(item.label)}
‚Ä¢ Total: 25‚Äì45 min
      </div>`;
    return;
  }

  if(item.kind==="WOD"){
    body.innerHTML = `
      <div class="muted"><b>Warm-up</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ 4 min easy row/bike
‚Ä¢ 2 rounds: 10 air squats + 10 push-ups + 10 sit-ups
      </div>
      <div class="muted" style="margin-top:12px"><b>WOD</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ ${escapeHtml(item.label)}
‚Ä¢ Keep pace sustainable
      </div>`;
    return;
  }

  // Gym
  body.innerHTML = `
    <div class="muted"><b>Warm-up</b></div>
    <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ 3‚Äì5 min easy bike/row
‚Ä¢ 2 rounds: 10 band pull-aparts + 10 hinge + 10 air squats
    </div>
    <div class="muted" style="margin-top:12px"><b>Main</b></div>
    <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ ${escapeHtml(item.label)}
‚Ä¢ 4‚Äì6 exercises
    </div>
  `;
}
function closePlanDay(){
  document.getElementById("planWeekCard").style.display="block";
  document.getElementById("planDayCard").style.display="none";
}

/* =========================
GYM GENERATOR
========================= */
function pickGymExercises(muscles){
  const list=[];
  const set=new Set(muscles||[]);
  const has=(m)=>set.has(m);

  // Warm-up always
  const warm=warmupForMuscles(muscles);

  // Main lifts
  if(has("Quads")||has("Glutes")||has("Hamstrings")) list.push("Barbell Back Squat");
  if(has("Chest")||has("Triceps")||has("Shoulders")) list.push("Bench Press");
  if(has("Biceps")) list.push("Dumbbell Curl");
  if(has("Back")||has("Traps")) list.push("Lat Pulldown");
  if(has("Hamstrings")||has("Glutes")) list.push("Romanian Deadlift");

  // If nothing selected, default full body basics
  if(list.length===0){
    list.push("Barbell Back Squat","Bench Press","Lat Pulldown","Dumbbell Curl");
  }

  // Deduplicate and cap
  const uniq=[...new Set(list)].slice(0,6);

  // Build sets/reps
  const blocks=uniq.map(name=>{
    const base = name.includes("Squat")||name.includes("Deadlift")||name.includes("Bench") ? "4 x 5‚Äì8" : "3 x 10‚Äì12";
    const rest = name.includes("Squat")||name.includes("Deadlift") ? "Rest 2‚Äì3 min" : "Rest 60‚Äì90s";
    return {name, sets:base, rest};
  });

  return { warm, blocks };
}

function generateGymAndShowPost(){
  const muscles=[...new Set([...selectedFront, ...selectedBack])];
  const goal=document.getElementById("todayGoal").value || profile.goal;
  const custom=(document.getElementById("customGoal").value||"").trim();
  const pain=(document.getElementById("todayPain").value||"").trim();

  const g=pickGymExercises(muscles);

  // Coach note adapts to pain
  let coach="Keep it clean. Stop 1‚Äì2 reps before failure.";
  if(pain) coach=`Pain noted: "${pain}". Swap any painful movement. Keep range pain-free.`;

  const title = custom ? `Gym: ${custom}` : `Gym: ${niceGoal(goal)}`;
  const lines=[];
  lines.push("Warm-up:");
  g.warm.forEach(x=>lines.push("‚Ä¢ "+x));
  lines.push("");
  lines.push("Main:");
  g.blocks.forEach(b=>{
    lines.push(`‚Ä¢ ${b.name} ‚Äî ${b.sets} (${b.rest})`);
  });
  lines.push("");
  lines.push("Cool-down:");
  lines.push("‚Ä¢ 3‚Äì5 min easy walk + 2 min breathing");

  lastPostDraft={
    type:"Gym",
    title,
    text:lines.join("\n"),
    coachNote: coach,
    meta:{ goal, muscles, pain }
  };

  renderPostCard(lastPostDraft);
}

function renderPostCard(p){
  document.getElementById("postCard").style.display="block";
  document.getElementById("postTitle").textContent=p.title||"Workout";
  document.getElementById("postMeta").textContent=`${p.type} ‚Ä¢ ${new Date().toLocaleString()}`;
  document.getElementById("postBody").innerHTML = renderWorkoutTextWithExerciseLinks(p.text||"");
  window.scrollTo?.(0,0);
}
function hidePostCard(){
  document.getElementById("postCard").style.display="none";
}

/* Render workout text, turning known exercise names into clickable links */
function renderWorkoutTextWithExerciseLinks(text){
  const safe=escapeHtml(text).replaceAll("\n","<br>");
  // turn exercise names into clickable spans
  let out=safe;
  Object.keys(EX).forEach(name=>{
    // naive replace (works well enough for MVP)
    const esc = name.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const re = new RegExp(esc, "g");
    out = out.replace(re, `<span class="pill active" style="display:inline-flex; padding:6px 10px; margin:2px 0; cursor:pointer" onclick="openExercise('${name.replaceAll("'","\\'")}')">‚ñ∂ ${escapeHtml(name)}</span>`);
  });
  return `<div style="white-space:normal">${out}</div>`;
}

function postLastToFeed(){
  if(!lastPostDraft){ alert("Generate a workout first."); return; }

  // reflections
  const refl={
    effort: document.getElementById("reflectEffort").value || "",
    energy: document.getElementById("reflectEnergy").value || "",
    enjoy: document.getElementById("reflectEnjoy").value || ""
  };
  const caption=(document.getElementById("postCaption").value||"").trim();

  addFeedPost({
    ...lastPostDraft,
    text: (caption? (lastPostDraft.text + "\n\nCaption: " + caption) : lastPostDraft.text),
    privateReflection: refl
  });

  addHistory({
    type:lastPostDraft.type,
    title:lastPostDraft.title,
    sub:(lastPostDraft.type==="Cardio") ? (lastPostDraft.meta?.summary||"") : (lastPostDraft.meta?.goal?niceGoal(lastPostDraft.meta.goal):""),
    meta:lastPostDraft.meta||{}
  });

  updateStreakOnWorkoutPost();

  // reset post UI
  document.getElementById("reflectEffort").value="";
  document.getElementById("reflectEnergy").value="";
  document.getElementById("reflectEnjoy").value="";
  document.getElementById("postCaption").value="";
  hidePostCard();
  go("home");
}

/* =========================
CROSSFIT WOD
========================= */
function clearCrossFit(){
  document.getElementById("cfPain").value="";
  document.getElementById("cfPreview").innerHTML=`<div class="muted">Generate a WOD to preview it.</div>`;
  document.getElementById("cfPreviewTag").textContent="‚Äî";
}

function generateCrossFitAndShowPost(){
  const focus=document.getElementById("cfFocus").value;
  const time=Number(document.getElementById("cfTime").value||30);
  const equip=document.getElementById("cfEquip").value;
  const pain=(document.getElementById("cfPain").value||"").trim();

  const warm=[
    "4 min easy row/bike",
    "2 rounds: 10 air squats + 10 push-ups + 10 sit-ups",
    "Movement prep: 2 rounds light"
  ];

  const strength = focus==="strength"
    ? rand([
        "Back Squat 5 x 3 (build)",
        "Bench Press 5 x 5 (moderate)",
        "Deadlift 5 x 2 (heavy but clean)"
      ])
    : rand([
        "Skill: 10 min double-under practice",
        "Skill: 10 min handstand line drills",
        "Skill: 10 min strict pull-up sets"
      ]);

  const metcon = (()=>{
    const t = clamp(time-12, 8, 20);
    if(equip==="none"){
      return `${t} min AMRAP: 10 burpees + 20 air squats + 30 mountain climbers`;
    }
    if(equip==="basic"){
      return `${t} min AMRAP: 10 DB thrusters + 10 pull-ups + 200m run`;
    }
    return `${t} min AMRAP: 10 wall balls + 10 kettlebell swings + 10 box jumps`;
  })();

  const scaled = equip==="none"
    ? "Scaled: step-back burpees, reduce reps by 20%"
    : "Scaled: reduce load, swap jumps for step-ups";

  const cool=[
    "3 min easy walk",
    "2 min breathing: inhale 4s / exhale 6s",
    "Stretch hips + lats 2 min"
  ];

  let coach="Keep intensity sustainable. Smooth reps > redline.";
  if(pain) coach=`Pain noted: "${pain}". Scale aggressively. Avoid painful range.`;

  const title="WOD: "+(focus==="mixed"?"Mixed":(focus==="engine"?"Engine":"Strength"));
  const text=[
    "Warm-up:", ...warm.map(x=>"‚Ä¢ "+x),
    "",
    "Strength/Skill:", "‚Ä¢ "+strength,
    "",
    "Metcon:", "‚Ä¢ "+metcon,
    "",
    "RX/Scaled:", "‚Ä¢ "+scaled,
    "",
    "Cool-down:", ...cool.map(x=>"‚Ä¢ "+x)
  ].join("\n");

  lastPostDraft={ type:"WOD", title, text, coachNote:coach, meta:{ focus, time, equip, pain } };

  // preview
  document.getElementById("cfPreviewTag").textContent=`${time} min`;
  document.getElementById("cfPreview").innerHTML = `<div class="muted" style="white-space:pre-wrap">${escapeHtml(text)}</div>`;

  renderPostCard(lastPostDraft);
}

/* =========================
BADGES (simple)
========================= */
function badgeDefs(){
  return [
    {id:"b1", icon:"üî•", title:"Streak 3", sub:"Post 3 days in a row", check:()=>loadStreak().best>=3},
    {id:"b2", icon:"üß¨", title:"DNA Set", sub:"Do 3 workouts total", check:()=>loadHistory().length>=3},
    {id:"b3", icon:"üèÉ", title:"Cardio Day", sub:"Post 1 cardio", check:()=>loadHistory().some(x=>x.type==="Cardio")},
    {id:"b4", icon:"üèãÔ∏è", title:"Gym Day", sub:"Post 1 gym", check:()=>loadHistory().some(x=>x.type==="Gym")},
    {id:"b5", icon:"‚ö°", title:"WOD Day", sub:"Post 1 WOD", check:()=>loadHistory().some(x=>x.type==="WOD")},
    {id:"b6", icon:"ü•ó", title:"First Recipe", sub:"Post a recipe", check:()=>loadRecipes().length>=1}
  ];
}
function renderBadges(){
  const grid=document.getElementById("badgeGrid");
  if(!grid) return;
  const defs=badgeDefs();
  grid.innerHTML = defs.map(b=>{
    const on=!!b.check();
    return `
      <div class="badge" style="opacity:${on?1:0.55}">
        <div class="badgeIcon">${b.icon}</div>
        <div>
          <div class="badgeTitle">${escapeHtml(b.title)}</div>
          <div class="badgeSub">${escapeHtml(b.sub)}</div>
        </div>
      </div>
    `;
  }).join("");
}

/* =========================
CARDIO GPS
========================= */
let gpsWatchId=null;
let gpsMap=null;
let gpsLine=null;
let gpsPts=[];
let gpsStartTs=0;
let gpsPaused=false;
let gpsPauseAccum=0;
let gpsPauseStart=0;

function gpsEnsureMap(){
  if(gpsMap) return;
  const el=document.getElementById("gpsMap");
  if(!el) return;
  gpsMap=L.map(el, {zoomControl:false});
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19}).addTo(gpsMap);
  gpsMap.setView([59.3293,18.0686], 13); // default Stockholm-ish
  gpsLine=L.polyline([], {weight:4}).addTo(gpsMap);
  setTimeout(()=>gpsMap.invalidateSize(), 50);
}

function gpsStart(){
  gpsEnsureMap();
  if(!navigator.geolocation){
    alert("Geolocation not supported.");
    return;
  }
  gpsPts=[];
  gpsLine.setLatLngs([]);
  gpsStartTs=Date.now();
  gpsPaused=false;
  gpsPauseAccum=0;
  document.getElementById("gpsStatus").textContent="On";
  document.getElementById("gpsStartBtn").disabled=true;
  document.getElementById("gpsStopBtn").disabled=false;
  document.getElementById("gpsPauseBtn").disabled=false;
  document.getElementById("gpsPauseBtn").textContent="Pause";

  gpsWatchId=navigator.geolocation.watchPosition(pos=>{
    if(gpsPaused) return;
    const {latitude, longitude} = pos.coords;
    gpsPts.push([latitude,longitude, Date.now()]);
    gpsLine.setLatLngs(gpsPts.map(p=>[p[0],p[1]]));
    gpsMap.setView([latitude,longitude], 16);
    renderGpsStats();
  }, err=>{
    console.log(err);
    alert("GPS error: " + err.message);
    gpsStop(false);
  }, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});
}

function gpsTogglePause(){
  if(!gpsWatchId) return;
  gpsPaused=!gpsPaused;
  const btn=document.getElementById("gpsPauseBtn");
  if(gpsPaused){
    gpsPauseStart=Date.now();
    btn.textContent="Resume";
    document.getElementById("gpsStatus").textContent="Paused";
  }else{
    gpsPauseAccum += (Date.now()-gpsPauseStart);
    btn.textContent="Pause";
    document.getElementById("gpsStatus").textContent="On";
  }
  renderGpsStats();
}

function gpsStop(finish){
  if(gpsWatchId){
    navigator.geolocation.clearWatch(gpsWatchId);
    gpsWatchId=null;
  }
  document.getElementById("gpsStartBtn").disabled=false;
  document.getElementById("gpsStopBtn").disabled=true;
  document.getElementById("gpsPauseBtn").disabled=true;
  document.getElementById("gpsPauseBtn").textContent="Pause";
  document.getElementById("gpsStatus").textContent="Off";

  if(finish){
    // create cardio post
    const type=document.getElementById("cardioType").value;
    const caption=(document.getElementById("cardioCaption").value||"").trim();
    const distKm=gpsDistanceKm(gpsPts);
    const ms=elapsedMs();
    const minutes=Math.max(1, Math.round(ms/60000));
    const paceStr = distKm>0.05 ? paceString(ms, distKm) : "‚Äî";

    const title=`Cardio: ${type}`;
    const text = [
      `Type: ${type}`,
      `Distance: ${distKm.toFixed(2)} km`,
      `Time: ${formatTime(ms)}`,
      `Pace: ${paceStr}`,
      caption?`Caption: ${caption}`:""
    ].filter(Boolean).join("\n");

    lastPostDraft={
      type:"Cardio",
      title,
      text,
      coachNote:"Steady work counts. Keep it easy if recovery is needed.",
      gps:{ points:gpsPts, distKm, ms, paceStr },
      meta:{ type, minutes, summary:`${distKm.toFixed(2)} km ‚Ä¢ ${formatTime(ms)} ‚Ä¢ ${paceStr}` }
    };

    renderPostCard(lastPostDraft);
  }
}

function clearCardio(){
  document.getElementById("cardioCaption").value="";
  gpsPts=[];
  if(gpsLine) gpsLine.setLatLngs([]);
  document.getElementById("gpsStats").textContent="Distance: 0.00 km ‚Ä¢ Time: 0:00 ‚Ä¢ Pace: ‚Äî";
}

function elapsedMs(){
  if(!gpsStartTs) return 0;
  let ms=Date.now()-gpsStartTs-gpsPauseAccum;
  if(gpsPaused) ms -= (Date.now()-gpsPauseStart);
  return Math.max(0, ms);
}

function renderGpsStats(){
  const distKm=gpsDistanceKm(gpsPts);
  const ms=elapsedMs();
  const pace = distKm>0.05 ? paceString(ms, distKm) : "‚Äî";
  document.getElementById("gpsStats").textContent=`Distance: ${distKm.toFixed(2)} km ‚Ä¢ Time: ${formatTime(ms)} ‚Ä¢ Pace: ${pace}`;
}

function gpsDistanceKm(points){
  if(!points || points.length<2) return 0;
  let m=0;
  for(let i=1;i<points.length;i++){
    m += haversineMeters(points[i-1][0],points[i-1][1], points[i][0],points[i][1]);
  }
  return m/1000;
}
function haversineMeters(lat1,lon1,lat2,lon2){
  const R=6371000;
  const toRad=x=>x*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function formatTime(ms){
  const s=Math.floor(ms/1000);
  const m=Math.floor(s/60);
  const ss=String(s%60).padStart(2,"0");
  return `${m}:${ss}`;
}
function paceString(ms, distKm){
  const sec=ms/1000;
  const pace=sec/distKm; // sec per km
  const m=Math.floor(pace/60);
  const s=Math.round(pace%60);
  return `${m}:${String(s).padStart(2,"0")} /km`;
}

/* =========================
ROUTE MODAL (for feed)
========================= */
let routeModalEl=null;
let routeMap=null;
let routeLine=null;

function ensureRouteModal(){
  if(routeModalEl) return;
  routeModalEl=document.createElement("div");
  routeModalEl.className="modalBack";
  routeModalEl.id="routeModal";
  routeModalEl.innerHTML=`
    <div class="modal">
      <div class="modalHeader">
        <div>
          <b id="rmTitle">Route</b>
          <div class="muted" id="rmSub"></div>
        </div>
        <button class="xbtn" onclick="closeRouteModal()">X</button>
      </div>
      <div id="rmMap" style="height:320px; border-radius:16px; border:1px solid rgba(255,255,255,.10); overflow:hidden"></div>
    </div>
  `;
  document.body.appendChild(routeModalEl);
}
function openRouteModal(postId){
  const items=loadFeed();
  const p=items.find(x=>x.id===postId);
  if(!p || !p.gps || !p.gps.points || p.gps.points.length<2){
    alert("No route saved.");
    return;
  }
  ensureRouteModal();
  routeModalEl.style.display="block";

  document.getElementById("rmTitle").textContent = p.title || "Route";
  document.getElementById("rmSub").textContent = `${(p.gps.distKm||0).toFixed(2)} km ‚Ä¢ ${(p.gps.paceStr||"‚Äî")}`;

  // init map once
  if(!routeMap){
    routeMap=L.map("rmMap", {zoomControl:false});
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {maxZoom:19}).addTo(routeMap);
    routeLine=L.polyline([], {weight:4}).addTo(routeMap);
  }

  const latlngs=p.gps.points.map(pt=>[pt[0],pt[1]]);
  routeLine.setLatLngs(latlngs);
  routeMap.fitBounds(routeLine.getBounds(), {padding:[20,20]});
  setTimeout(()=>routeMap.invalidateSize(), 50);
}
function closeRouteModal(){
  if(routeModalEl) routeModalEl.style.display="none";
}

/* =========================
POST CARD CLOSE
========================= */
function hidePostCard(){ document.getElementById("postCard").style.display="none"; }

/* =========================
INIT
========================= */
function initLocal(){
  // profile
  profile = loadProfile() || defaultProfile();
  saveProfileLS();

  // notifs
  loadNotifs();
  mountNotifUI();
  renderNotifUI();

  // plan
  if(!loadPlan()) generatePlan(true);

  // dna/streak badges
  renderStreakUI();
  updateDNAFromData();
  renderBadges();

  // home
  renderHomeHeader();
  renderWeeklyRecap();
  renderHomeCoachNote();
  renderFeed();
  renderRecipes();

  // reminders
  schedulePlanReminder();

  // default create mode
  setCreateMode("gym");
}

window.addEventListener("load", ()=>{
  initLocal();

  // close exercise modal by background click
  document.getElementById("exerciseModal").addEventListener("click",(e)=>{
    if(e.target && e.target.id==="exerciseModal") closeExercise();
  });
});

/* =========================
HOOK ESC to close modals
========================= */
document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    closeExercise();
    closeRouteModal();
    closeNotifPanel();
  }
});
/* =========================
PATCH A ‚Äî Better Gym Workouts (5‚Äì8 exercises)
Safe override: no risky template onclick injection
========================= */

(function(){
  const UPPER = new Set(["Chest","Back","Shoulders","Biceps","Triceps","Traps"]);
  const LOWER = new Set(["Quads","Glutes","Hamstrings","Calves"]);
  const CORE  = new Set(["Core"]);

  function countHits(muscles, set){
    let n=0;
    (muscles||[]).forEach(m=>{ if(set.has(m)) n++; });
    return n;
  }

  function pickFrom(arr, used){
    const options = arr.filter(x=>!used.has(x));
    if(!options.length) return null;
    return options[Math.floor(Math.random()*options.length)];
  }

  function buildGymBlocks(muscles, goal, painText){
    const used = new Set();
    const blocks = [];

    // Pools (use exercises you already have in EX so clicking works)
    const mainLower = ["Barbell Back Squat","Romanian Deadlift"];
    const mainUpper = ["Bench Press","Lat Pulldown"];
    const accUpperPush = ["Bench Press"]; // keep it simple & safe with existing EX
    const accUpperPull = ["Lat Pulldown"];
    const accArms = ["Dumbbell Curl"];
    const finishers = ["Kettlebell Swing"];

    const upperCount = countHits(muscles, UPPER);
    const lowerCount = countHits(muscles, LOWER);
    const focus =
      (upperCount>0 && lowerCount===0) ? "upper" :
      (lowerCount>0 && upperCount===0) ? "lower" : "full";

    // Goal ‚Üí rep schemes
    const scheme = (()=>{
      if(goal==="strong") return {main:"5 x 3‚Äì5", sec:"4 x 5‚Äì8", acc:"3 x 8‚Äì12", core:"3 x 30‚Äì45s"};
      if(goal==="cut" || goal==="sixpack") return {main:"4 x 6‚Äì10", sec:"3 x 8‚Äì12", acc:"2‚Äì3 x 12‚Äì15", core:"4 x 10‚Äì15"};
      return {main:"4 x 6‚Äì10", sec:"3 x 8‚Äì12", acc:"3 x 10‚Äì15", core:"3 x 10‚Äì15"};
    })();

    const rest = (type)=>{
      if(type==="main") return "Rest 2‚Äì3 min";
      if(type==="sec") return "Rest 90‚Äì120s";
      if(type==="acc") return "Rest 60‚Äì90s";
      return "Rest 45‚Äì60s";
    };

    // MAIN 1 (always)
    if(focus==="lower"){
      const ex = pickFrom(mainLower, used) || "Barbell Back Squat";
      used.add(ex);
      blocks.push({name:ex, sets:scheme.main, rest:rest("main")});
    }else if(focus==="upper"){
      const ex = pickFrom(mainUpper, used) || "Bench Press";
      used.add(ex);
      blocks.push({name:ex, sets:scheme.main, rest:rest("main")});
    }else{
      // full body: pick one lower OR one upper main
      const ex = (Math.random()<0.5 ? pickFrom(mainLower, used) : pickFrom(mainUpper, used)) || "Barbell Back Squat";
      used.add(ex);
      blocks.push({name:ex, sets:scheme.main, rest:rest("main")});
    }

    // SECONDARY (complement)
    if(focus==="lower"){
      const ex = pickFrom(mainUpper, used) || "Bench Press";
      used.add(ex);
      blocks.push({name:ex, sets:scheme.sec, rest:rest("sec")});
    }else if(focus==="upper"){
      const ex = pickFrom(mainLower, used) || "Romanian Deadlift";
      used.add(ex);
      blocks.push({name:ex, sets:scheme.sec, rest:rest("sec")});
    }else{
      // full body: add the opposite category
      const wantUpper = blocks[0].name==="Barbell Back Squat" || blocks[0].name==="Romanian Deadlift";
      const ex = wantUpper ? (pickFrom(mainUpper, used) || "Bench Press") : (pickFrom(mainLower, used) || "Barbell Back Squat");
      used.add(ex);
      blocks.push({name:ex, sets:scheme.sec, rest:rest("sec")});
    }

    // ACCESSORIES (2‚Äì3)
    // add a pull
    {
      const ex = pickFrom(accUpperPull, used) || pickFrom(mainUpper, used) || "Lat Pulldown";
      if(ex){ used.add(ex); blocks.push({name:ex, sets:scheme.acc, rest:rest("acc")}); }
    }
    // add an arms move
    {
      const ex = pickFrom(accArms, used) || "Dumbbell Curl";
      if(ex){ used.add(ex); blocks.push({name:ex, sets:scheme.acc, rest:rest("acc")}); }
    }
    // optional extra accessory if we still have <6 blocks
    if(blocks.length < 6){
      const ex = pickFrom(accUpperPush, used);
      if(ex){ used.add(ex); blocks.push({name:ex, sets:scheme.acc, rest:rest("acc")}); }
    }

    // CORE (always) ‚Äî use a simple non-clickable line (since EX doesn‚Äôt have core demos yet)
    blocks.push({name:"Core: Dead-bug / Plank", sets:scheme.core, rest:rest("core")});

    // FINISHER (optional for cut/sixpack)
    if(goal==="cut" || goal==="sixpack"){
      blocks.push({name:"Finisher: Kettlebell Swing", sets:"8‚Äì12 min intervals (smooth reps)", rest:"‚Äî"});
    }

    // cap 8
    return blocks.slice(0,8);
  }

  // OVERRIDE #1
  window.pickGymExercises = function(muscles){
    const goal = (document.getElementById("todayGoal")?.value || window.profile?.goal || "muscle");
    const pain = (document.getElementById("todayPain")?.value || "").trim();

    const warm = warmupForMuscles(muscles);
    const blocks = buildGymBlocks(muscles||[], goal, pain);

    return { warm, blocks };
  };

  // OVERRIDE #2
  window.generateGymAndShowPost = function(){
    const muscles=[...new Set([...(window.selectedFront||[]), ...(window.selectedBack||[])])];
    const goal=document.getElementById("todayGoal")?.value || window.profile?.goal || "muscle";
    const custom=(document.getElementById("customGoal")?.value || "").trim();
    const pain=(document.getElementById("todayPain")?.value || "").trim();

    const g = window.pickGymExercises(muscles);

    const title = custom ? `Gym: ${custom}` : `Gym: ${niceGoal(goal)}`;
    const lines=[];
    lines.push("Warm-up:");
    g.warm.forEach(x=>lines.push("‚Ä¢ "+x));
    lines.push("");
    lines.push("Main + Accessories:");
    g.blocks.forEach(b=>{
      // If it's a named exercise from EX, keep it clean so your existing renderer makes it clickable
      lines.push(`‚Ä¢ ${b.name} ‚Äî ${b.sets} (${b.rest})`);
    });
    lines.push("");
    lines.push("Cool-down:");
    lines.push("‚Ä¢ 3‚Äì5 min easy walk + 2 min breathing");

    let coach="Keep form clean. Stop 1‚Äì2 reps before failure on most sets.";
    if(pain) coach=`Pain noted: "${pain}". Swap any painful movement. Keep range pain-free.`;

    window.lastPostDraft={
      type:"Gym",
      title,
      text:lines.join("\n"),
      coachNote: coach,
      meta:{ goal, muscles, pain }
    };

    window.renderPostCard(window.lastPostDraft);
  };

  // Small quality: if user has 0 muscles selected, make default full-body
  const _oldClearSelection = window.clearSelection;
  window.clearSelection = function(){
    if(typeof _oldClearSelection==="function") _oldClearSelection();
    // nothing else
  };
})();
// PWA offline support
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}

</script>
</body>
</html>

