<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>KRYPTA</title>

<style>
  :root{
    --bg:#07080b;
    --card:rgba(255,255,255,.06);
    --card2:rgba(255,255,255,.09);
    --stroke:rgba(255,255,255,.12);
    --text:rgba(245,247,255,.95);
    --muted:rgba(245,247,255,.65);
    --accent:#9b7bff;
    --repDur:1800ms;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    overflow:hidden; /* app handles scrolling */
  }

  /* background that never steals clicks */
  .bg{
    position:fixed; inset:0;
    background:
      radial-gradient(900px 600px at 30% 10%, rgba(155,123,255,.18), transparent 60%),
      radial-gradient(700px 500px at 80% 40%, rgba(120,210,255,.10), transparent 55%),
      radial-gradient(800px 600px at 40% 90%, rgba(255,255,255,.06), transparent 60%),
      linear-gradient(180deg, #05060a, #0a0b10);
    pointer-events:none;
    z-index:0;
  }

  .app{
    position:relative;
    height:100vh;
    display:flex;
    flex-direction:column;
    z-index:1;
  }

  /* Topbar / Tabs */
  .topbar{
    padding:14px 14px 10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    border-bottom:1px solid var(--stroke);
    background:rgba(0,0,0,.25);
    backdrop-filter: blur(10px);
  }
  .brand{
    display:flex; flex-direction:column; gap:6px;
  }
  .brandRow{
    display:flex; align-items:center; gap:10px;
  }
  .bear{
    width:30px; height:30px; border-radius:10px;
    display:grid; place-items:center;
    background:rgba(255,255,255,.06);
    border:1px solid var(--stroke);
    flex:0 0 auto;
  }
  .bear svg{ width:20px; height:20px; opacity:.95; }
  h1{ margin:0; font-size:16px; letter-spacing:.12em; }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.04);
    font-size:12px;
    color:var(--muted);
    width:fit-content;
  }
  .chip strong{ color:var(--text); font-weight:900; }

  .topRight{
    display:flex; align-items:center; gap:10px;
  }
  .cornerBtn{
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.06);
    color:var(--text);
    padding:8px 10px;
    border-radius:12px;
    font-weight:800;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .cornerBtn:active{ transform:scale(.98); }

  .tabs{
    display:flex;
    gap:8px;
    padding:10px 10px 8px;
    border-bottom:1px solid var(--stroke);
    background:rgba(0,0,0,.12);
    overflow:auto;
    -webkit-overflow-scrolling: touch;
  }
  .tab{
    padding:10px 12px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.04);
    font-weight:900;
    font-size:13px;
    cursor:pointer;
    white-space:nowrap;
    color:var(--muted);
    user-select:none;
    -webkit-tap-highlight-color: transparent;
  }
  .tab.active{
    color:var(--text);
    background:rgba(155,123,255,.15);
    border-color:rgba(155,123,255,.35);
  }

  /* Scroll container that actually scrolls (and allows taps) */
  .pages{
    flex:1;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    padding:14px;
    touch-action: pan-y;
  }

  /* Cards / UI */
  .card{
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.04);
    border-radius:18px;
    padding:14px;
    box-shadow: 0 20px 50px rgba(0,0,0,.35);
  }
  .row{ display:flex; gap:12px; flex-wrap:wrap; }
  .muted{ color:var(--muted); font-size:13px; line-height:1.35; }
  .title{
    font-size:18px;
    font-weight:1000;
    margin:0 0 8px;
  }

  .btn{
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.06);
    color:var(--text);
    padding:10px 12px;
    border-radius:14px;
    font-weight:900;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .btn.primary{
    background:rgba(155,123,255,.18);
    border-color:rgba(155,123,255,.35);
  }
  .btn:active{ transform:scale(.98); }

  input, select, textarea{
    width:100%;
    background:rgba(255,255,255,.06);
    border:1px solid var(--stroke);
    color:var(--text);
    border-radius:14px;
    padding:12px;
    outline:none;
    font-weight:800;
  }
  textarea{ min-height:90px; resize:vertical; }

  .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
  @media (max-width:720px){
    .grid2,.grid3{ grid-template-columns:1fr; }
  }

  /* Lists / posts */
  .post{
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.04);
    border-radius:18px;
    padding:14px;
    margin-top:12px;
  }
  .postTop{
    display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
  }
  .avatar{
    width:34px; height:34px; border-radius:12px;
    display:grid; place-items:center;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.06);
    font-weight:1000;
  }
  .userRow{ display:flex; gap:10px; align-items:center; }
  .tag{
    display:inline-flex;
    align-items:center;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.05);
    color:var(--muted);
    font-size:12px;
    font-weight:900;
    white-space:nowrap;
  }
  .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .smallBtn{
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.05);
    color:var(--text);
    padding:8px 10px;
    border-radius:12px;
    cursor:pointer;
    font-weight:900;
    -webkit-tap-highlight-color: transparent;
  }
  .likeBtn.active{ background:rgba(255,90,140,.14); border-color:rgba(255,90,140,.26); }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:8px 10px;
    border-radius:999px;
    border:1px solid rgba(155,123,255,.35);
    background:rgba(155,123,255,.15);
    color:var(--text);
    font-weight:900;
    cursor:pointer;
    user-select:none;
  }

  /* ===== Splash + Onboarding (this was breaking your taps before) ===== */
  .splash{
    position:fixed; inset:0;
    display:grid;
    place-items:center;
    background:#000;
    z-index:99999;
  }
  .splash.hidden{ display:none; pointer-events:none; }
  .splash .logoWrap{
    display:grid; place-items:center; gap:14px;
    text-align:center;
  }
  .splash .logoWrap .bear{
    width:78px; height:78px;
    border-radius:24px;
    background:rgba(255,255,255,.06);
    border:1px solid rgba(255,255,255,.18);
  }
  .splash .sub{ color:rgba(255,255,255,.65); font-weight:800; }

  .onbOverlay{
    position:fixed; inset:0;
    z-index:99998;
    background:rgba(0,0,0,.72);
    backdrop-filter: blur(10px);
    display:none;
    padding:18px;
  }
  .onbOverlay.show{ display:block; }
  .onbBox{
    max-width:520px;
    margin:0 auto;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.05);
    border-radius:22px;
    padding:16px;
    box-shadow: 0 40px 90px rgba(0,0,0,.55);
  }
  .onbSteps{ margin-top:10px; }
  .onbFooter{ display:flex; gap:10px; justify-content:space-between; margin-top:12px; }
  .onbFooter .left{ display:flex; gap:10px; }
  .progressDots{ display:flex; gap:6px; margin-top:10px; }
  .dot{ width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.18); }
  .dot.on{ background:rgba(155,123,255,.9); }

  /* ===== Modals ===== */
  .modalBack{
    position:fixed; inset:0;
    display:none;
    z-index:99997;
    background:rgba(0,0,0,.62);
    backdrop-filter: blur(10px);
    padding:18px;
  }
  .modalBack.show{ display:block; }
  .modal{
    max-width:820px;
    margin:0 auto;
    border-radius:22px;
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.05);
    padding:14px;
  }
  .modalHeader{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    margin-bottom:10px;
  }
  .xbtn{
    border:1px solid var(--stroke);
    background:rgba(255,255,255,.05);
    color:var(--text);
    padding:8px 10px;
    border-radius:12px;
    cursor:pointer;
    font-weight:1000;
  }

  .exSvg{ width:100%; height:auto; border-radius:18px; border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.20); }
  .exPlay .rep{ animation-duration: var(--repDur); animation-iteration-count: infinite; animation-timing-function: ease-in-out; }
  /* squat */
  .squatBar{ animation-name: squatBar; }
  .squatHip{ animation-name: squatHip; }
  .squatTorso{ animation-name: squatTorso; }
  @keyframes squatBar{ 0%,100%{ transform:translateY(0); } 50%{ transform:translateY(70px); } }
  @keyframes squatHip{ 0%,100%{ transform:translateY(0); } 50%{ transform:translateY(55px); } }
  @keyframes squatTorso{ 0%,100%{ transform:rotate(0deg); } 50%{ transform:rotate(10deg); } }
  /* bench */
  .benchBar{ animation-name: benchBar; }
  @keyframes benchBar{ 0%,100%{ transform:translateY(0); } 50%{ transform:translateY(55px); } }
  /* curl */
  .curlForeL,.curlForeR{ animation-name: curl; }
  .curlDbL,.curlDbR{ animation-name: curlDb; }
  @keyframes curl{ 0%,100%{ transform:rotate(0deg); } 50%{ transform:rotate(-40deg); } }
  @keyframes curlDb{ 0%,100%{ transform:translateY(0); } 50%{ transform:translateY(-40px); } }
  /* kb swing */
  .kbSwingTorso{ animation-name: kbTorso; }
  .kbSwingArms{ animation-name: kbArms; }
  .kbSwingKB{ animation-name: kbKB; }
  @keyframes kbTorso{ 0%,100%{ transform:rotate(0deg) translateY(0); } 50%{ transform:rotate(14deg) translateY(8px);} }
  @keyframes kbArms{ 0%,100%{ transform:rotate(0deg); } 50%{ transform:rotate(-18deg);} }
  @keyframes kbKB{ 0%,100%{ transform:translateY(0);} 50%{ transform:translateY(-75px);} }

  /* Notifications */
  .notifWrap{ position:relative; }
  .notifBtn{ border:1px solid var(--stroke); background:rgba(255,255,255,.06); color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; font-weight:1000; }
  .notifCount{
    position:absolute;
    top:-6px; right:-6px;
    min-width:18px; height:18px;
    padding:0 6px;
    border-radius:999px;
    background:rgba(255,70,120,.95);
    color:#fff;
    font-size:12px;
    font-weight:1000;
    display:none;
    align-items:center; justify-content:center;
    border:2px solid rgba(0,0,0,.45);
  }
  .notifPanel{
    position:absolute;
    right:0;
    top:42px;
    width:320px;
    border-radius:18px;
    border:1px solid var(--stroke);
    background:rgba(10,10,14,.94);
    display:none;
    overflow:hidden;
    box-shadow:0 30px 70px rgba(0,0,0,.6);
  }
  .notifHead{ padding:10px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,.10); }
  .notifActions{ display:flex; gap:8px; }
  .nChip{ border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.05); color:var(--text); padding:6px 8px; border-radius:10px; font-weight:900; cursor:pointer; }
  .notifList{ max-height:360px; overflow:auto; }
  .notifItem{ display:flex; gap:10px; padding:10px; border-bottom:1px solid rgba(255,255,255,.06); cursor:pointer; }
  .notifItem.unread{ background:rgba(155,123,255,.10); }
  .notifIcon{ width:26px; height:26px; display:grid; place-items:center; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); }
  .notifT{ font-weight:1000; font-size:13px; }
  .notifS{ color:rgba(245,247,255,.65); font-size:12px; margin-top:2px; }
  .notifMeta{ margin-left:auto; color:rgba(245,247,255,.55); font-size:11px; white-space:nowrap; }

  /* Small toast for errors */
  .toast{
    position:fixed;
    left:12px; right:12px; bottom:14px;
    z-index:999999;
    display:none;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background:rgba(10,10,14,.92);
    padding:10px 12px;
    box-shadow:0 30px 70px rgba(0,0,0,.6);
  }
  .toast.show{ display:block; }
  .toast b{ font-weight:1000; }
  .toast .muted{ margin-top:4px; }
</style>
</head>

<body>
<div class="bg"></div>

<!-- SPLASH -->
<div class="splash" id="splash">
  <div class="logoWrap">
    <div class="bear">
      <!-- inline bear -->
      <svg viewBox="0 0 64 64" fill="none">
        <path d="M18 28c0-10 7-16 14-16s14 6 14 16v14c0 8-7 14-14 14s-14-6-14-14V28Z" stroke="rgba(245,247,255,.9)" stroke-width="4" opacity=".9"/>
        <path d="M20 20c-4 0-8-3-8-8 0-4 3-7 7-7 5 0 9 4 9 9" stroke="rgba(245,247,255,.8)" stroke-width="4" opacity=".7"/>
        <path d="M44 20c0-5 4-9 9-9 4 0 7 3 7 7 0 5-4 8-8 8" stroke="rgba(245,247,255,.8)" stroke-width="4" opacity=".7"/>
        <path d="M26 34c0-2 2-4 6-4s6 2 6 4-2 4-6 4-6-2-6-4Z" fill="rgba(155,123,255,.55)"/>
        <path d="M24 42c4 3 12 3 16 0" stroke="rgba(245,247,255,.75)" stroke-width="4" stroke-linecap="round"/>
      </svg>
    </div>
    <div>
      <div style="font-weight:1100; font-size:18px; letter-spacing:.16em;">KRYPTA</div>
      <div class="sub">the strava of lifting</div>
    </div>
  </div>
</div>

<!-- ONBOARDING -->
<div class="onbOverlay" id="onbOverlay">
  <div class="onbBox">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
      <div>
        <div style="font-weight:1100; font-size:18px;">Welcome to Krypta</div>
        <div class="muted" id="onbSub">Let‚Äôs set up your profile.</div>
      </div>
      <button class="xbtn" id="onbCloseBtn" type="button">X</button>
    </div>

    <div class="progressDots" id="onbDots"></div>

    <div class="onbSteps" id="onbSteps"></div>

    <div class="onbFooter">
      <div class="left">
        <button class="btn" id="onbBackBtn" type="button">Back</button>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn" id="onbNextBtn" type="button">Next</button>
        <button class="btn primary" id="onbFinishBtn" type="button" style="display:none;">Finish</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast">
  <b id="toastTitle">Notice</b>
  <div class="muted" id="toastMsg"></div>
</div>

<div class="app">
  <div class="topbar">
    <div class="brand">
      <div class="brandRow">
        <div class="bear" title="Krypta">
          <svg viewBox="0 0 64 64" fill="none">
            <path d="M18 28c0-10 7-16 14-16s14 6 14 16v14c0 8-7 14-14 14s-14-6-14-14V28Z" stroke="rgba(245,247,255,.9)" stroke-width="4" opacity=".9"/>
            <path d="M26 34c0-2 2-4 6-4s6 2 6 4-2 4-6 4-6-2-6-4Z" fill="rgba(155,123,255,.55)"/>
          </svg>
        </div>
        <h1>KRYPTA</h1>
      </div>
      <div class="chip">
        <span>Local demo</span>
        <span style="opacity:.5">‚Ä¢</span>
        <span>Streak</span><strong id="streakChip">0</strong>
        <span style="opacity:.5">‚Ä¢</span>
        <span>DNA</span><strong id="dnaChip">‚Äî</strong>
      </div>
    </div>

    <div class="topRight" id="topRightActions">
      <button class="cornerBtn" type="button" id="btnProfile">Profile</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" id="tabHome">Home</div>
    <div class="tab" id="tabPlan">Plan</div>
    <div class="tab" id="tabCreate">Create</div>
    <div class="tab" id="tabRecipes">Recipes</div>
    <div class="tab" id="tabHistory">History</div>
  </div>

  <div class="pages" id="pages">

    <!-- HOME -->
    <section id="page_home">
      <div class="card">
        <div class="title">Today</div>
        <div id="homeSummary" class="muted"></div>
        <div style="margin-top:10px" class="muted" id="coachNoteHome"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:1000">Weekly recap</div>
            <div class="muted" id="weeklyRecap"></div>
          </div>
          <div>
            <div style="font-weight:1000">Recovery</div>
            <div class="muted" id="recoveryScore"></div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Your feed (local)</div>
        <div class="muted">Post workouts from Create and they show here.</div>
        <div id="feedList"></div>
      </div>
    </section>

    <!-- PLAN -->
    <section id="page_plan" style="display:none">
      <div class="card" id="planWeekCard">
        <div class="title">Weekly plan</div>
        <div class="muted">Tap a day to open details.</div>
        <div id="planList" style="margin-top:10px"></div>
        <div class="btnRow" style="margin-top:12px">
          <button class="btn" type="button" id="regenPlanBtn">Regenerate plan</button>
        </div>
      </div>

      <div class="card" id="planDayCard" style="display:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="title" id="planDayTitle">Monday</div>
            <div class="muted" id="planDaySub"></div>
          </div>
          <div class="tag" id="planDayTag">Gym</div>
        </div>
        <div id="planDayBody" style="margin-top:12px"></div>
        <div class="btnRow" style="margin-top:12px">
          <button class="btn" type="button" id="closePlanDayBtn">Back</button>
        </div>
      </div>
    </section>

    <!-- CREATE -->
    <section id="page_create" style="display:none">
      <div class="card">
        <div class="title">Create workout</div>
        <div class="muted">Generate a Gym session and click exercises for animations.</div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <div class="muted" style="margin-bottom:6px">Today‚Äôs goal</div>
            <select id="todayGoal">
              <option value="muscle">Build muscle</option>
              <option value="strong">Get stronger</option>
              <option value="cut">Cut / lean</option>
              <option value="sixpack">Sixpack focus</option>
            </select>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Pain / injury note (optional)</div>
            <input id="todayPain" placeholder="e.g. knee pain, shoulder tight"/>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Custom title (optional)</div>
          <input id="customGoal" placeholder="e.g. Upper pump, Leg day PR"/>
        </div>

        <div class="btnRow" style="margin-top:12px">
          <button class="btn primary" type="button" id="genGymBtn">Generate Gym Workout</button>
          <button class="btn" type="button" id="postFeedBtn">Post to feed</button>
        </div>
      </div>

      <div class="card" id="postCard" style="margin-top:12px; display:none">
        <div class="row" style="justify-content:space-between; align-items:flex-start;">
          <div>
            <div class="title" id="postTitle">Workout</div>
            <div class="muted" id="postMeta"></div>
          </div>
          <div class="tag" id="postTag">Preview</div>
        </div>
        <div id="postBody" style="margin-top:10px"></div>

        <div style="margin-top:12px" class="grid3">
          <div>
            <div class="muted" style="margin-bottom:6px">Effort</div>
            <select id="reflectEffort">
              <option value="">‚Äî</option>
              <option>Easy</option><option>Moderate</option><option>Hard</option>
            </select>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Energy</div>
            <select id="reflectEnergy">
              <option value="">‚Äî</option>
              <option>Low</option><option>Normal</option><option>High</option>
            </select>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Enjoy</div>
            <select id="reflectEnjoy">
              <option value="">‚Äî</option>
              <option>Meh</option><option>Good</option><option>Amazing</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Caption (optional)</div>
          <input id="postCaption" placeholder="Write something..."/>
        </div>

        <div class="muted" style="margin-top:10px" id="coachNoteBox"></div>
      </div>
    </section>

    <!-- RECIPES -->
    <section id="page_recipes" style="display:none">
      <div class="card">
        <div class="title">Recipes (local)</div>
        <div class="muted">Simple MVP recipe posting.</div>
        <div class="grid2" style="margin-top:12px">
          <div>
            <div class="muted" style="margin-bottom:6px">Name</div>
            <input id="rName" placeholder="Protein oats"/>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Type</div>
            <select id="rType">
              <option>Cut</option><option>Muscle</option><option>Balanced</option>
            </select>
          </div>
        </div>
        <div class="grid2" style="margin-top:10px">
          <div>
            <div class="muted" style="margin-bottom:6px">Calories</div>
            <input id="rCals" placeholder="500"/>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Protein (g)</div>
            <input id="rProt" placeholder="40"/>
          </div>
        </div>
        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Ingredients</div>
          <textarea id="rIngr" placeholder="Oats&#10;Protein powder&#10;Milk"></textarea>
        </div>
        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Steps</div>
          <textarea id="rSteps" placeholder="Mix&#10;Heat&#10;Eat"></textarea>
        </div>
        <div class="btnRow" style="margin-top:12px">
          <button class="btn primary" type="button" id="postRecipeBtn">Post recipe</button>
        </div>
      </div>
      <div id="recipeList"></div>
    </section>

    <!-- HISTORY -->
    <section id="page_history" style="display:none">
      <div class="card">
        <div class="title">History</div>
        <div class="muted">Saved posts (local).</div>
        <div class="btnRow" style="margin-top:12px">
          <button class="btn" type="button" id="clearHistoryBtn">Clear history</button>
          <button class="btn" type="button" id="resetAllBtn">Reset all</button>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title">Badges</div>
        <div id="badgeGrid" class="row"></div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="title">Saved workouts</div>
        <div id="historyList"></div>
      </div>
    </section>

    <!-- PROFILE -->
    <section id="page_profile" style="display:none">
      <div class="card">
        <div class="title">Profile</div>
        <div class="muted">This is local demo data (saved in your browser).</div>

        <div class="grid2" style="margin-top:12px">
          <div>
            <div class="muted" style="margin-bottom:6px">Display name</div>
            <input id="displayName"/>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Gender</div>
            <select id="gender">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>

        <div class="grid3" style="margin-top:10px">
          <div><div class="muted" style="margin-bottom:6px">Height (cm)</div><input id="heightCm"/></div>
          <div><div class="muted" style="margin-bottom:6px">Weight (kg)</div><input id="weightKg"/></div>
          <div><div class="muted" style="margin-bottom:6px">Age</div><input id="age"/></div>
        </div>

        <div class="grid2" style="margin-top:10px">
          <div>
            <div class="muted" style="margin-bottom:6px">Activity</div>
            <select id="activity">
              <option value="low">Low</option>
              <option value="moderate">Moderate</option>
              <option value="high">High</option>
            </select>
          </div>
          <div>
            <div class="muted" style="margin-bottom:6px">Goal</div>
            <select id="goal">
              <option value="muscle">Build muscle</option>
              <option value="strong">Get stronger</option>
              <option value="cut">Cut</option>
              <option value="sixpack">Sixpack</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Days per week</div>
          <select id="days">
            <option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option>
          </select>
        </div>

        <div class="btnRow" style="margin-top:12px">
          <button class="btn primary" type="button" id="saveProfileBtn">Save</button>
          <button class="btn" type="button" id="backHomeBtn">Back</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Workout DNA</div>
        <div style="font-weight:1000" id="dnaStyle">‚Äî</div>
        <div class="muted" id="dnaExplain"></div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="title">Streak</div>
        <div class="muted">Current: <b id="streakCurrent">0</b> ‚Ä¢ Best: <b id="streakBest">0</b> ‚Ä¢ Last: <b id="streakLast">‚Äî</b></div>
      </div>
    </section>
  </div>
</div>

<!-- Exercise modal -->
<div class="modalBack" id="exerciseModal">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHeader">
      <div>
        <div style="font-weight:1100; font-size:18px;" id="exTitle">Exercise</div>
        <div class="muted" id="exMuscles"></div>
        <div class="muted" id="exCue" style="margin-top:6px"></div>
      </div>
      <button class="xbtn" type="button" id="exCloseBtn">X</button>
    </div>

    <div id="exPic"></div>

    <div class="row" style="margin-top:10px; justify-content:space-between;">
      <button class="btn" type="button" id="exPlayBtn">‚è∏ Pause</button>
      <div style="display:flex; gap:10px;">
        <button class="btn" type="button" id="exSpeedSlow">Slow</button>
        <button class="btn primary" type="button" id="exSpeedMid">Normal</button>
        <button class="btn" type="button" id="exSpeedFast">Fast</button>
      </div>
    </div>

    <div style="margin-top:12px">
      <div style="font-weight:1000">How</div>
      <div class="muted" id="exHow"></div>
      <div style="font-weight:1000; margin-top:10px">Tips</div>
      <ul class="muted" id="exTips"></ul>
    </div>
  </div>
</div>

<script>
/* =========================
CORE STORAGE
========================= */
const LS_PROFILE="krypta_profile";
const LS_HISTORY="krypta_history";
const LS_FEED="krypta_feed";
const LS_STREAK="krypta_streak";
const LS_DNA="krypta_dna";
const LS_PLAN="krypta_plan";
const LS_NOTIFS="krypta_notifs";
const LS_RECIPES="krypta_recipes";
const LS_ONB="krypta_onb_done";

const weekDays=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];

function toast(title,msg){
  const t=document.getElementById("toast");
  document.getElementById("toastTitle").textContent=title||"Notice";
  document.getElementById("toastMsg").textContent=msg||"";
  t.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT=setTimeout(()=>t.classList.remove("show"), 4200);
}

window.addEventListener("error",(e)=>{
  console.log(e.error||e.message);
  toast("Script error", String(e.message||"Something broke. Check console."));
});

function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");
}
function isoDateLocal(d){
  const x=new Date(d.getFullYear(),d.getMonth(),d.getDate(),12,0,0,0);
  return x.toISOString().slice(0,10);
}
function daysBetween(aISO,bISO){
  const a=new Date(aISO+"T12:00:00Z").getTime();
  const b=new Date(bISO+"T12:00:00Z").getTime();
  return Math.round((b-a)/86400000);
}
function timeAgo(ts){
  const s=Math.max(1, Math.floor((Date.now()-ts)/1000));
  if(s<60) return s+"s";
  const m=Math.floor(s/60);
  if(m<60) return m+"m";
  const h=Math.floor(m/60);
  if(h<24) return h+"h";
  return Math.floor(h/24)+"d";
}
function niceGoal(g){
  if(g==="muscle") return "Build muscle";
  if(g==="strong") return "Get stronger";
  if(g==="cut") return "Cut / lean";
  if(g==="sixpack") return "Sixpack focus";
  return "Training";
}
function niceActivity(a){
  if(a==="low") return "low activity";
  if(a==="high") return "high activity";
  return "moderate activity";
}

/* =========================
DEFAULTS
========================= */
function defaultProfile(){
  return {
    email:"",
    displayName:"KryptaUser",
    username:"",
    gender:"male",
    heightCm:180,
    weightKg:80,
    age:20,
    activity:"moderate",
    goal:"muscle",
    days:4,
    injuries:[]
  };
}
function loadProfile(){
  try{ return JSON.parse(localStorage.getItem(LS_PROFILE)||"null"); }catch{ return null; }
}
function saveProfileLS(){ localStorage.setItem(LS_PROFILE, JSON.stringify(profile)); }

/* =========================
NAV
========================= */
let currentPage="home";
function showPage(name){
  currentPage=name;
  ["home","plan","create","recipes","history","profile"].forEach(p=>{
    const el=document.getElementById("page_"+p);
    if(el) el.style.display = (p===name) ? "block" : "none";
  });
  ["Home","Plan","Create","Recipes","History"].forEach(k=>{
    const id="tab"+k;
    const el=document.getElementById(id);
    if(el) el.classList.toggle("active", k.toLowerCase()===name);
  });
  if(name==="profile") fillProfileUI();
  if(name==="history"){ renderHistory(); renderBadges(); }
  if(name==="plan"){ renderPlan(); }
  if(name==="recipes"){ renderRecipes(); }
  // ensure scroll top
  document.getElementById("pages").scrollTop=0;
}

/* =========================
FEED
========================= */
function loadFeed(){ try{return JSON.parse(localStorage.getItem(LS_FEED)||"[]");}catch{return [];} }
function saveFeed(items){ localStorage.setItem(LS_FEED, JSON.stringify(items)); }
function addFeedPost(p){
  const items=loadFeed();
  items.unshift({id:"p_"+Date.now(), createdAt:new Date().toISOString(), ...p});
  saveFeed(items);
  renderFeed();
  notify("plan",{ workoutName:p.title||"Workout", dayLabel:"Today" });
}
function renderFeed(){
  const host=document.getElementById("feedList");
  const items=loadFeed();
  if(items.length===0){
    host.innerHTML=`<div class="muted" style="margin-top:10px">No posts yet.</div>`;
    return;
  }
  host.innerHTML = items.slice(0,25).map(p=>{
    const created=new Date(p.createdAt).toLocaleString();
    return `
      <div class="post">
        <div class="postTop">
          <div class="userRow">
            <div class="avatar">${escapeHtml((profile.displayName||"K")[0])}</div>
            <div>
              <div style="font-weight:1000">${escapeHtml(profile.displayName||"You")}</div>
              <div class="muted">${created}</div>
            </div>
          </div>
          <div class="tag">${escapeHtml(p.type||"")}</div>
        </div>
        <div style="margin-top:10px; font-weight:1000">${escapeHtml(p.title||"Workout")}</div>
        <div class="muted" style="margin-top:8px; white-space:pre-wrap">${escapeHtml(p.text||"")}</div>
      </div>
    `;
  }).join("");
}
/* =========================
RECIPES
========================= */
function loadRecipes(){ try{return JSON.parse(localStorage.getItem(LS_RECIPES)||"[]");}catch{return [];} }
function saveRecipes(items){ localStorage.setItem(LS_RECIPES, JSON.stringify(items)); }
function clearRecipeForm(){
  ["rName","rCals","rProt","rIngr","rSteps"].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=""; });
  document.getElementById("rType").value="Cut";
}
function postRecipe(){
  const name=(document.getElementById("rName").value||"").trim();
  if(!name){ toast("Recipe", "Add a name first."); return; }
  const r={
    id:"r_"+Date.now(),
    createdAt:new Date().toISOString(),
    author: profile.displayName || "You",
    name,
    type: document.getElementById("rType").value,
    cals: (document.getElementById("rCals").value||"").trim(),
    protein: (document.getElementById("rProt").value||"").trim(),
    ingr: (document.getElementById("rIngr").value||"").trim(),
    steps: (document.getElementById("rSteps").value||"").trim(),
    likes:0, liked:false,
    comments:[]
  };
  const items=loadRecipes();
  items.unshift(r);
  saveRecipes(items);
  clearRecipeForm();
  renderRecipes();
  notify("recipe", {fromUser: profile.displayName||"You"});
}
function toggleRecipeLike(id){
  const items=loadRecipes();
  const r=items.find(x=>x.id===id);
  if(!r) return;
  r.liked=!r.liked;
  r.likes=Math.max(0,(r.likes||0)+(r.liked?1:-1));
  saveRecipes(items);
  renderRecipes();
  notify("like", {fromUser:"You", recipeId:id});
}
function addRecipeComment(id, text){
  const t=(text||"").trim(); if(!t) return;
  const items=loadRecipes();
  const r=items.find(x=>x.id===id);
  if(!r) return;
  r.comments=r.comments||[];
  r.comments.push({at:new Date().toISOString(), by: profile.displayName||"You", text:t});
  saveRecipes(items);
  renderRecipes();
  notify("comment", {fromUser: profile.displayName||"You", recipeId:id, text:t});
}
function toggleRecipeComments(id){
  const el=document.getElementById("rc_"+id);
  if(!el) return;
  el.style.display = (el.style.display==="block") ? "none" : "block";
}
function renderRecipes(){
  const host=document.getElementById("recipeList");
  const items=loadRecipes();
  if(items.length===0){
    host.innerHTML=`<div class="muted" style="margin-top:12px">No recipes yet. Post one above.</div>`;
    return;
  }
  host.innerHTML = items.map(r=>{
    const created=new Date(r.createdAt).toLocaleString();
    const likeClass = r.liked ? "smallBtn likeBtn active" : "smallBtn likeBtn";
    const macroBits=[
      r.cals?`<span class="tag">${escapeHtml(r.cals)} kcal</span>`:"",
      r.protein?`<span class="tag">${escapeHtml(r.protein)}g protein</span>`:"",
      `<span class="tag">${escapeHtml(r.type)}</span>`
    ].join(" ");

    const ingrLines = escapeHtml(r.ingr).split("\n").filter(Boolean).slice(0,8).map(x=>`‚Ä¢ ${x}`).join("<br>");
    const stepLines = escapeHtml(r.steps).split("\n").filter(Boolean).slice(0,6).map(x=>`${x}`).join("<br>");

    const comments=(r.comments||[]).slice(-3).map(c=>`
      <div style="border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; margin-top:8px; background:rgba(255,255,255,.04)">
        <b>${escapeHtml(c.by)}</b>
        <div class="muted">${escapeHtml(c.text)}</div>
      </div>
    `).join("") || `<div class="muted" style="margin-top:8px">No comments yet.</div>`;

    return `
      <div class="post">
        <div class="postTop">
          <div class="userRow">
            <div class="avatar">${escapeHtml((r.author||"K")[0])}</div>
            <div>
              <div style="font-weight:1000">${escapeHtml(r.author||"KryptaUser")}</div>
              <div class="muted">${created}</div>
            </div>
          </div>
          <div class="tag">Recipe</div>
        </div>

        <div style="margin-top:10px; font-weight:1000">${escapeHtml(r.name)}</div>
        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">${macroBits}</div>

        <div class="muted" style="margin-top:10px">
          <b style="color:rgba(245,247,255,.92)">Ingredients</b><br>${ingrLines || "‚Äî"}
        </div>
        <div class="muted" style="margin-top:10px">
          <b style="color:rgba(245,247,255,.92)">Steps</b><br>${stepLines || "‚Äî"}
        </div>

        <div class="btnRow" style="margin-top:10px">
          <button class="${likeClass}" type="button" onclick="toggleRecipeLike('${r.id}')">‚ù§Ô∏è Like (${r.likes||0})</button>
          <button class="smallBtn" type="button" onclick="toggleRecipeComments('${r.id}')">üí¨ Comment (${(r.comments||[]).length})</button>
        </div>

        <div id="rc_${r.id}" style="display:none; margin-top:10px">
          ${comments}
          <div style="display:flex; gap:10px; margin-top:10px">
            <input id="rci_${r.id}" placeholder="Write a comment..."/>
            <button class="smallBtn" type="button"
              onclick="addRecipeComment('${r.id}', document.getElementById('rci_${r.id}').value); document.getElementById('rci_${r.id}').value=''">
              Post
            </button>
          </div>
        </div>
      </div>
    `;
  }).join("");
}

/* =========================
HISTORY + STREAKS
========================= */
function loadHistory(){ try{return JSON.parse(localStorage.getItem(LS_HISTORY)||"[]");}catch{return [];} }
function addHistory(item){
  const items=loadHistory();
  items.unshift({id:"h_"+Date.now(), createdAt:new Date().toISOString(), ...item});
  localStorage.setItem(LS_HISTORY, JSON.stringify(items));
}
function renderHistory(){
  const list=document.getElementById("historyList");
  const items=loadHistory();
  if(items.length===0){
    list.innerHTML=`<div class="muted" style="margin-top:10px">No history yet.</div>`;
    return;
  }
  list.innerHTML = items.map(it=>{
    const dt=new Date(it.createdAt).toLocaleString();
    return `
      <div class="post">
        <div class="postTop">
          <div>
            <div style="font-weight:1000">${escapeHtml(it.title||"Workout")}</div>
            <div class="muted">${escapeHtml(it.sub||"")}</div>
            <div class="muted">${dt}</div>
          </div>
          <div class="tag">${escapeHtml(it.type||"")}</div>
        </div>
      </div>
    `;
  }).join("");
}
function clearHistory(){
  if(!confirm("Clear local history?")) return;
  localStorage.removeItem(LS_HISTORY);
  renderHistory();
  renderBadges();
  renderWeeklyRecap();
  updateDNAFromData();
}

function loadStreak(){
  try{
    const raw=localStorage.getItem(LS_STREAK);
    const s=raw?JSON.parse(raw):null;
    return s && typeof s==="object" ? s : {current:0,best:0,lastDate:null};
  }catch{
    return {current:0,best:0,lastDate:null};
  }
}
function saveStreak(st){ localStorage.setItem(LS_STREAK, JSON.stringify(st)); }
function updateStreakOnWorkoutPost(){
  const st=loadStreak();
  const today=isoDateLocal(new Date());
  if(st.lastDate===today) return st;

  if(!st.lastDate) st.current=1;
  else{
    const diff=daysBetween(st.lastDate, today);
    st.current = (diff===1) ? (st.current+1) : 1;
  }
  st.best = Math.max(st.best||0, st.current||0);
  st.lastDate=today;
  saveStreak(st);

  if(st.current===3 || st.current===7 || st.current===14 || st.current===30){
    notify("streak", {streak:st.current});
  }
  renderStreakUI();
  renderHomeHeader();
  renderBadges();
  return st;
}
function renderStreakUI(){
  const st=loadStreak();
  const chip=document.getElementById("streakChip");
  if(chip) chip.textContent = String(st.current||0);
  const cur=document.getElementById("streakCurrent");
  const best=document.getElementById("streakBest");
  const last=document.getElementById("streakLast");
  if(cur) cur.textContent=String(st.current||0);
  if(best) best.textContent=String(st.best||0);
  if(last) last.textContent=st.lastDate?st.lastDate:"‚Äî";
}

/* =========================
WORKOUT DNA
========================= */
function loadDNA(){
  try{
    const raw=localStorage.getItem(LS_DNA);
    const d=raw?JSON.parse(raw):null;
    return d && typeof d==="object" ? d : {style:"‚Äî", explain:""};
  }catch{
    return {style:"‚Äî", explain:""};
  }
}
function saveDNA(d){ localStorage.setItem(LS_DNA, JSON.stringify(d)); }
function computeDNAFromFeed(){
  const feed=loadFeed();
  const last30 = feed.filter(p=>{
    const dt=new Date(p.createdAt);
    return (Date.now()-dt.getTime()) <= 30*86400000;
  });
  const gym=last30.filter(p=>p.type==="Gym").length;
  const cardio=last30.filter(p=>p.type==="Cardio").length;
  const wod=last30.filter(p=>p.type==="WOD").length;
  const total=Math.max(1, gym+cardio+wod);

  let style="Hybrid Athlete";
  let explain=`You mix training modes: Gym ${gym}, Cardio ${cardio}, WOD ${wod} (last 30 days).`;

  const gymShare=gym/total, cardioShare=cardio/total, wodShare=wod/total;

  if(gymShare>=0.70 && cardioShare<0.20 && wodShare<0.20){
    style="Strength Builder";
    explain="Mostly gym sessions lately. Consistent strength work.";
  }else if(cardioShare>=0.60 && gymShare<0.30){
    style="Engine Focused";
    explain="Mostly cardio lately. Building endurance and consistency.";
  }else if(wodShare>=0.50){
    style="CrossFit Hybrid";
    explain="A lot of WODs lately. Strong mix of strength + conditioning.";
  }
  return {style, explain, counts:{gym,cardio,wod}};
}
function updateDNAFromData(){
  const d=computeDNAFromFeed();
  saveDNA({style:d.style, explain:d.explain, ts:Date.now()});
  renderDNAUI();
  const chip=document.getElementById("dnaChip");
  if(chip) chip.textContent = d.style.includes(" ") ? d.style.split(" ")[0] : d.style;
}
function renderDNAUI(){
  const d=loadDNA();
  const el=document.getElementById("dnaStyle");
  const ex=document.getElementById("dnaExplain");
  if(el) el.textContent = d.style || "‚Äî";
  if(ex) ex.textContent = d.explain || "";
  const chip=document.getElementById("dnaChip");
  if(chip) chip.textContent = d.style && d.style!=="‚Äî" ? (d.style.split(" ")[0] || d.style) : "‚Äî";
}

/* =========================
WEEKLY RECAP
========================= */
function startOfWeekISO(date=new Date()){
  const d=new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0, 0);
  const day=(d.getDay()+6)%7;
  d.setDate(d.getDate()-day);
  return isoDateLocal(d);
}
function weeklyStats(){
  const hist=loadHistory();
  const todayISO=isoDateLocal(new Date());
  const weekStart=startOfWeekISO(new Date());
  const thisWeek=hist.filter(h=>{
    const d=isoDateLocal(new Date(h.createdAt));
    return d>=weekStart && d<=todayISO;
  });
  const gym=thisWeek.filter(x=>x.type==="Gym").length;
  const cardio=thisWeek.filter(x=>x.type==="Cardio").length;
  const wod=thisWeek.filter(x=>x.type==="WOD").length;
  const total=thisWeek.length;
  let minutes=0;
  thisWeek.forEach(x=>{
    if(x.type==="Cardio") minutes += 30;
    else if(x.type==="WOD") minutes += 35;
    else minutes += 45;
  });
  return {weekStart, total, gym, cardio, wod, minutes};
}
function recoveryScoreFromWeek(){
  const st=weeklyStats();
  let score="Good";
  let note="Balanced week. Keep it calm and consistent.";
  if(st.total>=6){ score="Moderate"; note="High frequency week. A lighter day may help recovery."; }
  if(st.total<=1){ score="Good"; note="Low volume week so far. Even a short session counts."; }
  return {score, note};
}
function renderWeeklyRecap(){
  const el=document.getElementById("weeklyRecap");
  const rc=document.getElementById("recoveryScore");
  const s=weeklyStats();
  const r=recoveryScoreFromWeek();
  if(el){
    el.innerHTML = `${escapeHtml(s.weekStart)} ‚Üí now<br>
    Sessions: <b>${s.total}</b> (Gym ${s.gym} ‚Ä¢ Cardio ${s.cardio} ‚Ä¢ WOD ${s.wod})<br>
    Estimated minutes: <b>${s.minutes}</b>`;
  }
  if(rc){
    rc.innerHTML = `<b>${escapeHtml(r.score)}</b><br>${escapeHtml(r.note)}`;
  }
}
function renderHomeHeader(){
  const el=document.getElementById("homeSummary");
  if(!el) return;
  const st=loadStreak();
  const dna=loadDNA();
  el.innerHTML = `<b>${escapeHtml(niceGoal(profile.goal))}</b> ‚Ä¢ ${profile.days} days/week
  <span class="muted"> ‚Ä¢ ${profile.heightCm}cm ‚Ä¢ ${profile.weightKg}kg ‚Ä¢ age ${profile.age} ‚Ä¢ ${escapeHtml(niceActivity(profile.activity))}</span>
  <br><span class="muted">Streak: ${st.current||0} ‚Ä¢ Best: ${st.best||0} ‚Ä¢ DNA: ${escapeHtml(dna.style||"‚Äî")}</span>`;
}
function renderHomeCoachNote(){
  const el=document.getElementById("coachNoteHome");
  if(!el) return;
  const st=loadStreak();
  const today=isoDateLocal(new Date());
  const diff = st.lastDate ? daysBetween(st.lastDate, today) : null;
  let note="";
  if(!st.lastDate) note="Private coach note: Start small. One session is a new baseline.";
  else if(diff===0) note="Private coach note: Streak protected today. Keep tomorrow simple.";
  else if(diff===1) note="Private coach note: One session today keeps the streak alive.";
  else note="Private coach note: No pressure. A short session restarts momentum.";
  el.textContent = note;
}

/* =========================
NOTIFICATIONS
========================= */
const Notifs = { items:[] };
function loadNotifs(){
  try{
    const raw = localStorage.getItem(LS_NOTIFS);
    Notifs.items = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(Notifs.items)) Notifs.items = [];
  }catch{ Notifs.items = []; }
}
function saveNotifs(){ localStorage.setItem(LS_NOTIFS, JSON.stringify(Notifs.items)); }
function unreadCount(){ return Notifs.items.reduce((a,n)=>a + (n.read?0:1), 0); }
function notify(type, payload={}){
  const id = (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())+"_"+Math.random().toString(16).slice(2));
  Notifs.items.unshift({ id, type, payload, ts: Date.now(), read:false });
  if(Notifs.items.length > 200) Notifs.items = Notifs.items.slice(0,200);
  saveNotifs();
  renderNotifUI();
  return id;
}
function iconForType(type){
  if(type==="like") return "‚ù§Ô∏è";
  if(type==="comment") return "üí¨";
  if(type==="plan") return "üóìÔ∏è";
  if(type==="streak") return "üî•";
  if(type==="recipe") return "ü•ó";
  return "üîî";
}
function titleForNotif(n){
  const p=n.payload||{};
  switch(n.type){
    case "like": return `${p.fromUser||"Someone"} liked something`;
    case "comment": return `${p.fromUser||"Someone"} commented`;
    case "plan": return `Plan reminder`;
    case "streak": return `Streak milestone`;
    case "recipe": return `New recipe posted`;
    default: return "Notification";
  }
}
function subForNotif(n){
  const p=n.payload||{};
  switch(n.type){
    case "comment": return (p.text||"Tap to view").slice(0,80);
    case "plan": return p.workoutName ? `${p.dayLabel||"Today"} ‚Ä¢ ${p.workoutName}` : "Open your plan";
    case "streak": return p.streak ? `Current streak: ${p.streak} days` : "Keep it going";
    case "recipe": return "Tap Recipes";
    default: return "Tap to view";
  }
}
function mountNotifUI(){
  const host = document.getElementById("topRightActions");
  if(!host) return;
  if(document.getElementById("notifWrap")) return;

  const wrap=document.createElement("div");
  wrap.className="notifWrap";
  wrap.id="notifWrap";
  wrap.innerHTML = `
    <button class="notifBtn" id="notifBtn" type="button" aria-label="Notifications">üîî</button>
    <span class="notifCount" id="notifCount"></span>
    <div class="notifPanel" id="notifPanel">
      <div class="notifHead">
        <b>Notifications</b>
        <div class="notifActions">
          <button class="nChip" id="notifMarkAll" type="button">Mark all</button>
          <button class="nChip" id="notifClear" type="button">Clear</button>
        </div>
      </div>
      <div class="notifList" id="notifList"></div>
    </div>
  `;
  host.insertBefore(wrap, host.firstElementChild);

  document.getElementById("notifBtn").addEventListener("click",(e)=>{
    e.stopPropagation();
    const panel=document.getElementById("notifPanel");
    const open = panel.style.display==="block";
    panel.style.display = open ? "none" : "block";
    if(!open) renderNotifUI();
  });
  document.getElementById("notifPanel").addEventListener("click",(e)=>e.stopPropagation());
  document.addEventListener("click", ()=> closeNotifPanel());

  document.getElementById("notifMarkAll").addEventListener("click",(e)=>{
    e.stopPropagation();
    Notifs.items = Notifs.items.map(n=>({...n, read:true}));
    saveNotifs();
    renderNotifUI();
  });
  document.getElementById("notifClear").addEventListener("click",(e)=>{
    e.stopPropagation();
    Notifs.items = [];
    saveNotifs();
    renderNotifUI();
  });
}
function closeNotifPanel(){
  const panel=document.getElementById("notifPanel");
  if(panel) panel.style.display="none";
}
function renderNotifList(){
  const list=document.getElementById("notifList");
  if(!list) return;
  const items=Notifs.items.slice(0,40);
  if(items.length===0){
    list.innerHTML = `<div class="muted" style="padding:12px">No notifications yet</div>`;
    return;
  }
  list.innerHTML = items.map(n=>`
    <div class="notifItem ${n.read?"":"unread"}" data-id="${n.id}">
      <div class="notifIcon">${iconForType(n.type)}</div>
      <div>
        <div class="notifT">${escapeHtml(titleForNotif(n))}</div>
        <div class="notifS">${escapeHtml(subForNotif(n))}</div>
      </div>
      <div class="notifMeta">${timeAgo(n.ts)}</div>
    </div>
  `).join("");

  list.querySelectorAll(".notifItem").forEach(el=>{
    el.addEventListener("click",()=>{
      const id=el.getAttribute("data-id");
      const n=Notifs.items.find(x=>x.id===id);
      if(!n) return;
      n.read=true;
      saveNotifs();
      renderNotifUI();
      if(n.type==="recipe") showPage("recipes");
      closeNotifPanel();
    });
  });
}
function renderNotifUI(){
  const count=unreadCount();
  const c=document.getElementById("notifCount");
  if(c){
    c.style.display = count>0 ? "inline-flex" : "none";
    c.textContent = count>99 ? "99+" : String(count);
  }
  renderNotifList();
}

/* =========================
PLAN
========================= */
function loadPlan(){ try{return JSON.parse(localStorage.getItem(LS_PLAN)||"null");}catch{return null;} }
function savePlan(p){ localStorage.setItem(LS_PLAN, JSON.stringify(p)); }

function generatePlan(save=true){
  const days=clamp(Number(profile.days||4),3,6);
  const splitByDays={
    3:["Gym","Cardio","Gym"],
    4:["Gym","Cardio","Gym","WOD"],
    5:["Gym","Cardio","Gym","WOD","Gym"],
    6:["Gym","Cardio","Gym","WOD","Gym","Cardio"]
  }[days];

  const plan={ createdAt:new Date().toISOString(), days:{} };
  const labels={
    Gym:["Upper Strength","Lower Strength","Full Body","Pull Focus","Push Focus"],
    Cardio:["Easy Zone 2","Intervals","Hill Walk","Tempo Run","Long Walk"],
    WOD:["Mixed Metcon","Strength + Metcon","Engine Builder","Chipper","EMOM"]
  };

  let idx=0;
  weekDays.forEach((d)=>{
    if(idx<splitByDays.length){
      const kind=splitByDays[idx++];
      plan.days[d]={ kind, label: rand(labels[kind]) };
    }else{
      plan.days[d]={ kind:"Rest", label:"Recovery + mobility" };
    }
  });

  if(save) savePlan(plan);
  return plan;
}

function renderPlan(){
  const host=document.getElementById("planList");
  let plan=loadPlan();
  if(!plan) plan=generatePlan(true);

  host.innerHTML = weekDays.map(d=>{
    const item=plan.days[d];
    const tag=item.kind==="Rest"?"Rest":item.kind;
    return `
      <div class="post" style="cursor:pointer" onclick="openPlanDay('${d}')">
        <div class="postTop">
          <div>
            <div style="font-weight:1000">${escapeHtml(d)}</div>
            <div class="muted">${escapeHtml(item.label||"")}</div>
          </div>
          <div class="tag">${escapeHtml(tag)}</div>
        </div>
      </div>
    `;
  }).join("");
}

function openPlanDay(day){
  let plan=loadPlan(); if(!plan) plan=generatePlan(true);
  const item=plan.days[day];
  document.getElementById("planWeekCard").style.display="none";
  document.getElementById("planDayCard").style.display="block";
  document.getElementById("planDayTitle").textContent=day;
  document.getElementById("planDaySub").textContent=item.kind==="Rest" ? "Recovery focus" : "Warm-up is always first.";
  document.getElementById("planDayTag").textContent=item.kind;

  const body=document.getElementById("planDayBody");
  if(item.kind==="Rest"){
    body.innerHTML = `
      <div class="muted"><b>Recovery</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ 20‚Äì40 min easy walk
‚Ä¢ 8‚Äì12 min mobility (hips + shoulders)
‚Ä¢ 5 min breathing (slow nasal)
      </div>`;
    return;
  }

  if(item.kind==="Cardio"){
    body.innerHTML = `
      <div class="muted"><b>Warm-up</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ 5 min easy pace
‚Ä¢ 3 x 20s faster + 40s easy
      </div>
      <div class="muted" style="margin-top:12px"><b>Main</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ ${escapeHtml(item.label)}
‚Ä¢ Total: 25‚Äì45 min
      </div>`;
    return;
  }

  if(item.kind==="WOD"){
    body.innerHTML = `
      <div class="muted"><b>Warm-up</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ 4 min easy row/bike
‚Ä¢ 2 rounds: 10 air squats + 10 push-ups + 10 sit-ups
      </div>
      <div class="muted" style="margin-top:12px"><b>WOD</b></div>
      <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ ${escapeHtml(item.label)}
‚Ä¢ Keep pace sustainable
      </div>`;
    return;
  }

  body.innerHTML = `
    <div class="muted"><b>Warm-up</b></div>
    <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ 3‚Äì5 min easy bike/row
‚Ä¢ 2 rounds: 10 band pull-aparts + 10 hinge + 10 air squats
    </div>
    <div class="muted" style="margin-top:12px"><b>Main</b></div>
    <div class="muted" style="margin-top:8px; white-space:pre-wrap">
‚Ä¢ ${escapeHtml(item.label)}
‚Ä¢ 4‚Äì6 exercises
    </div>`;
}
function closePlanDay(){
  document.getElementById("planWeekCard").style.display="block";
  document.getElementById("planDayCard").style.display="none";
}

/* =========================
EXERCISE LIBRARY + DEMOS
========================= */
function demoStatic(title, note){
  return `
    <svg class="exSvg" viewBox="0 0 860 360">
      <text x="30" y="40" fill="rgba(245,247,255,.9)" font-size="20" font-weight="900">${escapeHtml(title)}</text>
      <text x="30" y="70" fill="rgba(245,247,255,.7)" font-size="14">${escapeHtml(note)}</text>
      <rect x="80" y="110" width="700" height="200" rx="18" fill="rgba(255,255,255,.04)" stroke="rgba(255,255,255,.10)"/>
    </svg>`;
}
function demoSquat(){ return window.__demoSquat; }
function demoBench(){ return window.__demoBench; }
function demoCurl(){ return window.__demoCurl; }
function demoKBSwing(){ return window.__demoKB; }
function demoPulldown(){ return demoStatic("Pulldown (preview)", "Bar moves down to chest."); }
function demoRDL(){ return demoStatic("RDL (preview)", "Hips hinge back, bar slides down legs."); }

window.__demoSquat = `
<svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
  <path d="M150 90 V320 M710 90 V320" stroke="rgba(245,247,255,.18)" stroke-width="8" stroke-linecap="round"/>
  <path d="M140 90 H720" stroke="rgba(245,247,255,.12)" stroke-width="10" stroke-linecap="round"/>
  <g class="rep squatBar" style="transform-origin: 430px 120px;">
    <rect x="250" y="110" width="360" height="14" rx="7" fill="rgba(245,247,255,.85)"/>
    <circle cx="240" cy="117" r="26" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
    <circle cx="620" cy="117" r="26" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
  </g>
  <g class="rep squatHip" style="transform-origin: 430px 185px;">
    <g class="rep squatTorso" style="transform-origin: 430px 175px;">
      <circle cx="430" cy="140" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
      <path d="M430 160 L430 220" stroke="rgba(245,247,255,.85)" stroke-width="8" stroke-linecap="round"/>
      <path d="M430 185 L360 120" stroke="rgba(245,247,255,.75)" stroke-width="7" stroke-linecap="round"/>
      <path d="M430 185 L500 120" stroke="rgba(245,247,255,.75)" stroke-width="7" stroke-linecap="round"/>
    </g>
    <circle cx="430" cy="230" r="10" fill="rgba(245,247,255,.55)"/>
    <path d="M430 230 L408 270" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
    <path d="M430 230 L452 270" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
    <path d="M408 270 L390 312" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
    <path d="M452 270 L470 312" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
    <path d="M370 318 H405" stroke="rgba(245,247,255,.75)" stroke-width="10" stroke-linecap="round"/>
    <path d="M455 318 H490" stroke="rgba(245,247,255,.75)" stroke-width="10" stroke-linecap="round"/>
  </g>
</svg>`;

window.__demoBench = `
<svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
  <rect x="220" y="240" width="420" height="26" rx="13" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.14)"/>
  <g class="rep benchBar" style="transform-origin: 430px 150px;">
    <rect x="260" y="144" width="340" height="12" rx="6" fill="rgba(245,247,255,.85)"/>
    <circle cx="250" cy="150" r="22" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
    <circle cx="610" cy="150" r="22" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
  </g>
  <circle cx="355" cy="235" r="18" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
  <path d="M375 235 L520 235" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
  <path d="M420 235 L380 210" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
  <path d="M420 235 L480 210" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
</svg>`;

window.__demoCurl = `
<svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
  <circle cx="430" cy="95" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
  <path d="M430 115 L430 200" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
  <path d="M430 150 L375 190" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
  <g class="rep curlForeL" style="transform-origin: 375px 190px;">
    <path d="M375 190 L345 240" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
  </g>
  <path d="M430 150 L485 190" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
  <g class="rep curlForeR" style="transform-origin: 485px 190px;">
    <path d="M485 190 L515 240" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
  </g>
</svg>`;

window.__demoKB = `
<svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
  <g class="rep kbSwingTorso" style="transform-origin: 430px 170px;">
    <circle cx="430" cy="95" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
    <path d="M430 115 L430 200" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
  </g>
  <g class="rep kbSwingArms" style="transform-origin: 430px 185px;">
    <path d="M430 160 L390 220" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
    <path d="M430 160 L470 220" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
  </g>
  <g class="rep kbSwingKB" style="transform-origin: 430px 245px;">
    <path d="M410 245 C410 270 450 270 450 245" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
    <circle cx="430" cy="260" r="12" fill="rgba(245,247,255,.20)" stroke="rgba(245,247,255,.35)" stroke-width="2"/>
  </g>
</svg>`;

const EX = {
  "Barbell Back Squat": {
    muscles:["Quads","Glutes","Core"],
    cue:"Brace + sit between hips.",
    how:"Set bar on upper traps. Big breath, brace, sit down/back. Knees track over toes. Stand by pushing the floor away.",
    tips:["Keep mid-foot pressure.","Depth: pain-free.","Drive up with chest and hips together."],
    demo: demoSquat
  },
  "Bench Press": {
    muscles:["Chest","Triceps","Shoulders"],
    cue:"Touch lower chest, press up/back.",
    how:"Eyes under bar. Feet planted. Lower with control. Press up and slightly back, wrists stacked.",
    tips:["Shoulder blades back + down.","Forearms vertical at bottom.","Don‚Äôt bounce."],
    demo: demoBench
  },
  "Dumbbell Curl": {
    muscles:["Biceps"],
    cue:"Elbows still. Squeeze at top.",
    how:"Curl without swinging. Control down fully.",
    tips:["Keep elbows slightly forward.","Slow eccentric.","Don‚Äôt shrug."],
    demo: demoCurl
  },
  "Kettlebell Swing": {
    muscles:["Glutes","Hamstrings","Core"],
    cue:"Hinge snap. Arms are ropes.",
    how:"Hinge back, hike KB, snap hips. KB floats to chest height.",
    tips:["Neutral spine.","KB stays close.","Power from hips."],
    demo: demoKBSwing
  },
  "Lat Pulldown": {
    muscles:["Back","Biceps"],
    cue:"Pull elbows to ribs.",
    how:"Slight lean back, pull to upper chest, control up.",
    tips:["Don‚Äôt yank.","Keep ribs down.","Squeeze lats."],
    demo: demoPulldown
  },
  "Romanian Deadlift": {
    muscles:["Hamstrings","Glutes","Back"],
    cue:"Hips back. Shins vertical.",
    how:"Soft knees, hinge back, bar slides down thighs, stand by driving hips forward.",
    tips:["Neutral spine.","Keep bar close.","Slow down."],
    demo: demoRDL
  }
};

/* =========================
EXERCISE MODAL CONTROL
========================= */
let exPlaying=true;
let exSpeed=1800;

function openExercise(name){
  const ex=EX[name];
  if(!ex){ toast("Exercise", "Not found."); return; }
  document.getElementById("exTitle").textContent=name;
  document.getElementById("exMuscles").textContent="Muscles: "+(ex.muscles||[]).join(", ");
  document.getElementById("exHow").textContent=ex.how||"";
  document.getElementById("exCue").textContent="Cue: "+(ex.cue||"‚Äî");

  const tips=document.getElementById("exTips");
  tips.innerHTML="";
  (ex.tips||[]).forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t;
    tips.appendChild(li);
  });

  const pic=document.getElementById("exPic");
  pic.innerHTML = ex.demo ? ex.demo() : demoStatic(name, "Preview");

  setExSpeed(exSpeed);
  exPlaying=true;
  syncExPlayUI();

  document.getElementById("exerciseModal").classList.add("show");
}
function closeExercise(){
  document.getElementById("exerciseModal").classList.remove("show");
}
function toggleExPlay(){
  exPlaying=!exPlaying;
  syncExPlayUI();
}
function syncExPlayUI(){
  const svg=document.getElementById("exSvg");
  const btn=document.getElementById("exPlayBtn");
  if(svg){
    svg.classList.toggle("exPlay", exPlaying);
    svg.querySelectorAll(".rep").forEach(n=>{
      n.style.animationPlayState = exPlaying ? "running" : "paused";
    });
  }
  if(btn){
    btn.textContent = exPlaying ? "‚è∏ Pause" : "‚ñ∂ Play";
  }
}
function setExSpeed(ms){
  exSpeed=ms;
  document.documentElement.style.setProperty("--repDur", ms+"ms");
  document.getElementById("exSpeedMid").classList.toggle("primary", ms===1800);
}

/* =========================
GYM GENERATOR (clickable exercises)
========================= */
let lastPostDraft=null;

function warmupForMuscles(){
  return [
    "3‚Äì5 min easy warm-up: bike/row/jog + nasal breathing",
    "2 rounds: 10 band pull-aparts + 10 hinge + 10 air squats",
    "1‚Äì2 ramp-up sets per lift before working sets"
  ];
}

function pickGymExercises(goal){
  const warm=warmupForMuscles();
  const scheme = (goal==="strong")
    ? {main:"5 x 3‚Äì5", acc:"3 x 8‚Äì12"}
    : (goal==="cut" || goal==="sixpack")
      ? {main:"4 x 6‚Äì10", acc:"2‚Äì3 x 12‚Äì15"}
      : {main:"4 x 6‚Äì10", acc:"3 x 10‚Äì15"};

  const blocks=[
    {name:"Barbell Back Squat", sets:scheme.main, rest:"Rest 2‚Äì3 min"},
    {name:"Bench Press", sets:scheme.main, rest:"Rest 2 min"},
    {name:"Lat Pulldown", sets:scheme.acc, rest:"Rest 60‚Äì90s"},
    {name:"Romanian Deadlift", sets:scheme.acc, rest:"Rest 90s"},
    {name:"Dumbbell Curl", sets:scheme.acc, rest:"Rest 60s"},
    {name:"Kettlebell Swing", sets:"8‚Äì12 min intervals", rest:"‚Äî"}
  ];

  return { warm, blocks };
}

function renderWorkoutTextWithExerciseLinks(text){
  const safe=escapeHtml(text).replaceAll("\n","<br>");
  let out=safe;
  Object.keys(EX).forEach(name=>{
    const esc = name.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    const re = new RegExp(esc, "g");
    out = out.replace(re, `<span class="pill" onclick="openExercise('${name.replaceAll("'","\\'")}')">‚ñ∂ ${escapeHtml(name)}</span>`);
  });
  return `<div style="white-space:normal; display:flex; flex-direction:column; gap:8px">${out}</div>`;
}

function renderPostCard(p){
  document.getElementById("postCard").style.display="block";
  document.getElementById("postTitle").textContent=p.title||"Workout";
  document.getElementById("postMeta").textContent=`${p.type} ‚Ä¢ ${new Date().toLocaleString()}`;
  document.getElementById("postTag").textContent="Preview";
  document.getElementById("coachNoteBox").textContent=p.coachNote||"";
  document.getElementById("postBody").innerHTML = renderWorkoutTextWithExerciseLinks(p.text||"");
  document.getElementById("pages").scrollTop=0;
}

function generateGymAndShowPost(){
  const goal=document.getElementById("todayGoal").value || profile.goal;
  const custom=(document.getElementById("customGoal").value||"").trim();
  const pain=(document.getElementById("todayPain").value||"").trim();

  const g=pickGymExercises(goal);

  let coach="Keep form clean. Stop 1‚Äì2 reps before failure on most sets.";
  if(pain) coach=`Pain noted: "${pain}". Swap any painful movement. Keep range pain-free.`;

  const title = custom ? `Gym: ${custom}` : `Gym: ${niceGoal(goal)}`;
  const lines=[];
  lines.push("Warm-up:");
  g.warm.forEach(x=>lines.push("‚Ä¢ "+x));
  lines.push("");
  lines.push("Main + Accessories:");
  g.blocks.forEach(b=>lines.push(`‚Ä¢ ${b.name} ‚Äî ${b.sets} (${b.rest})`));
  lines.push("");
  lines.push("Cool-down:");
  lines.push("‚Ä¢ 3‚Äì5 min easy walk + 2 min breathing");

  lastPostDraft={ type:"Gym", title, text:lines.join("\n"), coachNote:coach, meta:{goal,pain} };
  renderPostCard(lastPostDraft);
}

function postLastToFeed(){
  if(!lastPostDraft){ toast("Create", "Generate a workout first."); return; }
  const caption=(document.getElementById("postCaption").value||"").trim();
  const refl={
    effort: document.getElementById("reflectEffort").value || "",
    energy: document.getElementById("reflectEnergy").value || "",
    enjoy: document.getElementById("reflectEnjoy").value || ""
  };

  addFeedPost({
    ...lastPostDraft,
    text: (caption? (lastPostDraft.text + "\n\nCaption: " + caption) : lastPostDraft.text),
    privateReflection: refl
  });

  addHistory({
    type:lastPostDraft.type,
    title:lastPostDraft.title,
    sub:niceGoal(lastPostDraft.meta?.goal||profile.goal),
    meta:lastPostDraft.meta||{}
  });

  updateStreakOnWorkoutPost();
  updateDNAFromData();
  renderWeeklyRecap();
  renderHomeCoachNote();

  document.getElementById("postCaption").value="";
  toast("Posted", "Saved to feed + history.");
  showPage("home");
}

/* =========================
BADGES
========================= */
function badgeDefs(){
  return [
    {id:"b1", icon:"üî•", title:"Streak 3", sub:"Post 3 days in a row", check:()=>loadStreak().best>=3},
    {id:"b2", icon:"üß¨", title:"DNA Set", sub:"Do 3 workouts total", check:()=>loadHistory().length>=3},
    {id:"b3", icon:"üèãÔ∏è", title:"First Gym", sub:"Post 1 gym", check:()=>loadHistory().some(x=>x.type==="Gym")},
    {id:"b6", icon:"ü•ó", title:"First Recipe", sub:"Post a recipe", check:()=>loadRecipes().length>=1}
  ];
}
function renderBadges(){
  const grid=document.getElementById("badgeGrid");
  if(!grid) return;
  const defs=badgeDefs();
  grid.innerHTML = defs.map(b=>{
    const on=!!b.check();
    return `
      <div class="tag" style="opacity:${on?1:0.55}; border-radius:16px; padding:10px 12px;">
        <span style="font-size:16px; margin-right:8px">${b.icon}</span>
        <span style="font-weight:1000">${escapeHtml(b.title)}</span>
        <span style="opacity:.7"> ‚Äî ${escapeHtml(b.sub)}</span>
      </div>
    `;
  }).join("");
}

/* =========================
PROFILE UI
========================= */
function fillProfileUI(){
  document.getElementById("displayName").value=profile.displayName||"";
  document.getElementById("gender").value=profile.gender||"male";
  document.getElementById("heightCm").value=profile.heightCm||"";
  document.getElementById("weightKg").value=profile.weightKg||"";
  document.getElementById("age").value=profile.age||"";
  document.getElementById("activity").value=profile.activity||"moderate";
  document.getElementById("goal").value=profile.goal||"muscle";
  document.getElementById("days").value=String(profile.days||4);
}
function saveProfile(){
  profile={
    ...profile,
    displayName: document.getElementById("displayName").value || "KryptaUser",
    gender: document.getElementById("gender").value,
    heightCm: Number(document.getElementById("heightCm").value)||180,
    weightKg: Number(document.getElementById("weightKg").value)||80,
    age: Number(document.getElementById("age").value)||20,
    activity: document.getElementById("activity").value,
    goal: document.getElementById("goal").value,
    days: Number(document.getElementById("days").value)||4
  };
  saveProfileLS();
  if(!loadPlan()) generatePlan(true);
  else generatePlan(true);
  renderHomeHeader();
  renderWeeklyRecap();
  updateDNAFromData();
  renderBadges();
  toast("Saved", "Profile updated.");
  showPage("home");
}
function resetAll(){
  if(!confirm("Reset everything (local)?")) return;
  [LS_PROFILE,LS_HISTORY,LS_PLAN,LS_FEED,LS_STREAK,LS_NOTIFS,LS_DNA,LS_RECIPES,LS_ONB].forEach(k=>localStorage.removeItem(k));
  profile=defaultProfile();
  saveProfileLS();
  initLocal();
  toast("Reset", "Local data cleared.");
}

/* =========================
ONBOARDING (fixed so it never blocks taps forever)
========================= */
let onbStep=0;
const onbSteps = [
  { title:"Your email", fields:() => `
      <div class="muted" style="margin-bottom:6px">Email</div>
      <input id="onbEmail" placeholder="you@email.com" value="${escapeHtml(profile.email||"")}"/>
    `},
  { title:"Body stats", fields:() => `
      <div class="grid2">
        <div>
          <div class="muted" style="margin-bottom:6px">Gender</div>
          <select id="onbGender">
            <option value="male" ${profile.gender==="male"?"selected":""}>Male</option>
            <option value="female" ${profile.gender==="female"?"selected":""}>Female</option>
            <option value="other" ${profile.gender==="other"?"selected":""}>Other</option>
          </select>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Age</div>
          <input id="onbAge" value="${escapeHtml(profile.age)}" placeholder="20"/>
        </div>
      </div>
      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="muted" style="margin-bottom:6px">Height (cm)</div>
          <input id="onbHeight" value="${escapeHtml(profile.heightCm)}" placeholder="180"/>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Weight (kg)</div>
          <input id="onbWeight" value="${escapeHtml(profile.weightKg)}" placeholder="80"/>
        </div>
      </div>
    `},
  { title:"Weekly goal", fields:() => `
      <div class="muted" style="margin-bottom:6px">How many days/week?</div>
      <select id="onbDays">
        <option value="3" ${profile.days==3?"selected":""}>3</option>
        <option value="4" ${profile.days==4?"selected":""}>4</option>
        <option value="5" ${profile.days==5?"selected":""}>5</option>
        <option value="6" ${profile.days==6?"selected":""}>6</option>
      </select>
    `},
  { title:"Username + password", fields:() => `
      <div class="grid2">
        <div>
          <div class="muted" style="margin-bottom:6px">Username</div>
          <input id="onbUser" placeholder="kryptauser" value="${escapeHtml(profile.username||"")}"/>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Password</div>
          <input id="onbPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">Local demo: password is not sent anywhere.</div>
    `},
  { title:"Main goal", fields:() => `
      <div class="muted" style="margin-bottom:6px">Goal <span style="opacity:.7">(can be changed any time)</span></div>
      <select id="onbGoal">
        <option value="muscle" ${profile.goal==="muscle"?"selected":""}>Build muscle</option>
        <option value="strong" ${profile.goal==="strong"?"selected":""}>Get stronger</option>
        <option value="cut" ${profile.goal==="cut"?"selected":""}>Cut / lean</option>
        <option value="sixpack" ${profile.goal==="sixpack"?"selected":""}>Sixpack focus</option>
      </select>
      <div class="muted" style="margin-top:8px">You can update this later in Profile.</div>
    `}
];

function hasCompletedOnboarding(){
  return localStorage.getItem(LS_ONB)==="1";
}
function setOnbDone(){
  localStorage.setItem(LS_ONB,"1");
}
function onbRender(){
  const box=document.getElementById("onbSteps");
  const sub=document.getElementById("onbSub");
  const dots=document.getElementById("onbDots");
  const step=onbSteps[onbStep];

  sub.textContent = step.title;

  dots.innerHTML = onbSteps.map((_,i)=>`<div class="dot ${i===onbStep?"on":""}"></div>`).join("");

  box.innerHTML = step.fields();

  document.getElementById("onbBackBtn").style.opacity = onbStep===0 ? ".5" : "1";
  document.getElementById("onbBackBtn").disabled = onbStep===0;

  const isLast = onbStep===onbSteps.length-1;
  document.getElementById("onbNextBtn").style.display = isLast ? "none" : "inline-flex";
  document.getElementById("onbFinishBtn").style.display = isLast ? "inline-flex" : "none";
}
function onbShow(){
  document.getElementById("onbOverlay").classList.add("show");
  onbRender();
}
function onbHide(){
  document.getElementById("onbOverlay").classList.remove("show");
}
function onbSaveStep(){
  if(onbStep===0){
    profile.email=(document.getElementById("onbEmail").value||"").trim();
  }
  if(onbStep===1){
    profile.gender=document.getElementById("onbGender").value;
    profile.age=Number(document.getElementById("onbAge").value)||20;
    profile.heightCm=Number(document.getElementById("onbHeight").value)||180;
    profile.weightKg=Number(document.getElementById("onbWeight").value)||80;
  }
  if(onbStep===2){
    profile.days=Number(document.getElementById("onbDays").value)||4;
  }
  if(onbStep===3){
    profile.username=(document.getElementById("onbUser").value||"").trim();
    const u=profile.username || profile.displayName || "KryptaUser";
    profile.displayName = u;
  }
  if(onbStep===4){
    profile.goal=document.getElementById("onbGoal").value;
  }
  saveProfileLS();
}
function onbNext(){
  onbSaveStep();
  onbStep = Math.min(onbSteps.length-1, onbStep+1);
  onbRender();
}
function onbBack(){
  onbSaveStep();
  onbStep = Math.max(0, onbStep-1);
  onbRender();
}
function onbFinish(){
  onbSaveStep();
  setOnbDone();
  onbHide();
  renderHomeHeader();
  generatePlan(true);
  renderPlan();
  renderWeeklyRecap();
  updateDNAFromData();
  renderBadges();
  toast("Welcome", "Onboarding complete.");
}

/* =========================
INIT + WIRING
========================= */
let profile = defaultProfile();

function initLocal(){
  profile = loadProfile() || defaultProfile();
  saveProfileLS();

  // splash short
  setTimeout(()=>document.getElementById("splash").classList.add("hidden"), 700);

  // notifs
  loadNotifs();
  mountNotifUI();
  renderNotifUI();

  // plan
  if(!loadPlan()) generatePlan(true);

  // UI
  renderStreakUI();
  updateDNAFromData();
  renderBadges();
  renderHomeHeader();
  renderWeeklyRecap();
  renderHomeCoachNote();
  renderFeed();
  renderRecipes();
  renderHistory();

  // onboarding
  if(!hasCompletedOnboarding()){
    onbStep=0;
    onbShow();
  }
}

/* ==== Button wiring (NO inline onclick so nothing breaks) ==== */
function wire(){
  document.getElementById("tabHome").onclick=()=>showPage("home");
  document.getElementById("tabPlan").onclick=()=>showPage("plan");
  document.getElementById("tabCreate").onclick=()=>showPage("create");
  document.getElementById("tabRecipes").onclick=()=>showPage("recipes");
  document.getElementById("tabHistory").onclick=()=>showPage("history");

  document.getElementById("btnProfile").onclick=()=>showPage("profile");
  document.getElementById("backHomeBtn").onclick=()=>showPage("home");

  document.getElementById("regenPlanBtn").onclick=()=>{ generatePlan(true); renderPlan(); toast("Plan", "Regenerated."); };
  document.getElementById("closePlanDayBtn").onclick=()=>closePlanDay();

  document.getElementById("genGymBtn").onclick=()=>generateGymAndShowPost();
  document.getElementById("postFeedBtn").onclick=()=>postLastToFeed();

  document.getElementById("postRecipeBtn").onclick=()=>postRecipe();

  document.getElementById("clearHistoryBtn").onclick=()=>clearHistory();
  document.getElementById("resetAllBtn").onclick=()=>resetAll();

  document.getElementById("saveProfileBtn").onclick=()=>saveProfile();

  document.getElementById("exCloseBtn").onclick=()=>closeExercise();
  document.getElementById("exerciseModal").addEventListener("click",(e)=>{
    if(e.target && e.target.id==="exerciseModal") closeExercise();
  });
  document.getElementById("exPlayBtn").onclick=()=>toggleExPlay();
  document.getElementById("exSpeedSlow").onclick=()=>setExSpeed(2600);
  document.getElementById("exSpeedMid").onclick=()=>setExSpeed(1800);
  document.getElementById("exSpeedFast").onclick=()=>setExSpeed(1200);

  // onboarding
  document.getElementById("onbCloseBtn").onclick=()=>{ onbHide(); /* allow exit */ };
  document.getElementById("onbBackBtn").onclick=()=>onbBack();
  document.getElementById("onbNextBtn").onclick=()=>onbNext();
  document.getElementById("onbFinishBtn").onclick=()=>onbFinish();

  // ESC closes modal
  document.addEventListener("keydown",(e)=>{
    if(e.key==="Escape"){
      closeExercise();
      closeNotifPanel();
      onbHide();
    }
  });
}

window.addEventListener("load", ()=>{
  wire();
  initLocal();
  showPage("home");
});
</script>
</body>
</html>
