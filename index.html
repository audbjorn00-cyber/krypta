<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="theme-color" content="#05060a"/>
  <title>KRYPTA</title>

  <!-- PWA-ish: icon links (bear.png must exist next to this file) -->
  <link rel="icon" href="./bear.png"/>
  <link rel="apple-touch-icon" href="./bear.png"/>

  <style>
    :root{
      --bg:#05060a;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.08);
      --line:rgba(255,255,255,.10);
      --txt:rgba(245,247,255,.92);
      --mut:rgba(245,247,255,.62);
      --mut2:rgba(245,247,255,.45);
      --red:#ff1b1b;
      --red2:rgba(255,27,27,.35);
      --shadow:0 16px 60px rgba(0,0,0,.55);
      --r:22px;
      --tabH:74px;
      --repDur:1800ms;
    }

    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--txt); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    /* IMPORTANT: don‚Äôt block taps */
    body::before{content:""; position:fixed; inset:0; pointer-events:none; background:
      radial-gradient(900px 500px at 20% 10%, rgba(129,96,255,.12), transparent 60%),
      radial-gradient(900px 500px at 80% 20%, rgba(255,27,27,.10), transparent 60%),
      radial-gradient(900px 700px at 50% 90%, rgba(70,170,255,.08), transparent 60%);
    }

    a{color:inherit}
    button, input, select{font:inherit}
    button{cursor:pointer}
    .muted{color:var(--mut)}
    .muted2{color:var(--mut2)}

    /* Layout */
    .app{
      position:relative;
      min-height:100vh;
      padding-bottom: calc(var(--tabH) + env(safe-area-inset-bottom));
    }

    .topbar{
      position:sticky; top:0; z-index:20;
      padding: 14px 14px 10px;
      background: linear-gradient(to bottom, rgba(5,6,10,.92), rgba(5,6,10,.65), rgba(5,6,10,0));
      backdrop-filter: blur(10px);
    }
    .topRow{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}
    .brandName{font-weight:900; letter-spacing:.12em}
    .chip{
      margin-top:10px;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      overflow:hidden;
      white-space:nowrap;
    }
    .chip strong{font-weight:900}
    .rightBtns{display:flex; align-items:center; gap:10px}
    .cornerBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 14px;
      border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
    }

    /* Pages */
    .pages{padding: 6px 14px 18px;}
    .page{display:none}
    .page.active{display:block}
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .card + .card{margin-top:12px}
    .h1{font-size:22px; font-weight:950; margin:0 0 8px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .spacer{height:10px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      user-select:none;
    }
    .pill.red{border-color:rgba(255,27,27,.35); background:rgba(255,27,27,.10)}
    .btn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      padding:12px 14px;
      border-radius:16px;
      font-weight:850;
    }
    .btn.primary{
      border-color:rgba(255,27,27,.40);
      background:linear-gradient(180deg, rgba(255,27,27,.22), rgba(255,27,27,.12));
    }
    .btn:active{transform:translateY(1px)}
    .smallBtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      font-weight:800;
    }
    .smallBtn.active{
      border-color:rgba(255,27,27,.45);
      background:rgba(255,27,27,.12);
    }

    input, select{
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:var(--txt);
      outline:none;
    }
    input::placeholder{color:rgba(245,247,255,.35)}

    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:720px){ .two{grid-template-columns:1fr} }

    /* Bottom tabs */
    .tabsBottom{
      position:fixed; left:0; right:0; bottom:0; z-index:30;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(5,6,10,.92), rgba(5,6,10,.55), rgba(5,6,10,0));
      backdrop-filter: blur(12px);
      pointer-events:auto;
    }
    .tabBar{
      display:flex; gap:10px; justify-content:space-between;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius: 22px;
      padding: 10px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .tab{
      flex:1;
      text-align:center;
      padding:12px 8px;
      border-radius:16px;
      border:1px solid transparent;
      color:var(--mut);
      font-weight:900;
      user-select:none;
    }
    .tab.active{
      color:var(--txt);
      border-color:rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
    }

    /* Feed / posts */
    .post{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      border-radius: var(--r);
      padding:14px;
    }
    .post + .post{margin-top:10px}
    .postTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .userRow{display:flex; gap:10px; align-items:center}
    .avatar{
      width:38px;height:38px;border-radius:14px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      font-weight:950;
    }
    .tag{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      color:var(--mut);
      font-weight:900;
      font-size:12px;
    }
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}

    /* Modal */
    .modalBack{
      display:none;
      position:fixed; inset:0; z-index:40;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(10px);
      pointer-events:auto;
    }
    .modal{
      position:absolute; left:14px; right:14px; top:calc(12px + env(safe-area-inset-top));
      max-width:900px; margin:0 auto;
      border-radius: 24px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,16,22,.92), rgba(10,11,16,.92));
      box-shadow: 0 22px 90px rgba(0,0,0,.70);
      overflow:hidden;
    }
    .modalHeader{
      padding:14px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .xbtn{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      border-radius:14px;
      padding:10px 12px;
      font-weight:950;
    }
    .modalBody{padding:14px}
    ul{margin:8px 0 0 18px}

    /* Exercise SVG animations */
    .exSvg{width:100%; height:260px; display:block; border-radius:18px; border:1px solid rgba(255,255,255,.10); background:rgba(255,255,255,.03)}
    .rep{animation-duration:var(--repDur); animation-iteration-count:infinite; animation-timing-function:ease-in-out}
    .exPlay .squatBar{animation-name:squatBar}
    .exPlay .squatHip{animation-name:squatHip}
    .exPlay .squatTorso{animation-name:squatTorso}
    .exPlay .benchBar{animation-name:benchBar}
    .exPlay .benchForeL,.exPlay .benchForeR{animation-name:benchFore}
    .exPlay .curlForeL,.exPlay .curlForeR{animation-name:curlFore}
    .exPlay .curlDbL,.exPlay .curlDbR{animation-name:curlDb}
    .exPlay .kbSwingTorso{animation-name:kbTorso}
    .exPlay .kbSwingArms{animation-name:kbArms}
    .exPlay .kbSwingKB{animation-name:kbKB}

    @keyframes squatBar{0%,100%{transform:translateY(0)}50%{transform:translateY(56px)}}
    @keyframes squatHip{0%,100%{transform:translateY(0)}50%{transform:translateY(38px)}}
    @keyframes squatTorso{0%,100%{transform:rotate(0deg)}50%{transform:rotate(10deg)}}
    @keyframes benchBar{0%,100%{transform:translateY(0)}50%{transform:translateY(50px)}}
    @keyframes benchFore{0%,100%{transform:rotate(0deg)}50%{transform:rotate(18deg)}}
    @keyframes curlFore{0%,100%{transform:rotate(0deg)}50%{transform:rotate(-40deg)}}
    @keyframes curlDb{0%,100%{transform:translateY(0)}50%{transform:translateY(-22px)}}
    @keyframes kbTorso{0%,100%{transform:rotate(0deg) translateY(0)}50%{transform:rotate(12deg) translateY(6px)}}
    @keyframes kbArms{0%,100%{transform:rotate(0deg)}50%{transform:rotate(-14deg)}}
    @keyframes kbKB{0%,100%{transform:translateY(0)}50%{transform:translateY(-58px)}}

    /* Muscle Picker */
    .pickerWrap{display:grid; grid-template-columns:1fr; gap:12px}
    .pickerTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .pickerCanvas{
      border:1px solid rgba(255,255,255,.10);
      background: radial-gradient(500px 300px at 50% 25%, rgba(255,27,27,.08), transparent 70%),
                  rgba(255,255,255,.03);
      border-radius:24px;
      padding:12px;
      overflow:hidden;
    }
    .muscleSvg{width:100%; height:280px; display:block}
    .mPart{fill:rgba(255,27,27,.18); stroke:rgba(255,27,27,.55); stroke-width:2.2; cursor:pointer}
    .mPart.active{fill:rgba(255,27,27,.90); stroke:rgba(255,27,27,1)}
    .mGhost{fill:rgba(255,255,255,.04)}
    .selPills{display:flex; flex-wrap:wrap; gap:8px}
    .selCount{font-weight:950}

    /* Onboarding overlay */
    .onb{
      position:fixed; inset:0; z-index:60;
      background: radial-gradient(700px 500px at 50% 25%, rgba(255,27,27,.14), transparent 65%),
                  rgba(0,0,0,.84);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .onbCard{
      width:min(520px, 100%);
      border-radius:26px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(15,16,22,.92), rgba(10,11,16,.92));
      box-shadow:0 30px 120px rgba(0,0,0,.75);
      overflow:hidden;
    }
    .onbTop{
      padding:20px;
      display:flex; flex-direction:column; align-items:center; gap:14px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .onbLogo{
      width:88px;height:88px;border-radius:28px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
    }
    .onbLogo img{width:100%;height:100%;object-fit:cover}
    .onbBody{padding:16px}
    .onbActions{display:flex; gap:10px; margin-top:12px}
    .onbActions .btn{flex:1}
  </style>
</head>

<body>
  <!-- Onboarding -->
  <div class="onb" id="onb">
    <div class="onbCard">
      <div class="onbTop">
        <div class="onbLogo"><img src="./bear.png" alt="bear" onerror="this.style.display='none'"></div>
        <div style="text-align:center">
          <div style="font-weight:950; font-size:18px; letter-spacing:.08em">KRYPTA</div>
          <div class="muted2" id="onbStepTitle">Welcome</div>
        </div>
      </div>
      <div class="onbBody" id="onbBody"></div>
    </div>
  </div>

  <div class="app">
    <div class="topbar">
      <div class="topRow">
        <div class="brand">
          <div class="logo">
            <img src="./bear.png" alt="Krypta" onerror="this.style.display='none';document.getElementById('logoFallback').style.display='flex'">
            <div id="logoFallback" style="display:none; width:100%; height:100%; align-items:center; justify-content:center; font-weight:950">üêª</div>
          </div>
          <div>
            <div class="brandName">KRYPTA</div>
            <div class="muted2" style="font-size:12px">local demo</div>
          </div>
        </div>

        <div class="rightBtns">
          <button class="cornerBtn" id="notifBtn" title="Notifications">üîî <span id="notifCount" style="display:none; font-weight:950">0</span></button>
          <button class="cornerBtn" onclick="go('profile')">Profile</button>
        </div>
      </div>

      <div class="chip">
        <span>Streak</span><strong id="streakChip">0</strong>
        <span style="opacity:.45">‚Ä¢</span>
        <span>DNA</span><strong id="dnaChip">Hybrid</strong>
      </div>
    </div>

    <div class="pages">
      <!-- HOME -->
      <div class="page active" id="page-home">
        <div class="card">
          <div class="h1">Home</div>
          <div id="homeSummary" class="muted">‚Äî</div>
          <div class="spacer"></div>
          <div class="row">
            <button class="btn primary" onclick="go('create')">Create workout</button>
            <button class="btn" onclick="go('plan')">Weekly plan</button>
          </div>
          <div class="spacer"></div>
          <div class="muted2" id="coachNoteHome"></div>
        </div>

        <div class="card">
          <div class="h1">Feed</div>
          <div id="feedList" class="muted">No posts yet. Create one.</div>
        </div>
      </div>

      <!-- PLAN -->
      <div class="page" id="page-plan">
        <div class="card" id="planWeekCard">
          <div class="h1">Weekly plan</div>
          <div class="muted">Tap a day to open it.</div>
          <div class="spacer"></div>
          <div id="planList"></div>
          <div class="spacer"></div>
          <button class="btn" onclick="regenPlan()">Regenerate plan</button>
        </div>

        <div class="card" id="planDayCard" style="display:none">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="h1" id="planDayTitle">Day</div>
              <div class="muted" id="planDaySub">‚Äî</div>
            </div>
            <div class="pill" id="planDayTag">Gym</div>
          </div>
          <div class="spacer"></div>
          <div id="planDayBody" class="muted" style="white-space:pre-wrap">‚Äî</div>
          <div class="spacer"></div>
          <div class="row">
            <button class="btn primary" onclick="planGenerateSession()">Generate session</button>
            <button class="btn" onclick="closePlanDay()">Back</button>
          </div>
        </div>
      </div>

      <!-- CREATE -->
      <div class="page" id="page-create">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="h1">Create</div>
              <div class="muted">Pick muscles ‚Üí generate ‚Üí tap exercises for demo</div>
            </div>
            <div class="pill red" id="createModeTag">Gym</div>
          </div>

          <div class="spacer"></div>
          <div class="row">
            <button class="smallBtn active" id="btnModeGym" onclick="setCreateMode('gym')">Gym</button>
            <button class="smallBtn" id="btnModeWOD" onclick="setCreateMode('wod')">WOD</button>
            <button class="smallBtn" id="btnModeCardio" onclick="setCreateMode('cardio')">Cardio</button>
          </div>

          <div class="spacer"></div>

          <!-- Gym -->
          <div id="gymCard">
            <div class="two">
              <div>
                <label class="muted2">Goal</label>
                <select id="todayGoal">
                  <option value="muscle">Build muscle</option>
                  <option value="strong">Get strong</option>
                  <option value="cut">Cut</option>
                  <option value="sixpack">Sixpack</option>
                </select>
              </div>
              <div>
                <label class="muted2">Pain / injury note</label>
                <input id="todayPain" placeholder="e.g. sore knee, shoulder pinch"/>
              </div>
            </div>
            <div class="spacer"></div>

            <div class="pickerWrap">
              <div class="pickerTop">
                <div class="row">
                  <div class="pill">Selected: <span class="selCount" id="selCount">0</span></div>
                  <button class="smallBtn" onclick="clearSelection()">Clear</button>
                </div>
                <div class="row">
                  <button class="smallBtn active" id="btnFront" onclick="setView('front')">Front</button>
                  <button class="smallBtn" id="btnBack" onclick="setView('back')">Back</button>
                </div>
              </div>

              <div class="pickerCanvas">
                <!-- NEW muscle picker (red/black vibe) -->
                <svg class="muscleSvg" id="svgFront" viewBox="0 0 420 260" aria-label="front">
                  <!-- silhouette -->
                  <path class="mGhost" d="M210 18 C245 18 272 40 280 76 C286 108 270 124 256 134 C260 158 246 178 224 190 C220 214 214 244 210 244 C206 244 200 214 196 190 C174 178 160 158 164 134 C150 124 134 108 140 76 C148 40 175 18 210 18 Z"/>
                  <!-- eyes / shoulders-ish -->
                  <path id="f_shoulders" class="mPart" d="M80 56 C110 44 140 44 170 56 C150 70 100 70 80 56 Z"/>
                  <path id="f_chest" class="mPart" d="M250 56 C280 44 310 44 340 56 C320 70 270 70 250 56 Z"/>
                  <!-- core diamond -->
                  <path id="f_core" class="mPart" d="M300 115 L344 92 L388 115 L344 140 Z"/>
                  <!-- biceps/triceps blocks -->
                  <path id="f_biceps" class="mPart" d="M108 108 C130 98 150 100 162 116 C148 132 124 132 108 108 Z"/>
                  <path id="f_triceps" class="mPart" d="M244 108 C266 98 286 100 298 116 C284 132 260 132 244 108 Z"/>
                  <!-- legs -->
                  <path id="f_quads" class="mPart" d="M300 150 C336 150 360 170 356 202 C344 218 316 218 300 202 C288 184 288 168 300 150 Z"/>
                  <path id="f_calves" class="mPart" d="M80 168 C112 168 136 184 132 210 C120 224 96 224 80 210 C70 194 70 180 80 168 Z"/>
                </svg>

                <svg class="muscleSvg" id="svgBack" viewBox="0 0 420 260" aria-label="back" style="display:none">
                  <path class="mGhost" d="M210 18 C245 18 272 40 280 76 C286 108 270 124 256 134 C260 158 246 178 224 190 C220 214 214 244 210 244 C206 244 200 214 196 190 C174 178 160 158 164 134 C150 124 134 108 140 76 C148 40 175 18 210 18 Z"/>
                  <!-- traps -->
                  <path id="b_traps" class="mPart" d="M90 54 C128 38 166 38 204 54 C170 76 124 76 90 54 Z"/>
                  <!-- back -->
                  <path id="b_back" class="mPart" d="M240 52 C278 38 316 38 354 52 C320 76 274 76 240 52 Z"/>
                  <!-- glutes -->
                  <path id="b_glutes" class="mPart" d="M140 152 C170 134 250 134 280 152 C258 176 162 176 140 152 Z"/>
                  <!-- hams -->
                  <path id="b_hams" class="mPart" d="M160 178 C190 168 230 168 260 178 C244 208 176 208 160 178 Z"/>
                  <!-- calves -->
                  <path id="b_calves" class="mPart" d="M300 188 C332 188 356 202 352 226 C340 240 316 240 300 226 C290 212 290 200 300 188 Z"/>
                  <!-- triceps -->
                  <path id="b_triceps" class="mPart" d="M110 110 C132 100 152 102 164 118 C150 136 126 134 110 110 Z"/>
                </svg>

                <div class="spacer"></div>
                <div class="selPills" id="selectedPills"></div>
              </div>

              <div class="row">
                <button class="btn primary" onclick="generateGym()">Generate gym workout</button>
                <button class="btn" onclick="postLast()">Post to feed</button>
              </div>
            </div>
          </div>

          <!-- WOD -->
          <div id="wodCard" style="display:none">
            <div class="two">
              <div>
                <label class="muted2">Focus</label>
                <select id="wodFocus">
                  <option value="mixed">Mixed</option>
                  <option value="engine">Engine</option>
                  <option value="strength">Strength + Metcon</option>
                </select>
              </div>
              <div>
                <label class="muted2">Time (min)</label>
                <input id="wodTime" type="number" value="30"/>
              </div>
            </div>
            <div class="spacer"></div>
            <button class="btn primary" onclick="generateWOD()">Generate WOD</button>
            <button class="btn" onclick="postLast()">Post to feed</button>
          </div>

          <!-- Cardio -->
          <div id="cardioCard" style="display:none">
            <label class="muted2">Type</label>
            <select id="cardioType">
              <option>Easy run</option>
              <option>Intervals</option>
              <option>Walk</option>
              <option>Bike</option>
            </select>
            <div class="spacer"></div>
            <button class="btn primary" onclick="generateCardio()">Generate cardio</button>
            <button class="btn" onclick="postLast()">Post to feed</button>
          </div>
        </div>

        <div class="card" id="postCard" style="display:none">
          <div class="row" style="justify-content:space-between">
            <div>
              <div class="h1" id="postTitle">Workout</div>
              <div class="muted2" id="postMeta">‚Äî</div>
            </div>
            <button class="xbtn" onclick="hidePost()">X</button>
          </div>
          <div class="spacer"></div>
          <div id="postBody" class="muted" style="white-space:normal"></div>
          <div class="spacer"></div>
          <div class="muted2" id="postCoach"></div>
        </div>
      </div>

      <!-- RECIPES -->
      <div class="page" id="page-recipes">
        <div class="card">
          <div class="h1">Recipes</div>
          <div class="two">
            <input id="rName" placeholder="Recipe name"/>
            <select id="rType">
              <option>High protein</option>
              <option>Cut</option>
              <option>Bulk</option>
              <option>Quick</option>
            </select>
          </div>
          <div class="spacer"></div>
          <div class="two">
            <input id="rCals" placeholder="Calories (optional)"/>
            <input id="rProt" placeholder="Protein g (optional)"/>
          </div>
          <div class="spacer"></div>
          <input id="rIngr" placeholder="Ingredients (separate with commas)"/>
          <div class="spacer"></div>
          <input id="rSteps" placeholder="Steps (short)"/>
          <div class="spacer"></div>
          <button class="btn primary" onclick="addRecipe()">Post recipe</button>
        </div>

        <div class="card">
          <div class="h1">Latest</div>
          <div id="recipeList" class="muted">No recipes yet.</div>
        </div>
      </div>

      <!-- HISTORY -->
      <div class="page" id="page-history">
        <div class="card">
          <div class="h1">History</div>
          <div id="historyList" class="muted">No history yet.</div>
          <div class="spacer"></div>
          <button class="btn" onclick="clearHistory()">Clear history</button>
        </div>
      </div>

      <!-- PROFILE -->
      <div class="page" id="page-profile">
        <div class="card">
          <div class="h1">Profile</div>
          <div class="two">
            <input id="pName" placeholder="Display name"/>
            <select id="pGender">
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="spacer"></div>
          <div class="two">
            <input id="pHeight" type="number" placeholder="Height cm"/>
            <input id="pWeight" type="number" placeholder="Weight kg"/>
          </div>
          <div class="spacer"></div>
          <div class="two">
            <input id="pAge" type="number" placeholder="Age"/>
            <select id="pDays">
              <option value="3">3 days/week</option>
              <option value="4" selected>4 days/week</option>
              <option value="5">5 days/week</option>
              <option value="6">6 days/week</option>
            </select>
          </div>
          <div class="spacer"></div>
          <button class="btn primary" onclick="saveProfile()">Save</button>
          <button class="btn" onclick="resetAll()">Reset all (local)</button>
        </div>
      </div>
    </div>

    <!-- Bottom Tabs -->
    <div class="tabsBottom">
      <div class="tabBar">
        <div class="tab active" id="tab-home" onclick="go('home')">Home</div>
        <div class="tab" id="tab-plan" onclick="go('plan')">Plan</div>
        <div class="tab" id="tab-create" onclick="go('create')">Create</div>
        <div class="tab" id="tab-recipes" onclick="go('recipes')">Recipes</div>
        <div class="tab" id="tab-history" onclick="go('history')">History</div>
      </div>
    </div>
  </div>

  <!-- Notifications Panel -->
  <div class="modalBack" id="notifModal">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <b style="font-size:16px">Notifications</b>
          <div class="muted2" style="font-size:12px">Local demo</div>
        </div>
        <button class="xbtn" onclick="closeNotif()">X</button>
      </div>
      <div class="modalBody" id="notifList">
        <div class="muted">No notifications yet.</div>
      </div>
    </div>
  </div>

  <!-- Exercise Modal -->
  <div class="modalBack" id="exModal">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <b id="exTitle">Exercise</b>
          <div class="muted2" id="exMuscles">‚Äî</div>
        </div>
        <button class="xbtn" onclick="closeExercise()">X</button>
      </div>
      <div class="modalBody">
        <div id="exPic"></div>
        <div class="spacer"></div>
        <div class="row">
          <button class="smallBtn active" id="exPlayBtn" onclick="toggleExPlay()">‚è∏ Pause</button>
          <button class="smallBtn" onclick="setExSpeed(1200)">Fast</button>
          <button class="smallBtn active" id="exSpeedMid" onclick="setExSpeed(1800)">Normal</button>
          <button class="smallBtn" onclick="setExSpeed(2400)">Slow</button>
        </div>
        <div class="spacer"></div>
        <div class="muted"><b id="exCue">Cue:</b></div>
        <div class="muted" id="exHow" style="margin-top:6px"></div>
        <ul class="muted" id="exTips"></ul>
      </div>
    </div>
  </div>

  <script>
    /* =========
      State / Storage
    ========= */
    const LS_PROFILE="krypta_profile_v2";
    const LS_FEED="krypta_feed_v2";
    const LS_HISTORY="krypta_history_v2";
    const LS_PLAN="krypta_plan_v2";
    const LS_RECIPES="krypta_recipes_v2";
    const LS_NOTIFS="krypta_notifs_v2";
    const LS_ONB="krypta_onb_v2";

    const weekDays=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];

    let profile = loadProfile() || {
      name:"KryptaUser",
      gender:"male",
      height:180,
      weight:80,
      age:20,
      days:4
    };

    let selectedFront=[];
    let selectedBack=[];
    let view="front";
    let lastPostDraft=null;
    let createMode="gym";
    let currentPlanDay=null;

    function loadProfile(){ try{return JSON.parse(localStorage.getItem(LS_PROFILE)||"null");}catch{return null;} }
    function saveProfileLS(){ localStorage.setItem(LS_PROFILE, JSON.stringify(profile)); }

    function loadFeed(){ try{const x=JSON.parse(localStorage.getItem(LS_FEED)||"[]"); return Array.isArray(x)?x:[]}catch{return [];} }
    function saveFeed(items){ localStorage.setItem(LS_FEED, JSON.stringify(items)); }
    function loadHistory(){ try{const x=JSON.parse(localStorage.getItem(LS_HISTORY)||"[]"); return Array.isArray(x)?x:[]}catch{return [];} }
    function saveHistory(items){ localStorage.setItem(LS_HISTORY, JSON.stringify(items)); }

    function loadPlan(){ try{return JSON.parse(localStorage.getItem(LS_PLAN)||"null");}catch{return null;} }
    function savePlan(p){ localStorage.setItem(LS_PLAN, JSON.stringify(p)); }

    function loadRecipes(){ try{const x=JSON.parse(localStorage.getItem(LS_RECIPES)||"[]"); return Array.isArray(x)?x:[]}catch{return [];} }
    function saveRecipes(items){ localStorage.setItem(LS_RECIPES, JSON.stringify(items)); }

    function loadNotifs(){ try{const x=JSON.parse(localStorage.getItem(LS_NOTIFS)||"[]"); return Array.isArray(x)?x:[]}catch{return [];} }
    function saveNotifs(items){ localStorage.setItem(LS_NOTIFS, JSON.stringify(items)); }

    function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));}
    function clamp(n,a,b){return Math.max(a, Math.min(b,n));}
    function niceGoal(g){return g==="strong"?"Strength":g==="cut"?"Cut":g==="sixpack"?"Sixpack":"Muscle";}
    function isoDateLocal(d){ const z=new Date(d.getTime()-d.getTimezoneOffset()*60000); return z.toISOString().slice(0,10); }
    function daysBetween(aISO,bISO){ return Math.round((new Date(bISO)-new Date(aISO))/86400000); }

    /* =========
      Navigation
    ========= */
    function go(page){
      document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
      document.getElementById("page-"+page).classList.add("active");

      document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
      const tab=document.getElementById("tab-"+page);
      if(tab) tab.classList.add("active");

      // keep plan day card hidden unless on plan and opened
      if(page!=="plan"){
        document.getElementById("planDayCard").style.display="none";
        document.getElementById("planWeekCard").style.display="block";
      }
      // keep scroll predictable on mobile
      window.scrollTo(0,0);
    }

    /* =========
      Streak + DNA (simple)
    ========= */
    function computeStreak(){
      const hist=loadHistory();
      if(!hist.length) return {current:0,best:0,last:null};
      const days=[...new Set(hist.map(h=>isoDateLocal(new Date(h.createdAt))))].sort();
      let best=1, cur=1;
      for(let i=1;i<days.length;i++){
        const diff=daysBetween(days[i-1],days[i]);
        cur = diff===1 ? cur+1 : 1;
        best=Math.max(best,cur);
      }
      const last=days[days.length-1];
      // current streak only if last is today or yesterday chain to today
      const today=isoDateLocal(new Date());
      const diff=daysBetween(last,today);
      const current = (diff===0||diff===1) ? cur : 0;
      return {current, best, last};
    }
    function computeDNA(){
      const hist=loadHistory();
      const last30 = hist.filter(h => Date.now()-new Date(h.createdAt).getTime() <= 30*86400000);
      const gym=last30.filter(x=>x.type==="Gym").length;
      const wod=last30.filter(x=>x.type==="WOD").length;
      const cardio=last30.filter(x=>x.type==="Cardio").length;
      const total=Math.max(1,gym+wod+cardio);
      const g=gym/total,w=wod/total,c=cardio/total;
      if(g>=0.7) return "Strength";
      if(c>=0.6) return "Engine";
      if(w>=0.5) return "CrossFit";
      return "Hybrid";
    }

    function renderHomeHeader(){
      const st=computeStreak();
      const dna=computeDNA();
      document.getElementById("streakChip").textContent=String(st.current||0);
      document.getElementById("dnaChip").textContent=dna;

      document.getElementById("homeSummary").innerHTML =
        `<b>${esc(profile.name)}</b> ‚Ä¢ ${profile.days} days/week
         <span class="muted"> ‚Ä¢ ${profile.height}cm ‚Ä¢ ${profile.weight}kg ‚Ä¢ age ${profile.age}</span>
         <br><span class="muted">Streak: ${st.current||0} ‚Ä¢ Best: ${st.best||0} ‚Ä¢ DNA: ${esc(dna)}</span>`;

      const el=document.getElementById("coachNoteHome");
      if(!st.last) el.textContent="Private coach note: start small. One session is momentum.";
      else{
        const today=isoDateLocal(new Date());
        const diff=daysBetween(st.last,today);
        el.textContent = diff===0 ? "Private coach note: you trained today. Protect sleep + protein."
                    : diff===1 ? "Private coach note: train today to keep the streak alive."
                    : "Private coach note: no pressure. A short session restarts momentum.";
      }
    }

    /* =========
      Plan
    ========= */
    function generatePlan(){
      const days=clamp(Number(profile.days||4),3,6);
      const splitByDays={
        3:["Gym","Cardio","Gym"],
        4:["Gym","Cardio","Gym","WOD"],
        5:["Gym","Cardio","Gym","WOD","Gym"],
        6:["Gym","Cardio","Gym","WOD","Gym","Cardio"]
      }[days];

      const labels={
        Gym:["Upper Strength","Lower Strength","Full Body","Pull Focus","Push Focus"],
        Cardio:["Easy Zone 2","Intervals","Hill Walk","Tempo Run","Long Walk"],
        WOD:["Mixed Metcon","Strength + Metcon","Engine Builder","Chipper","EMOM"]
      };

      const plan={createdAt:new Date().toISOString(), days:{}};
      let idx=0;
      weekDays.forEach(d=>{
        if(idx<splitByDays.length){
          const kind=splitByDays[idx++];
          const arr=labels[kind];
          plan.days[d]={kind, label: arr[Math.floor(Math.random()*arr.length)]};
        }else{
          plan.days[d]={kind:"Rest", label:"Recovery + mobility"};
        }
      });
      savePlan(plan);
      return plan;
    }
    function getPlan(){ return loadPlan() || generatePlan(); }
    function regenPlan(){ generatePlan(); renderPlan(); notify("Plan regenerated"); }

    function renderPlan(){
      const plan=getPlan();
      const host=document.getElementById("planList");
      host.innerHTML = weekDays.map(d=>{
        const it=plan.days[d];
        return `
          <div class="post" style="cursor:pointer" onclick="openPlanDay('${d}')">
            <div class="postTop">
              <div>
                <div style="font-weight:950">${esc(d)}</div>
                <div class="muted">${esc(it.label||"")}</div>
              </div>
              <div class="tag">${esc(it.kind)}</div>
            </div>
          </div>
        `;
      }).join("");
    }

    function openPlanDay(day){
      currentPlanDay=day;
      const plan=getPlan();
      const it=plan.days[day];
      document.getElementById("planWeekCard").style.display="none";
      document.getElementById("planDayCard").style.display="block";
      document.getElementById("planDayTitle").textContent=day;
      document.getElementById("planDayTag").textContent=it.kind;
      document.getElementById("planDaySub").textContent = it.kind==="Rest" ? "Recovery focus"
        : "Tap Generate session to see exercises (clickable).";

      // default body
      document.getElementById("planDayBody").innerHTML =
        it.kind==="Rest"
        ? `‚Ä¢ 20‚Äì40 min easy walk\n‚Ä¢ 8‚Äì12 min mobility\n‚Ä¢ 5 min breathing`
        : `Warm-up is always first.\nMain: ${esc(it.label)}\n\nPress ‚ÄúGenerate session‚Äù.`;
    }

    function closePlanDay(){
      document.getElementById("planDayCard").style.display="none";
      document.getElementById("planWeekCard").style.display="block";
      currentPlanDay=null;
    }

    function planGenerateSession(){
      if(!currentPlanDay) return;
      const plan=getPlan();
      const it=plan.days[currentPlanDay];
      if(it.kind==="Rest"){ return; }

      if(it.kind==="Cardio"){
        const text = [
          "Warm-up:",
          "‚Ä¢ 5 min easy pace",
          "‚Ä¢ 3 x 20s faster + 40s easy",
          "",
          "Main:",
          `‚Ä¢ ${it.label}`,
          "‚Ä¢ Total: 25‚Äì45 min",
          "",
          "Cool-down:",
          "‚Ä¢ 3‚Äì5 min easy walk + breathing"
        ].join("\n");
        document.getElementById("planDayBody").innerHTML = `<div class="muted" style="white-space:pre-wrap">${esc(text)}</div>`;
        return;
      }

      if(it.kind==="WOD"){
        // generate quick WOD text
        const t=30;
        const text=[
          "Warm-up:",
          "‚Ä¢ 4 min easy row/bike",
          "‚Ä¢ 2 rounds: 10 air squats + 10 push-ups + 10 sit-ups",
          "",
          "WOD:",
          `‚Ä¢ ${it.label}`,
          "‚Ä¢ Keep pace sustainable",
          "",
          "Cool-down:",
          "‚Ä¢ 2 min breathing + stretch hips/lats"
        ].join("\n");
        document.getElementById("planDayBody").innerHTML = `<div class="muted" style="white-space:pre-wrap">${esc(text)}</div>`;
        return;
      }

      // Gym day: show real exercises (clickable)
      const muscles=[]; // plan day should be generic, so we use defaults
      const goal = document.getElementById("todayGoal")?.value || "muscle";
      const pain = document.getElementById("todayPain")?.value || "";

      const g = pickGymExercises(muscles, goal, pain);
      const lines=[];
      lines.push("Warm-up:");
      g.warm.forEach(x=>lines.push("‚Ä¢ "+x));
      lines.push("");
      lines.push("Main + Accessories:");
      g.blocks.forEach(b=>lines.push(`‚Ä¢ ${b.name} ‚Äî ${b.sets} (${b.rest})`));
      lines.push("");
      lines.push("Cool-down:");
      lines.push("‚Ä¢ 3‚Äì5 min easy walk + 2 min breathing");

      document.getElementById("planDayBody").innerHTML = renderWorkoutTextWithExerciseLinks(lines.join("\n"));
    }

    /* =========
      Muscle Picker: selection + sync
    ========= */
    function currentSelection(){ return view==="front" ? selectedFront : selectedBack; }
    function setCurrentSelection(arr){ if(view==="front") selectedFront=arr; else selectedBack=arr; }

    function setView(v){
      view=v;
      document.getElementById("svgFront").style.display = v==="front"?"block":"none";
      document.getElementById("svgBack").style.display = v==="back"?"block":"none";
      document.getElementById("btnFront").classList.toggle("active", v==="front");
      document.getElementById("btnBack").classList.toggle("active", v==="back");
      syncSvg(); renderPills();
    }
    function clearSelection(){ setCurrentSelection([]); syncSvg(); renderPills(); }

    function setActive(id,on){
      const el=document.getElementById(id);
      if(el) el.classList.toggle("active", !!on);
    }
    function syncSvg(){
      const f=selectedFront, b=selectedBack;
      setActive("f_shoulders", f.includes("Shoulders"));
      setActive("f_chest", f.includes("Chest"));
      setActive("f_core", f.includes("Core"));
      setActive("f_biceps", f.includes("Biceps"));
      setActive("f_triceps", f.includes("Triceps"));
      setActive("f_quads", f.includes("Quads"));
      setActive("f_calves", f.includes("Calves"));

      setActive("b_traps", b.includes("Traps"));
      setActive("b_back", b.includes("Back"));
      setActive("b_triceps", b.includes("Triceps"));
      setActive("b_glutes", b.includes("Glutes"));
      setActive("b_hams", b.includes("Hamstrings"));
      setActive("b_calves", b.includes("Calves"));

      document.getElementById("selCount").textContent=String(currentSelection().length);
    }
    function renderPills(){
      const wrap=document.getElementById("selectedPills");
      const uniq=[...new Set(currentSelection())].sort();
      if(!uniq.length){ wrap.innerHTML=`<span class="muted">No muscles selected.</span>`; return; }
      wrap.innerHTML = uniq.map(m=>`<span class="pill red" style="cursor:pointer" onclick="removeMuscle('${m}')">üí™ ${esc(m)} ‚úï</span>`).join("");
    }
    function removeMuscle(m){
      setCurrentSelection(currentSelection().filter(x=>x!==m));
      syncSvg(); renderPills();
    }

    // Click handlers (direct, not a giant document click that can break taps)
    function wirePicker(){
      const mapFront={
        f_shoulders:"Shoulders", f_chest:"Chest", f_core:"Core",
        f_biceps:"Biceps", f_triceps:"Triceps", f_quads:"Quads", f_calves:"Calves"
      };
      const mapBack={
        b_traps:"Traps", b_back:"Back", b_triceps:"Triceps",
        b_glutes:"Glutes", b_hams:"Hamstrings", b_calves:"Calves"
      };
      Object.keys(mapFront).forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.addEventListener("click",(e)=>{
          e.stopPropagation();
          const m=mapFront[id];
          const sel=currentSelection();
          setCurrentSelection(sel.includes(m) ? sel.filter(x=>x!==m) : [...sel,m]);
          syncSvg(); renderPills();
        });
      });
      Object.keys(mapBack).forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.addEventListener("click",(e)=>{
          e.stopPropagation();
          const m=mapBack[id];
          const sel=currentSelection();
          setCurrentSelection(sel.includes(m) ? sel.filter(x=>x!==m) : [...sel,m]);
          syncSvg(); renderPills();
        });
      });
    }

    /* =========
      Exercise Library + Demos
    ========= */
    const EX = {
      "Barbell Back Squat": {
        muscles:["Quads","Glutes","Core"],
        cue:"Brace + sit between hips.",
        how:"Set bar on upper traps. Big breath, brace, sit down/back. Knees track over toes. Stand by pushing the floor away.",
        tips:["Mid-foot pressure.","Depth only if pain-free.","Drive hips + chest together."],
        demo: demoSquat
      },
      "Bench Press": {
        muscles:["Chest","Triceps","Shoulders"],
        cue:"Touch lower chest, press up/back.",
        how:"Eyes under bar. Feet planted. Lower with control. Press up and slightly back. Keep wrists stacked.",
        tips:["Shoulder blades back + down.","Forearms vertical at bottom.","Don‚Äôt bounce."],
        demo: demoBench
      },
      "Lat Pulldown": {
        muscles:["Back","Biceps"],
        cue:"Pull elbows to ribs.",
        how:"Slight lean back. Pull to upper chest. Control the return.",
        tips:["Don‚Äôt yank.","Ribs down.","Squeeze lats at bottom."],
        demo: demoPulldown
      },
      "Romanian Deadlift": {
        muscles:["Hamstrings","Glutes","Back"],
        cue:"Hips back. Shins mostly vertical.",
        how:"Soft knees. Hinge back. Bar slides down thighs. Stop at hamstring stretch. Stand by driving hips forward.",
        tips:["Neutral spine.","Bar close.","Slow down phase."],
        demo: demoRDL
      },
      "Dumbbell Curl": {
        muscles:["Biceps"],
        cue:"Elbows still. Squeeze.",
        how:"Curl without swinging. Control down fully.",
        tips:["Slow eccentric.","No shrug.","Full range."],
        demo: demoCurl
      },
      "Kettlebell Swing": {
        muscles:["Glutes","Hamstrings","Core"],
        cue:"Hinge snap. Arms are ropes.",
        how:"Hike KB back then snap hips. KB floats to chest height. Repeat smooth.",
        tips:["Neutral spine.","KB close.","Power from hips."],
        demo: demoKBSwing
      }
    };

    function demoStatic(title, note){
      return `
      <svg class="exSvg" viewBox="0 0 860 360">
        <text x="30" y="42" fill="rgba(245,247,255,.92)" font-size="20" font-weight="900">${esc(title)}</text>
        <text x="30" y="72" fill="rgba(245,247,255,.70)" font-size="14">${esc(note)}</text>
        <rect x="70" y="100" width="720" height="230" rx="18" fill="rgba(255,255,255,.03)" stroke="rgba(255,255,255,.10)"/>
      </svg>`;
    }

    function demoPulldown(){ return demoStatic("Lat Pulldown", "Preview (tap other exercises for animations)."); }
    function demoRDL(){ return demoStatic("Romanian Deadlift", "Preview (animated demos: Squat, Bench, Curl, Swing)."); }

    function demoSquat(){
      return `
      <svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
        <path d="M150 90 V320 M710 90 V320" stroke="rgba(245,247,255,.18)" stroke-width="8" stroke-linecap="round"/>
        <path d="M140 90 H720" stroke="rgba(245,247,255,.12)" stroke-width="10" stroke-linecap="round"/>
        <g class="rep squatBar" style="transform-origin:430px 120px;">
          <rect x="250" y="110" width="360" height="14" rx="7" fill="rgba(245,247,255,.85)"/>
          <circle cx="240" cy="117" r="26" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
          <circle cx="620" cy="117" r="26" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
        </g>
        <g class="rep squatHip" style="transform-origin:430px 185px;">
          <g class="rep squatTorso" style="transform-origin:430px 175px;">
            <circle cx="430" cy="140" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
            <path d="M430 160 L430 220" stroke="rgba(245,247,255,.85)" stroke-width="8" stroke-linecap="round"/>
            <path d="M430 185 L360 120" stroke="rgba(245,247,255,.75)" stroke-width="7" stroke-linecap="round"/>
            <path d="M430 185 L500 120" stroke="rgba(245,247,255,.75)" stroke-width="7" stroke-linecap="round"/>
          </g>
          <circle cx="430" cy="230" r="10" fill="rgba(245,247,255,.55)"/>
          <path d="M430 230 L408 270" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
          <path d="M430 230 L452 270" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
          <path d="M408 270 L390 312" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
          <path d="M452 270 L470 312" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
          <path d="M370 318 H405" stroke="rgba(245,247,255,.75)" stroke-width="10" stroke-linecap="round"/>
          <path d="M455 318 H490" stroke="rgba(245,247,255,.75)" stroke-width="10" stroke-linecap="round"/>
        </g>
      </svg>`;
    }

    function demoBench(){
      return `
      <svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
        <rect x="220" y="240" width="420" height="26" rx="13" fill="rgba(255,255,255,.08)" stroke="rgba(255,255,255,.14)"/>
        <rect x="280" y="266" width="26" height="60" rx="13" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.12)"/>
        <rect x="560" y="266" width="26" height="60" rx="13" fill="rgba(255,255,255,.06)" stroke="rgba(255,255,255,.12)"/>

        <g class="rep benchBar" style="transform-origin:430px 150px;">
          <rect x="260" y="144" width="340" height="12" rx="6" fill="rgba(245,247,255,.85)"/>
          <circle cx="250" cy="150" r="22" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
          <circle cx="610" cy="150" r="22" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
        </g>

        <circle cx="355" cy="235" r="18" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
        <path d="M375 235 L520 235" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
        <path d="M520 235 L610 275" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>

        <g class="rep benchForeL" style="transform-origin:365px 190px;">
          <path d="M420 235 L380 210" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
          <path d="M380 210 L350 170" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
        </g>
        <g class="rep benchForeR" style="transform-origin:495px 190px;">
          <path d="M420 235 L480 210" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
          <path d="M480 210 L510 170" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
        </g>
      </svg>`;
    }

    function demoCurl(){
      return `
      <svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
        <circle cx="430" cy="95" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
        <path d="M430 115 L430 200" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
        <circle cx="430" cy="205" r="10" fill="rgba(245,247,255,.55)"/>
        <path d="M430 210 L405 290" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
        <path d="M430 210 L455 290" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>

        <path d="M430 150 L375 190" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
        <g class="rep curlForeL" style="transform-origin:375px 190px;">
          <path d="M375 190 L345 240" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
          <g class="rep curlDbL" style="transform-origin:345px 240px;">
            <rect x="325" y="240" width="40" height="10" rx="5" fill="rgba(245,247,255,.85)"/>
            <circle cx="325" cy="245" r="10" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="3"/>
            <circle cx="365" cy="245" r="10" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="3"/>
          </g>
        </g>

        <path d="M430 150 L485 190" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
        <g class="rep curlForeR" style="transform-origin:485px 190px;">
          <path d="M485 190 L515 240" stroke="rgba(245,247,255,.85)" stroke-width="9" stroke-linecap="round"/>
          <g class="rep curlDbR" style="transform-origin:515px 240px;">
            <rect x="495" y="240" width="40" height="10" rx="5" fill="rgba(245,247,255,.85)"/>
            <circle cx="495" cy="245" r="10" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="3"/>
            <circle cx="535" cy="245" r="10" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="3"/>
          </g>
        </g>
      </svg>`;
    }

    function demoKBSwing(){
      return `
      <svg class="exSvg exPlay" id="exSvg" viewBox="0 0 860 360">
        <g class="rep kbSwingTorso" style="transform-origin:430px 170px;">
          <circle cx="430" cy="95" r="20" fill="rgba(255,255,255,.06)" stroke="rgba(245,247,255,.28)" stroke-width="3"/>
          <path d="M430 115 L430 200" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
        </g>
        <circle cx="430" cy="205" r="10" fill="rgba(245,247,255,.55)"/>
        <path d="M430 210 L405 300" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>
        <path d="M430 210 L455 300" stroke="rgba(245,247,255,.85)" stroke-width="10" stroke-linecap="round"/>

        <g class="rep kbSwingArms" style="transform-origin:430px 185px;">
          <path d="M430 160 L390 220" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
          <path d="M430 160 L470 220" stroke="rgba(245,247,255,.8)" stroke-width="9" stroke-linecap="round"/>
        </g>

        <g class="rep kbSwingKB" style="transform-origin:430px 245px;">
          <path d="M410 245 C410 270 450 270 450 245" fill="rgba(255,255,255,.08)" stroke="rgba(245,247,255,.55)" stroke-width="4"/>
          <circle cx="430" cy="260" r="12" fill="rgba(245,247,255,.20)" stroke="rgba(245,247,255,.35)" stroke-width="2"/>
        </g>
      </svg>`;
    }

    let exPlaying=true;
    let exSpeed=1800;

    function openExercise(name){
      const ex=EX[name];
      if(!ex){ alert("Exercise not found."); return; }
      document.getElementById("exTitle").textContent=name;
      document.getElementById("exMuscles").textContent="Muscles: "+(ex.muscles||[]).join(", ");
      document.getElementById("exHow").textContent=ex.how||"";
      document.getElementById("exCue").textContent="Cue: "+(ex.cue||"‚Äî");
      const tips=document.getElementById("exTips");
      tips.innerHTML="";
      (ex.tips||[]).forEach(t=>{ const li=document.createElement("li"); li.textContent=t; tips.appendChild(li); });
      document.getElementById("exPic").innerHTML = ex.demo ? ex.demo() : demoStatic(name,"Preview");
      setExSpeed(exSpeed);
      exPlaying=true;
      syncExPlayUI();
      document.getElementById("exModal").style.display="block";
    }
    function closeExercise(){ document.getElementById("exModal").style.display="none"; }
    function toggleExPlay(){ exPlaying=!exPlaying; syncExPlayUI(); }
    function syncExPlayUI(){
      const svg=document.getElementById("exSvg");
      const btn=document.getElementById("exPlayBtn");
      if(svg){
        svg.classList.toggle("exPlay", exPlaying);
        svg.querySelectorAll(".rep").forEach(n=>{ n.style.animationPlayState = exPlaying ? "running" : "paused"; });
      }
      if(btn){
        btn.textContent = exPlaying ? "‚è∏ Pause" : "‚ñ∂ Play";
        btn.classList.toggle("active", exPlaying);
      }
    }
    function setExSpeed(ms){
      exSpeed=ms;
      document.documentElement.style.setProperty("--repDur", ms+"ms");
      const mid=document.getElementById("exSpeedMid");
      if(mid) mid.classList.toggle("active", ms===1800);
    }

    function renderWorkoutTextWithExerciseLinks(text){
      let safe=esc(text).replaceAll("\n","<br>");
      Object.keys(EX).forEach(name=>{
        const escName=name.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");
        safe = safe.replace(new RegExp(escName,"g"),
          `<span class="pill red" style="cursor:pointer; display:inline-flex; margin:2px 0" onclick="openExercise('${name.replaceAll("'","\\'")}')">‚ñ∂ ${esc(name)}</span>`);
      });
      return `<div style="white-space:normal">${safe}</div>`;
    }

    /* =========
      Gym generator (5‚Äì8 moves, uses EX names so they click)
    ========= */
    function warmupForMuscles(muscles){
      const set=new Set(muscles||[]);
      const drills=[];
      drills.push("3‚Äì5 min easy warm-up: bike/row/jog + nasal breathing");
      if(set.has("Chest")||set.has("Shoulders")||set.has("Triceps")||set.has("Biceps")||set.has("Back")||set.has("Traps")){
        drills.push("2 rounds: 10 band pull-aparts + 10 scap push-ups + 8 PVC pass-throughs");
      }
      if(set.has("Quads")||set.has("Glutes")||set.has("Hamstrings")||set.has("Calves")){
        drills.push("2 rounds: 10 air squats + 10 hip hinges + 20 calf bounces");
      }
      if(set.has("Core")){
        drills.push("2 rounds: 20s dead-bug + 20s side plank each side");
      }
      drills.push("1‚Äì2 ramp-up sets per lift before working sets");
      return drills;
    }

    function pickGymExercises(muscles, goal="muscle", pain=""){
      // simple + reliable pools (all exist in EX)
      const used=new Set();
      const blocks=[];
      const scheme = goal==="strong"
        ? {main:"5 x 3‚Äì5", sec:"4 x 5‚Äì8", acc:"3 x 8‚Äì12", core:"3 x 30‚Äì45s"}
        : (goal==="cut"||goal==="sixpack")
        ? {main:"4 x 6‚Äì10", sec:"3 x 8‚Äì12", acc:"2‚Äì3 x 12‚Äì15", core:"4 x 10‚Äì15"}
        : {main:"4 x 6‚Äì10", sec:"3 x 8‚Äì12", acc:"3 x 10‚Äì15", core:"3 x 10‚Äì15"};

      const rest = (t)=> t==="main"?"Rest 2‚Äì3 min" : t==="sec"?"Rest 90‚Äì120s" : t==="acc"?"Rest 60‚Äì90s" : "Rest 45‚Äì60s";

      const poolMain = ["Barbell Back Squat","Bench Press","Romanian Deadlift","Lat Pulldown"];
      const poolAcc  = ["Dumbbell Curl","Kettlebell Swing","Lat Pulldown","Bench Press"];

      function pick(arr){
        const opt=arr.filter(x=>!used.has(x));
        return opt.length ? opt[Math.floor(Math.random()*opt.length)] : arr[Math.floor(Math.random()*arr.length)];
      }

      // main 1 + main 2
      const m1=pick(poolMain); used.add(m1); blocks.push({name:m1, sets:scheme.main, rest:rest("main")});
      const m2=pick(poolMain); used.add(m2); blocks.push({name:m2, sets:scheme.sec, rest:rest("sec")});

      // accessories 3‚Äì4
      while(blocks.length<5){
        const ex=pick(poolAcc); used.add(ex);
        blocks.push({name:ex, sets:scheme.acc, rest:rest("acc")});
      }

      // optional extra (goal based)
      if(goal==="cut"||goal==="sixpack"){
        blocks.push({name:"Kettlebell Swing", sets:"8‚Äì12 min intervals (smooth reps)", rest:"‚Äî"});
      }

      // cap 8
      const warm=warmupForMuscles(muscles);
      return {warm, blocks: blocks.slice(0,8)};
    }

    function generateGym(){
      const muscles=[...new Set([...selectedFront,...selectedBack])];
      const goal=document.getElementById("todayGoal").value || "muscle";
      const pain=document.getElementById("todayPain").value || "";
      const g=pickGymExercises(muscles, goal, pain);

      const lines=[];
      lines.push("Warm-up:");
      g.warm.forEach(x=>lines.push("‚Ä¢ "+x));
      lines.push("");
      lines.push("Main + Accessories:");
      g.blocks.forEach(b=>lines.push(`‚Ä¢ ${b.name} ‚Äî ${b.sets} (${b.rest})`));
      lines.push("");
      lines.push("Cool-down:");
      lines.push("‚Ä¢ 3‚Äì5 min easy walk + 2 min breathing");

      let coach="Keep form clean. Stop 1‚Äì2 reps before failure on most sets.";
      if(pain.trim()) coach=`Pain noted: "${pain.trim()}". Swap any painful movement. Keep range pain-free.`;

      lastPostDraft={type:"Gym", title:`Gym: ${niceGoal(goal)}`, text:lines.join("\n"), coachNote:coach, meta:{goal,muscles,pain}};
      renderPostCard(lastPostDraft);
    }

    function generateWOD(){
      const focus=document.getElementById("wodFocus").value;
      const time=clamp(Number(document.getElementById("wodTime").value||30),10,60);
      const strength = focus==="strength"
        ? ["Back Squat 5 x 3 (build)","Bench Press 5 x 5 (moderate)","Deadlift 5 x 2 (clean)"][Math.floor(Math.random()*3)]
        : ["Skill: 10 min double-under practice","Skill: 10 min strict pull-up sets","Skill: 10 min handstand line holds"][Math.floor(Math.random()*3)];
      const metcon = `${clamp(time-12,8,25)} min AMRAP: 10 burpees + 20 air squats + 10 kettlebell swings`;
      const text=[
        "Warm-up:","‚Ä¢ 4 min easy row/bike","‚Ä¢ 2 rounds: 10 air squats + 10 push-ups + 10 sit-ups",
        "","Strength/Skill:","‚Ä¢ "+strength,"","Metcon:","‚Ä¢ "+metcon,
        "","Cool-down:","‚Ä¢ 2 min breathing + stretch hips/lats"
      ].join("\n");

      lastPostDraft={type:"WOD", title:`WOD: ${focus}`, text, coachNote:"Smooth reps > redline.", meta:{focus,time}};
      renderPostCard(lastPostDraft);
    }

    function generateCardio(){
      const type=document.getElementById("cardioType").value;
      const text=[
        `Type: ${type}`,
        "Warm-up: 5 min easy",
        "Main: 25‚Äì45 min steady OR intervals depending on choice",
        "Cool-down: 3‚Äì5 min walk + breathing"
      ].join("\n");

      lastPostDraft={type:"Cardio", title:`Cardio: ${type}`, text, coachNote:"Steady work counts.", meta:{type}};
      renderPostCard(lastPostDraft);
    }

    function renderPostCard(p){
      document.getElementById("postCard").style.display="block";
      document.getElementById("postTitle").textContent=p.title||"Workout";
      document.getElementById("postMeta").textContent=`${p.type} ‚Ä¢ ${new Date().toLocaleString()}`;
      document.getElementById("postCoach").textContent=p.coachNote||"";
      document.getElementById("postBody").innerHTML = renderWorkoutTextWithExerciseLinks(p.text||"");
    }
    function hidePost(){ document.getElementById("postCard").style.display="none"; }

    function postLast(){
      if(!lastPostDraft){ alert("Generate something first."); return; }
      const items=loadFeed();
      const id="p_"+Date.now();
      items.unshift({id, createdAt:new Date().toISOString(), author:profile.name, ...lastPostDraft});
      saveFeed(items);

      const hist=loadHistory();
      hist.unshift({id:"h_"+Date.now(), createdAt:new Date().toISOString(), type:lastPostDraft.type, title:lastPostDraft.title, sub:lastPostDraft.type});
      saveHistory(hist);

      notify(`Posted: ${lastPostDraft.title}`);
      renderFeed(); renderHistory(); renderHomeHeader();
      hidePost();
      go("home");
    }

    function renderFeed(){
      const host=document.getElementById("feedList");
      const items=loadFeed();
      if(!items.length){ host.innerHTML=`<div class="muted">No posts yet. Create one.</div>`; return; }
      host.innerHTML = items.slice(0,25).map(p=>{
        const dt=new Date(p.createdAt).toLocaleString();
        return `
          <div class="post">
            <div class="postTop">
              <div class="userRow">
                <div class="avatar">${esc((p.author||"K")[0])}</div>
                <div>
                  <div style="font-weight:950">${esc(p.author||"KryptaUser")}</div>
                  <div class="muted2">${esc(dt)}</div>
                </div>
              </div>
              <div class="tag">${esc(p.type||"")}</div>
            </div>
            <div style="margin-top:10px; font-weight:950">${esc(p.title||"Workout")}</div>
            <div style="margin-top:8px" class="muted">${renderWorkoutTextWithExerciseLinks(p.text||"")}</div>
            <div class="muted2" style="margin-top:10px">${esc(p.coachNote||"")}</div>
          </div>
        `;
      }).join("");
    }

    function renderHistory(){
      const host=document.getElementById("historyList");
      const items=loadHistory();
      if(!items.length){ host.innerHTML=`<div class="muted">No history yet.</div>`; return; }
      host.innerHTML = items.slice(0,50).map(h=>{
        const dt=new Date(h.createdAt).toLocaleString();
        return `
          <div class="post">
            <div class="postTop">
              <div>
                <div style="font-weight:950">${esc(h.title||"Workout")}</div>
                <div class="muted2">${esc(dt)}</div>
              </div>
              <div class="tag">${esc(h.type||"")}</div>
            </div>
          </div>
        `;
      }).join("");
    }
    function clearHistory(){
      if(!confirm("Clear history?")) return;
      localStorage.removeItem(LS_HISTORY);
      renderHistory(); renderHomeHeader();
      notify("History cleared");
    }

    /* =========
      Recipes
    ========= */
    function addRecipe(){
      const name=document.getElementById("rName").value.trim();
      if(!name) return alert("Recipe name required");
      const type=document.getElementById("rType").value;
      const cals=document.getElementById("rCals").value.trim();
      const prot=document.getElementById("rProt").value.trim();
      const ingr=document.getElementById("rIngr").value.trim();
      const steps=document.getElementById("rSteps").value.trim();

      const items=loadRecipes();
      items.unshift({
        id:"r_"+Date.now(),
        createdAt:new Date().toISOString(),
        author:profile.name,
        name,type,cals,protein:prot,ingr,steps,
        likes:0, liked:false
      });
      saveRecipes(items);
      document.getElementById("rName").value="";
      document.getElementById("rCals").value="";
      document.getElementById("rProt").value="";
      document.getElementById("rIngr").value="";
      document.getElementById("rSteps").value="";
      renderRecipes();
      notify("Recipe posted");
    }
    function toggleRecipeLike(id){
      const items=loadRecipes();
      const r=items.find(x=>x.id===id);
      if(!r) return;
      r.liked=!r.liked;
      r.likes=Math.max(0,(r.likes||0)+(r.liked?1:-1));
      saveRecipes(items);
      renderRecipes();
      notify(r.liked?"Liked recipe":"Unliked recipe");
    }
    function renderRecipes(){
      const host=document.getElementById("recipeList");
      const items=loadRecipes();
      if(!items.length){ host.innerHTML=`<div class="muted">No recipes yet.</div>`; return; }
      host.innerHTML = items.slice(0,30).map(r=>{
        const dt=new Date(r.createdAt).toLocaleString();
        return `
          <div class="post">
            <div class="postTop">
              <div class="userRow">
                <div class="avatar">${esc((r.author||"K")[0])}</div>
                <div>
                  <div style="font-weight:950">${esc(r.author||"KryptaUser")}</div>
                  <div class="muted2">${esc(dt)}</div>
                </div>
              </div>
              <div class="tag">Recipe</div>
            </div>
            <div style="margin-top:10px; font-weight:950">${esc(r.name)}</div>
            <div style="margin-top:6px" class="row">
              ${r.cals?`<span class="tag">${esc(r.cals)} kcal</span>`:""}
              ${r.protein?`<span class="tag">${esc(r.protein)}g protein</span>`:""}
              <span class="tag">${esc(r.type||"")}</span>
            </div>
            <div class="muted" style="margin-top:10px">
              <b style="color:rgba(245,247,255,.92)">Ingredients:</b> ${esc(r.ingr||"‚Äî")}
            </div>
            <div class="muted" style="margin-top:8px">
              <b style="color:rgba(245,247,255,.92)">Steps:</b> ${esc(r.steps||"‚Äî")}
            </div>
            <div class="btnRow">
              <button class="smallBtn ${r.liked?'active':''}" onclick="toggleRecipeLike('${r.id}')">‚ù§Ô∏è Like (${r.likes||0})</button>
            </div>
          </div>
        `;
      }).join("");
    }

    /* =========
      Notifications
    ========= */
    function notify(text){
      const items=loadNotifs();
      items.unshift({id:"n_"+Date.now(), ts:Date.now(), text, read:false});
      if(items.length>80) items.length=80;
      saveNotifs(items);
      updateNotifBadge();
    }
    function updateNotifBadge(){
      const items=loadNotifs();
      const unread=items.reduce((a,n)=>a+(n.read?0:1),0);
      const c=document.getElementById("notifCount");
      if(unread>0){ c.style.display="inline"; c.textContent=String(unread>99?"99+":unread); }
      else c.style.display="none";
    }
    function openNotif(){
      const modal=document.getElementById("notifModal");
      const list=document.getElementById("notifList");
      const items=loadNotifs();
      if(!items.length){ list.innerHTML=`<div class="muted">No notifications yet.</div>`; }
      else{
        list.innerHTML = items.map(n=>`
          <div class="post" style="opacity:${n.read?0.65:1}">
            <div style="font-weight:900">${esc(n.text)}</div>
            <div class="muted2">${esc(new Date(n.ts).toLocaleString())}</div>
          </div>
        `).join("");
      }
      // mark all read
      items.forEach(n=>n.read=true);
      saveNotifs(items);
      updateNotifBadge();
      modal.style.display="block";
    }
    function closeNotif(){ document.getElementById("notifModal").style.display="none"; }

    document.getElementById("notifBtn").addEventListener("click",(e)=>{ e.stopPropagation(); openNotif(); });
    document.getElementById("notifModal").addEventListener("click",(e)=>{ if(e.target.id==="notifModal") closeNotif(); });

    /* =========
      Create mode
    ========= */
    function setCreateMode(m){
      createMode=m;
      document.getElementById("createModeTag").textContent = m==="gym"?"Gym":(m==="wod"?"WOD":"Cardio");
      document.getElementById("gymCard").style.display = m==="gym"?"block":"none";
      document.getElementById("wodCard").style.display = m==="wod"?"block":"none";
      document.getElementById("cardioCard").style.display = m==="cardio"?"block":"none";

      document.getElementById("btnModeGym").classList.toggle("active", m==="gym");
      document.getElementById("btnModeWOD").classList.toggle("active", m==="wod");
      document.getElementById("btnModeCardio").classList.toggle("active", m==="cardio");
    }

    /* =========
      Profile
    ========= */
    function fillProfileUI(){
      document.getElementById("pName").value=profile.name||"";
      document.getElementById("pGender").value=profile.gender||"male";
      document.getElementById("pHeight").value=profile.height||180;
      document.getElementById("pWeight").value=profile.weight||80;
      document.getElementById("pAge").value=profile.age||20;
      document.getElementById("pDays").value=String(profile.days||4);
    }
    function saveProfile(){
      profile={
        name: document.getElementById("pName").value.trim() || "KryptaUser",
        gender: document.getElementById("pGender").value,
        height: Number(document.getElementById("pHeight").value)||180,
        weight: Number(document.getElementById("pWeight").value)||80,
        age: Number(document.getElementById("pAge").value)||20,
        days: Number(document.getElementById("pDays").value)||4
      };
      saveProfileLS();
      renderHomeHeader();
      renderPlan();
      notify("Profile saved");
      go("home");
    }

    function resetAll(){
      if(!confirm("Reset EVERYTHING (local)?")) return;
      localStorage.removeItem(LS_PROFILE);
      localStorage.removeItem(LS_FEED);
      localStorage.removeItem(LS_HISTORY);
      localStorage.removeItem(LS_PLAN);
      localStorage.removeItem(LS_RECIPES);
      localStorage.removeItem(LS_NOTIFS);
      localStorage.removeItem(LS_ONB);
      location.reload();
    }

    /* =========
      Onboarding (first-time)
    ========= */
    let onbStep=0;
    function hasOnb(){ return localStorage.getItem(LS_ONB)==="1"; }
    function setOnbDone(){ localStorage.setItem(LS_ONB,"1"); }

    function onbShow(){
      document.getElementById("onb").style.display="flex";
      renderOnb();
    }
    function onbHide(){ document.getElementById("onb").style.display="none"; }

    function renderOnb(){
      const body=document.getElementById("onbBody");
      const title=document.getElementById("onbStepTitle");

      const steps=[
        {
          t:"Create your account",
          html:`
            <div class="muted2">Email</div>
            <input id="onbEmail" placeholder="you@email.com"/>
            <div class="spacer"></div>
            <div class="muted2">Username</div>
            <input id="onbUser" placeholder="krypta_user"/>
          `
        },
        {
          t:"Basics",
          html:`
            <div class="two">
              <div><div class="muted2">Gender</div>
                <select id="onbGender">
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div><div class="muted2">Gym days / week</div>
                <select id="onbDays">
                  <option value="3">3</option>
                  <option value="4" selected>4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
              </div>
            </div>
            <div class="spacer"></div>
            <div class="two">
              <div><div class="muted2">Height (cm)</div><input id="onbHeight" type="number" value="180"/></div>
              <div><div class="muted2">Weight (kg)</div><input id="onbWeight" type="number" value="80"/></div>
            </div>
          `
        },
        {
          t:"Goal",
          html:`
            <div class="muted2">What is your goal? <span class="muted">(can be changed anytime)</span></div>
            <div class="spacer"></div>
            <select id="onbGoal">
              <option value="muscle">Build muscle</option>
              <option value="strong">Get strong</option>
              <option value="cut">Cut</option>
              <option value="sixpack">Sixpack</option>
            </select>
          `
        }
      ];

      title.textContent=steps[onbStep].t;
      body.innerHTML = steps[onbStep].html + `
        <div class="onbActions">
          <button class="btn" ${onbStep===0?'disabled':''} onclick="onbPrev()">Back</button>
          <button class="btn primary" onclick="onbNext()">${onbStep===steps.length-1?'Finish':'Next'}</button>
        </div>
      `;
    }

    function onbPrev(){ onbStep=Math.max(0,onbStep-1); renderOnb(); }
    function onbNext(){
      if(onbStep===0){
        const u=(document.getElementById("onbUser").value||"").trim();
        if(u) profile.name=u;
      }
      if(onbStep===1){
        profile.gender=document.getElementById("onbGender").value;
        profile.days=Number(document.getElementById("onbDays").value)||4;
        profile.height=Number(document.getElementById("onbHeight").value)||180;
        profile.weight=Number(document.getElementById("onbWeight").value)||80;
      }
      if(onbStep===2){
        // store goal in todayGoal default
        const g=document.getElementById("onbGoal").value || "muscle";
        // also set selector if exists
        setTimeout(()=>{ const sel=document.getElementById("todayGoal"); if(sel) sel.value=g; },0);
      }

      saveProfileLS();

      onbStep++;
      if(onbStep>=3){
        setOnbDone();
        onbHide();
        init();
        return;
      }
      renderOnb();
    }
    /* =========
      Init
    ========= */
    function init(){
      // profile
      profile = loadProfile() || profile;
      saveProfileLS();
      fillProfileUI();

      // picker
      wirePicker();
      setView("front");
      syncSvg(); renderPills();

      // plan/feed/recipes/history
      renderPlan();
      renderFeed();
      renderRecipes();
      renderHistory();
      renderHomeHeader();

      // notif badge
      updateNotifBadge();

      // create default mode
      setCreateMode("gym");
    }

    // close exercise modal by clicking outside
    document.getElementById("exModal").addEventListener("click",(e)=>{
      if(e.target && e.target.id==="exModal") closeExercise();
    });

    // ESC closes modals
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape"){
        closeExercise();
        closeNotif();
      }
    });

    // Start
    window.addEventListener("load", ()=>{
      if(!hasOnb()) onbShow();
      else init();
    });
  </script>
</body>
</html>
